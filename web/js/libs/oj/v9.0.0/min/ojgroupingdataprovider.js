/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore","jquery","knockout","ojs/ojarraytreedataprovider","ojs/ojarraydataprovider","ojs/ojeventtarget","ojs/ojtreedataprovider"],function(e,t,s,r){class i{constructor(e,t,s,r){this.dataProvider=e,this.sortComparator=t,this.sectionRenderer=s,this.options=r,this._getKeyAttribute=function(){var e=null!=this.options?this.options.keyAttributes:null;return e||(e="id"),e},this.GroupAsyncIterator=class{constructor(e,t,s,r){this._parent=e,this._baseIterable=t,this._dataprovider=s,this._params=r}next(){let e=this,t=0;e._parent._currentRootSection&&(t=Object.keys(e._parent._sections).indexOf(e._parent._currentRootSection));let s=e._parent._currentBaseOffset<t;return this._parent._getDataFromDataProvider(this._params,"root",s).then(function(){e._parent._updateSectionIndex();let t=new e._parent.FetchByOffsetParameters(e._parent,e._parent._currentBaseOffset,e._params.size,e._params.sortCriteria,e._params.filterCriterion);return e._dataprovider.fetchByOffset(t).then(function(t){let s=t.results,r=s.map(function(e){return e.data}),i=s.map(function(e){return e.metadata});for(let t=0;t<i.length;t++)i[t]=e._parent._getNodeMetadata(s[t].data),r[t]=e._parent.sectionRenderer(i[t].key);return e._parent._currentBaseOffset=e._parent._currentBaseOffset+r.length,t.done&&e._parent._dataFetchComplete?Promise.resolve(new e._parent.AsyncIteratorReturnResult(e._parent,new e._parent.FetchListResult(e._parent,e._params,r,i))):Promise.resolve(new e._parent.AsyncIteratorYieldResult(e._parent,new e._parent.FetchListResult(e._parent,e._params,r,i)))})})}},this.TreeAsyncIterator=class{constructor(e,t,s,r,i){this._parent=e,this._isParentSection=t,this._parentKey=s,this._dataprovider=r,this._params=i}next(){let e=this;return this._parent._registerIteratorOffset(e,e._parentKey,!1),this._parent._getDataFromDataProvider(this._params,this._parentKey,!1).then(function(t){void 0===t&&e._parent._updateSectionIndex();let s=e._parent._getIteratorOffset(e),r=new e._parent.FetchByOffsetParameters(e._parent,s,e._params.size,e._params.sortCriteria,e._params.filterCriterion);return e._dataprovider.fetchByOffset(r).then(function(t){let r=t.results,i=r.map(function(e){return e.data}),n=r.map(function(e){return e.metadata});if(e._isParentSection)for(let t=0;t<n.length;t++)n[t]=e._parent._getNodeMetadata(r[t].data),i[t]=e._parent.sectionRenderer(n[t].key);return e._parent._updateIteratorOffset(e,s+i.length),t.done?(e._parent._unregisterIteratorOffset(e),Promise.resolve(new e._parent.AsyncIteratorReturnResult(e._parent,new e._parent.FetchListResult(e._parent,e._params,i,n)))):Promise.resolve(new e._parent.AsyncIteratorYieldResult(e._parent,new e._parent.FetchListResult(e._parent,e._params,i,n)))})})}},this.TreeAsyncIterable=class{constructor(e,t){this._parent=e,this._asyncIterator=t,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}},this.FetchListParameters=class{constructor(e,t,s,r){this._parent=e,this.size=t,this.sortCriteria=s,this.attributes=r,this.size=t,this.sortCriteria=s,this.attributes=r}},this.FetchByOffsetParameters=class{constructor(e,t,s,r,i){this._parent=e,this.offset=t,this.size=s,this.sortCriteria=r,this.filterCriterion=i,this.size=s,this.sortCriteria=r,this.offset=t,this.filterCriterion=i}},this.FetchListResult=class{constructor(e,t,s,r){this._parent=e,this.fetchParameters=t,this.data=s,this.metadata=r,this.fetchParameters=t,this.data=s,this.metadata=r}},this.AsyncIteratorYieldResult=class{constructor(e,t){this._parent=e,this.value=t,this.value=t,this.done=!1}},this.AsyncIteratorReturnResult=class{constructor(e,t){this._parent=e,this.value=t,this.value=t,this.done=!0}},this._dataProvider=e,this._addEventListeners(this._dataProvider),this._initialize()}containsKeys(e){return this.fetchByKeys(e).then(function(t){let s=new Set;return e.keys.forEach(function(e){null!=t.results.get(e)&&s.add(e)}),Promise.resolve({containsParameters:e,results:s})})}getCapability(e){return"filter"===e?null:this._baseDataProvider.getCapability(e)}getTotalSize(){return this._baseDataProvider.getTotalSize()}isEmpty(){return this._baseDataProvider.isEmpty()}getChildDataProvider(s){let r=this,i=this._getChildren(s),n=this._isParentSection(s);function a(t,s){this._parentKey=s.parentKey,this._isParentSection=s.isParentSection,this._isParentSection?(this._baseDataProvider=new e.ArrayDataProvider(t.childData,{}),this._baseTreeDataProvider=new e.ArrayTreeDataProvider(t.childData,{keyAttributes:s.keyAttributes})):(this._baseDataProvider=new e.ArrayDataProvider(t.children,{keyAttributes:s.keyAttributes}),this._baseTreeDataProvider=new e.ArrayTreeDataProvider(t.children,{keyAttributes:s.keyAttributes}))}return a.prototype.containsKeys=function(e){return this._baseTreeDataProvider.containsKeys(e)},a.prototype.getCapability=function(e){return this._baseTreeDataProvider.getCapability(e)},a.prototype.getTotalSize=function(){return this._baseTreeDataProvider.getTotalSize()},a.prototype.isEmpty=function(){return this._baseTreeDataProvider.isEmpty()},a.prototype.fetchByOffset=function(e){return this._baseTreeDataProvider.fetchByOffset(e)},a.prototype.fetchByKeys=function(e){return this._baseTreeDataProvider.fetchByKeys(e)},a.prototype.getChildDataProvider=function(e){return r.getChildDataProvider(e)},a.prototype.fetchFirst=function(e){e&&e.filterCriterion&&((e=t.extend({},e)).filterCriterion=null);let s=this._baseDataProvider,i=this._isParentSection,n=this._parentKey;return new r.TreeAsyncIterable(r,new r.TreeAsyncIterator(r,i,n,s,e))},a.prototype._getId=function(e){return r._getId(e)},i?new a(this._sections[s],{keyAttributes:this._getKeyAttribute(),parentKey:s,isParentSection:n}):null}fetchFirst(e){e&&e.filterCriterion&&((e=t.extend({},e)).filterCriterion=null);let s=this._baseDataProvider.fetchFirst(e);return this._initializeTreeCache(),new this.TreeAsyncIterable(this,new this.GroupAsyncIterator(this,s,this._baseDataProvider,e))}fetchByOffset(e){let t=this._baseDataProvider.fetchByOffset(e),s=this;return t.then(function(e){let t=e.results,r=[];for(let e=0;e<t.length;e++){let i=t[e].metadata,n=t[e].data;i=s._getNodeMetadata(n),r.push({data:n,metadata:i})}return{done:e.done,fetchParameters:e.fetchParameters,results:r}})}fetchByKeys(e){let t=this,s=new Map;return e.keys.forEach(function(e){let r=t._getNodeForKey(e);r&&s.set(e,{metadata:{key:e},data:r})}),Promise.resolve({fetchParameters:e,results:s})}_getChildren(e){return this._sections[e]?this._sections[e].children:null}_isParentSection(e){if(e in this._sections){let t=this._sections[e];if(t&&t.children().length>0&&this._sections[t.children()[0]])return!0}return!1}_initialize(){this._mapKeyToNode=new Map,this._mapNodeToKey=new Map,this._mapArrayToSequenceNum=new Map,this._sections={},this._sectionRoots=s.observableArray(),this._sectionRootData=s.observableArray(),this._dataFetchComplete=!1,this._internalIterator=null,this.treeData=new s.observableArray([]),this._initializeTreeCache(),this._createSections(),this._storedAddSection=[],this._storedAddSectionKeys=[],this._storedRemoveSection=[],this._baseDataProvider=null,this._processSectionsArray([])}_initializeTreeCache(){this._treeKeyMap=[],this._treeMetadata=[],this._treeData=[],this._currentFirstSection=null,this._currentSectionKey=null,this._currentRootSection=null,this._currentSectionData=[],this._currentOffset=0,this._currentBaseOffset=0,this._iteratorOffsets=new Map,this._dataFetchComplete=!1,this._internalIterator=null}_registerIteratorOffset(e,t,s){this._iteratorOffsets.set(e,{parentKey:t,offset:s})}_getIteratorOffset(e){return this._iteratorOffsets.get(e)}_updateIteratorOffset(e,t){let s=this._iteratorOffsets.get(e);s.offset=t,this._iteratorOffsets.set(e,s)}_unregisterIteratorOffset(e){this._iteratorOffsets.delete(e)}_getRootDataProvider(){return this}_getDataFromDataProvider(e,t,s){let r=this;if(!this._inCurrentFetchingSection(t)||s)return Promise.resolve(!0);r._internalIterator||(r._internalIterator=this._dataProvider.fetchFirst(e)[Symbol.asyncIterator]());let i=function(){return r._internalIterator.next().then(function(e){if(r._treeData=r._treeData.concat(e.value.data),r._treeMetadata=r._treeMetadata.concat(e.value.metadata),e.value.metadata.forEach(function(e){r._treeKeyMap.push(e.key)}),e.done&&(r._dataFetchComplete=!0),!e.done&&e.value.data.length!=e.value.fetchParameters.size)return i()})};return i()}_inCurrentFetchingSection(e){return"root"===e||this._currentSectionKey==e}_processSectionsArray(t){let s=this;this.treeData().forEach(function(e,r){s._processNode(e,t,this.treeData())}),this._baseDataProvider||(this._baseDataProvider=new e.ArrayDataProvider(this.treeData,null))}_processTreeArray(e,t){let s,r=this;(s=e instanceof Array?e:e()).forEach(function(s,i){r._processNode(s,t,e)})}_processNode(e,t,s){let r=this,i=r._createKeyObj(e,t,s);r._setMapEntry(i.key,e);let n=r._getChildren(e);return n&&r._processTreeArray(n,i.keyPath),i}_createSections(){let e=this;if(this.options&&this.options.groupByStrategy)"function"==typeof this.options.groupByStrategy?this._groupingFunction=this.options.groupByStrategy:"string"==typeof this.options.groupByStrategy&&(this._groupingFunction=function(t){return e._getVal(t,e.options.groupByStrategy)});else{let e=[],t=new Date(Date.now());e.push(t);let s=new Date(Date.now()),r=s.setDate(t.getDate()-1),i=s.setDate(t.getDate()-7);e.push(r),e.push(i);let n=(s=new Date(Date.now())).setMonth(t.getMonth()-1);e.push(n);let a=(s=new Date(Date.now())).setFullYear(t.getFullYear()-1);e.push(a),this._groupingFunction=function(t){let s=["In the past day","In the past week","In the past month","In the past year","Earlier"];if(t&&t.date){let r=new Date(t.date),i=1;for(;r<e[i]&&5!=i;)i++;return[s[i-1]]}return["Section 1"]}}this.treeData&&this.treeData.valueHasMutated()}_getSectionKeyFromArray(e){if(e){if(Array.isArray(e)&&e.length>0)return e[e.length-1];if("string"==typeof e)return e}return null}_createNewSection(t,r,i,n,a){let o,h,c=this,l=i.indexOf(t),_=null;0!=l&&(_=i[l-1]);let d=null,u=null,p=l==this._getDepth(i),f=!1;p&&(d=n,u=a),null!=_?(_ in this._sections&&this._sections[_].active||(this._createNewSection(_,r,i,n,a),r&&(r=!1)),o=this._sections[_].children,h=this._sections[_].childData):(o=this._sectionRoots,h=this._sectionRootData,f=!0);let y=null;if(null==a)if(null==n)o().length>0&&(n=o()[o().length-1],p&&(d=n)),o.push(t),h.push(c.sectionRenderer(t));else{for(y=this._sections[n];y.depth>l;)y=this._sections[this._sections[n].parent];if(y.depth==l){n=y.key;let e=o.indexOf(n);e>=0?(o.splice(e+1,0,t),h.splice(e+1,0,c.sectionRenderer(t))):(o.push(t),h.push(c.sectionRenderer(t))),a=y.next}else n=null,a=null,o.push(t),h.push(c.sectionRenderer(t))}else{let e=this._sections[a];for(;e.depth>l;)e=this._sections[this._sections[a].parent];if(e.depth==l){a=e.key;let s=o.indexOf(a);s>=0?(o.splice(s,0,t),h.splice(s,0,c.sectionRenderer(t))):(o.push(t),h.push(c.sectionRenderer(t))),n=e.previous}else n=null,a=null,o.push(t),h.push(c.sectionRenderer(t))}t in this._sections?(this._sections[t].active=!0,this._sections[t].previous=n,this._sections[t].next=a,this._sections[t].previousLeaf=d,this._sections[t].nextLeaf=u,this._sections[t].parent=_):this._sections[t]={parent:_,key:t,children:s.observableArray([]),childData:s.observableArray([]),previous:n,next:a,previousLeaf:d,nextLeaf:u,depth:l,active:!0,index:function(){return null!=this.parent?c._sections[this.parent].children.indexOf(this.key):c._sectionRoots.indexOf(this.key)},cutoffIndex:function(){return c._getCutoffIndex(c._sections[this.key].previousLeaf)+c._sections[this.key].children().length}},null!=n&&(this._sections[n].next=t),null!=a&&(this._sections[a].previous=t),l==this._getDepth(i)&&(null!=d&&(this._sections[d].nextLeaf=t),null!=u&&(this._sections[u].previousLeaf=t)),l!=this._getDepth(i)||a!=this._currentFirstSection&&null!=this._currentFirstSection||(this._currentFirstSection=t);let g=null;null!=a&&(g=[a]);let v=c.sectionRenderer(t);if(this._processNode(v,[],this.treeData),r&&-1==this._storedAddSectionKeys.indexOf(this._sections[t].parent)){let s=t,r={key:t},i=this._sections[t].index(),n={data:[v],indexes:[i],keys:new Set([s]),metadata:[r],addBeforeKeys:g,parentKeys:[_]},a=new e.DataProviderMutationEvent({add:n,remove:null,update:null});if(this._storedAddSection.push(a),this._storedAddSectionKeys.push(t),!this._dataFetchComplete&&f&&this._currentBaseOffset>i&&this._currentBaseOffset++,!this._dataFetchComplete)for(let[e,t]of this._internalIterator)t.parentKey===_&&t.offset>i&&t.offset++,this._updateIteratorOffset(e,t.offset)}this.treeData.valueHasMutated()}_removeSection(t){let s=this._sections[t],r=s.parent,i=s.previous,n=s.next,a=s.previousLeaf,o=s.nextLeaf,h=!0;if(this._sections[n]&&this._sections[n].previous==t&&(this._sections[n].previous=s.previous),this._sections[i]&&this._sections[i].next==t&&(this._sections[i].next=s.next),this._sections[o]&&this._sections[o].previousLeaf==t&&(this._sections[o].previousLeaf=s.previousLeaf),this._sections[a]&&this._sections[a].nextLeaf==t&&(this._sections[a].nextLeaf=s.nextLeaf),this._sections[r]&&-1!=this._sections[r].children.indexOf(t)){let e=this._sections[r].children.indexOf(t);if(!this._dataFetchComplete)for(let[t,s]of this._internalIterator)s.parentKey===r&&s.offset>e&&s.offset--,this._updateIteratorOffset(t,s.offset);this._sections[r].children.splice(e,1),this._sections[r].childData.splice(e,1),0===this._sections[r].children().length&&(this._removeSection(r),h&&(h=!1))}if(this._sections[t].active=!1,this._sections[t].children([]),this._sections[t].childData([]),null==this._sections[t].parent){let e=this._sectionRoots.indexOf(t);this._sectionRoots.splice(e,1),this._sectionRootData.splice(e,1),!this._dataFetchComplete&&this._currentBaseOffset>e&&this._currentBaseOffset--}if(t==this._currentFirstSection&&(this._currentFirstSection=n),h){let s={key:t},r={data:[this.sectionRenderer(t)],indexes:null,keys:new Set([t]),metadata:[s]},i=new e.DataProviderMutationEvent({add:null,remove:r,update:null});this._storedRemoveSection.push(i)}this.treeData.valueHasMutated()}_updateSectionIndex(){let e=this;for(let t=this._currentOffset;t<this._treeData.length;t++){let s=this._treeData[t],r=e._groupingFunction(s),i=e._getSectionKeyFromArray(r);null==this._currentSectionKey&&(i in this._sections||e._createNewSection(i,!1,r,this._currentSectionKey,null),this._currentSectionKey=i,this._currentRootSection=this._getSectionArray(r)[0]),i===this._currentSectionKey?this._currentSectionData.push(s):(i in this._sections&&this._sections[i].active||e._createNewSection(i,!1,r,this._currentSectionKey,null),this._sections[this._currentSectionKey].children(this._currentSectionData),this._sections[this._currentSectionKey].childData(this._getChildDataFromChildren(this._currentSectionKey)),this._currentSectionKey=i,this._currentRootSection=this._getSectionArray(r)[0],this._currentSectionData=[s]),this._currentOffset++}this._currentSectionData.length>0&&(this._sections[this._currentSectionKey].children(this._currentSectionData),this._sections[this._currentSectionKey].childData(this._getChildDataFromChildren(this._currentSectionKey)));let t=[];for(let e in this._sections)null==this._sections[e].parent&&t.push(this.sectionRenderer(e));this.treeData(t),this.treeData.valueHasMutated()}_getSectionArray(e){return Array.isArray(e)?e:[e]}_getChildDataFromChildren(e){let t=this,s=[];return this._sections[e].children().forEach(function(e){s.push(t.sectionRenderer(e))}),s}_createKeyObj(e,t,s){let r=this._getId(e),i=t?t.slice():[];return null==r?(i.push(this._incrementSequenceNum(s)),r=i):(i.push(r),this.options&&"siblings"==this.options.keyAttributesScope&&(r=i)),{key:r,keyPath:i}}_getId(e){let t,s=null!=this.options?this.options.keyAttributes:null;if(s||(s="id"),null!=s){if(Array.isArray(s)){let r;for(t=[],r=0;r<s.length;r++)t[r]=this._getVal(e,s[r])}else t="@value"==s?this._getAllVals(e):this._getVal(e,s);return t}return null}_getDepth(e){return Array.isArray(e)?e.length-1:0}_getVal(e,t,s){if("string"==typeof t){let s=t.indexOf(".");if(s>0){let r=t.substring(0,s),i=t.substring(s+1),n=e[r];if(n)return this._getVal(n,i)}}return!0!==s&&"function"==typeof e[t]?e[t]():e[t]}_getAllVals(e){let t=this;return Object.keys(e).map(function(s){return t._getVal(e,s)})}_getNodeMetadata(e){let t=this._getKeyForNode(e);return t||(t=this._getId(e)),{key:t}}_getNodeForKey(e){return this._getRootDataProvider()._mapKeyToNode.get(JSON.stringify(e))}_getKeyForNode(e){return this._getRootDataProvider()._mapNodeToKey.get(e)}_setMapEntry(e,t){let s=this._getRootDataProvider();s._mapKeyToNode.set(JSON.stringify(e),t),s._mapNodeToKey.set(t,e)}_incrementSequenceNum(e){let t=this._getRootDataProvider(),s=t._mapArrayToSequenceNum.get(e)||0;return t._mapArrayToSequenceNum.set(e,s+1),s}_addData(e){let t=this,s=e.data,r=e.metadata,i=e.addBeforeKeys,n=e.indexes,a=[];if(e.keys.forEach(function(e){a.push(e)}),null!=n&&n.length>0){let e=n.slice(0).sort();for(let i=0;i<e.length;i++){let o=e[i],h=n.indexOf(o);t._treeData.splice(o,0,s[h]),t._treeMetadata.splice(o,0,r[h]),t._treeKeyMap.splice(o,0,a[h])}if(null==i||0==i.length){i=[];for(let e=0;e<n.length;e++){let s=n[e]+1<t._treeKeyMap.length?t._treeKeyMap[n[e]+1]:null;i.push(s)}}}else if(null!=i&&i.length>0){let e=a.slice(0),n=r.slice(0),o=s.slice(0),h=i.slice(0);for(;h.length>0;){let s=h[0],r=e[0],i=n[0],a=o[0],c=t._treeKeyMap.indexOf(s);-1!=c?(t._treeData.splice(c,0,a),t._treeMetadata.splice(c,0,i),t._treeKeyMap.splice(c,0,r)):(e.push(r),n.push(i),o.push(a),h.push(s)),e.splice(0,1),h.splice(0,1),n.splice(0,1),o.splice(0,1)}}else{let e=[],n=[],o=[],h=0,c=!1;s.forEach(function(s,i){if(c=!1,0!=e.length)for(;h<e.length&&!c;)t.sortComparator(s,e[h])?(e.splice(h,0,s),n.splice(h,0,r[i]),o.splice(h,0,a[i]),c=!0):h++;c||(e.push(s),n.push(r[i]),o.push(a[i]))}),h=t._treeData.length-1;let l={};e.forEach(function(e,s){let r=e,i=n[s],a=o[s];for(c=!1;h>=0&&!c;)t.sortComparator(r,t._treeData[h])?(h+1!=t._treeData.length?(t._treeData.splice(h+1,0,r),t._treeMetadata.splice(h+1,0,i),l[t._getId(r)]=t._treeKeyMap[h+1],t._treeKeyMap.splice(h+1,0,a)):(t._treeData.push(r),t._treeMetadata.push(i),l[t._getId(r)]=null,t._treeKeyMap.push(a)),c=!0):h--;c||(t._treeData.splice(0,0,r),t._treeMetadata.splice(0,0,i),l[t._getId(r)]=t._treeKeyMap[0],t._treeKeyMap.splice(0,0,a),h=0)}),i=[],s.forEach(function(e){i.push(l[t._getId(e)])})}return i}_handleAdd(e){let t=this,s=[],r=t._addData(e);e.addBeforeKeys&&0!=e.addBeforeKeys.length||(e.addBeforeKeys=r),e.keys.forEach(function(t){let i=s.length,n=e.data[i],a=r[i];s.push({addBeforeKey:a,key:t,data:n})});let i=[],n=[],a=[],o=this._getIndexFromKeys(e.keys);if(e.indexes&&0!=e.indexes.length||(e.indexes=[]),e.data.forEach(function(s,r){let h,c,l=t._groupingFunction(s),_=t._getSectionKeyFromArray(l);_ in t._sections&&t._sections[_].active?-1===n.indexOf(_)&&a.push(r):(0!=o[r]?(h=t._getSectionKeyFromArray(t._groupingFunction(t._treeData[o[r]-1])),c=t._sections[h].nextLeaf):h=null,o[r]+1<t._treeData.length&&null==h&&(c=t._currentFirstSection),t._createNewSection(_,!0,l,h,c),_=t._getSectionKeyFromArray(l),n.push(_));let d=t._sections[_].children,u=t._sections[_].childData,p=0;if(null!=(h=t._sections[_].previousLeaf)&&(p=t._sections[h].cutoffIndex()),d.splice(o[r]-p,0,s),u.splice(o[r]-p,0,t.sectionRenderer(s)),i.push(_),e.indexes[r]=o[r]-p,null!=e.addBeforeKeys[r]&&r==e.data.length-1){t._getSectionKeyFromArray(t._groupingFunction(t._treeData[t._treeKeyMap.indexOf(e.addBeforeKeys[r])]))!=_&&(e.addBeforeKeys[r]=null)}}),e.parentKeys=i,n.length>0){let t=0,s=[],r=[],i=[],n=[],o=[],h=[];e.keys.forEach(function(c){-1!=a.indexOf(t)&&(r.push(c),s.push(e.data[t]),i.push(e.metadata[t]),n.push(e.parentKeys[t]),o.push(e.indexes[t]),h.push(e.addBeforeKeys[t])),t++}),e=r.length>0?{data:s,keys:new Set(r),metadata:i,parentKeys:n,indexes:o,addBeforeKeys:h}:null}return e}_handleRemove(e){let t=this,s=this._getIndexFromKeys(e.keys);this._removeKeys(e.keys);let r=[],i=[];for(var n=0;n<s.length;n++){let e=s[n],a=t._treeData[e],o=t._getSectionKeyFromArray(t._groupingFunction(a)),h=t._sections[o].previousLeaf,c=0;null!=h&&(c=t._sections[h].cutoffIndex()),r.push({ind:e-c,sectionId:o}),i.push(e)}r.sort(function(e,t){return t.ind-e.ind}),i.sort(function(e,t){return t-e});for(let e=0;e<r.length;e++){let s=r[e].sectionId,n=t._sections[s].children;n.splice(r[e].ind,1),0===n().length&&this._removeSection(s),t._treeData.splice(i[e],1),t._treeMetadata.splice(i[e],1)}}_handleUpdate(e){let t=this,s=this._getIndexFromKeys(e.keys);e.data.forEach(function(e,r){let i=s[r],n=t._treeData[i],a=t._getSectionKeyFromArray(t._groupingFunction(n)),o=t._sections[a].children,h=t._sections[a].previousLeaf,c=0;null!=h&&(c=t._sections[h].cutoffIndex()),o.splice(i-c,1,e),t._treeData[i]=e})}_getCutoffIndex(e){return null!=e?this._sections[e].cutoffIndex():0}_getIndexFromKeys(e){let t=this,s=[];return e.forEach(function(e){s.push(t._treeKeyMap.indexOf(e))}),s}_removeKeys(e){let t=this;e.forEach(function(e){t._treeKeyMap.splice(t._treeKeyMap.indexOf(e),1)})}_cleanEvent(e){let t=this._getIndexFromKeys(e.keys),s=0;e.keys.forEach(function(r){-1==t[s]&&e.keys.delete(r),s++});for(var r=t.length-1;r>=0;r--)-1==t[r]&&(e.data&&e.data.splice(r,1),e.indexes&&e.indexes.splice(r,1),e.metadata&&e.metadata.splice(r,1));return e}_cleanAddEvent(e){let t=this,s=e.addBeforeKeys,r=e.indexes,i=[],n=[];if(e.keys.forEach(function(e){i.push(e)}),null!=r){let e=r.slice(0).sort();for(let s=0;s<e.length;s++){let i=e[s],a=r.indexOf(i);t._treeData.length+s-n.length<i&&n.push(a)}}else if(null!=s){let e=s.slice(0).sort();for(let r=0;r<e.length;r++){let a=e[r],o=s.indexOf(a);-1==t._treeKeyMap.indexOf(a)&&-1==i.indexOf(a)?n.push(o):-1==t._treeKeyMap.indexOf(a)&&-1!=i.indexOf(a)&&-1==n.indexOf(i.indexOf(a))&&n.push(o)}}let a=0;e.keys.forEach(function(t){-1!=n.indexOf(a)&&e.keys.delete(t),a++});let o=n.splice(0).sort();for(var h=o.length-1;h>=0;h--)e.data&&e.data.splice(o[h],1),e.indexes&&e.indexes.splice(o[h],1),e.metadata&&e.metadata.splice(o[h],1),e.parentKeys&&e.parentKeys.splice(o[h],1),e.addBeforeKeys&&e.addBeforeKeys.splice(o[h],1);return e}_addEventListeners(t){let s=this;t.addEventListener("refresh",function(t){s._initialize(),s.dispatchEvent(new e.DataProviderRefreshEvent)}),t.addEventListener("mutate",function(e){e.detail.add&&(e.detail.add=s._cleanAddEvent(e.detail.add),0!=e.detail.add.keys.size&&(e.detail.add=s._handleAdd(e.detail.add),s._storedAddSection.forEach(function(e){s.dispatchEvent(e)}),e.detail.add&&s.dispatchEvent(e),s._storedAddSection=[],s._storedAddSectionKeys=[])),(e.detail.remove||e.detail.update)&&(e.detail.remove&&(e.detail.remove=s._cleanEvent(e.detail.remove),0!=e.detail.remove.keys.size&&(s._handleRemove(e.detail.remove),s.dispatchEvent(e))),e.detail.update&&(e.detail.update=s._cleanEvent(e.detail.update),0!=e.detail.update.keys.size&&(s._handleUpdate(e.detail.update),s.dispatchEvent(e)))),s._storedRemoveSection.forEach(function(e){s.dispatchEvent(e)}),s._storedRemoveSection=[]})}}return e.GroupingDataProvider=i,e.GroupingDataProvider=i,e.EventTargetMixin.applyMixin(i),i});