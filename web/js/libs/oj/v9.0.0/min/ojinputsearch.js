define(["exports","ojs/ojdomutils","ojs/ojlistdataproviderview","jquery","ojs/ojcore-base","ojs/ojcontext","ojs/ojlogger","ojs/ojthemeutils","ojs/ojtimerutils","ojs/ojvcomponent","ojs/ojpopupcore"],function(t,e,s,o,i,n,a,r,l,d,u){"use strict";o=o&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o;
/**
     * @license
     * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
     * The Universal Permissive License (UPL), Version 1.0
     * as shown at https://oss.oracle.com/licenses/upl/
     * @ignore
     */
var h=function(t,e,s,o){var i,n=arguments.length,a=n<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,s):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,o);else for(var r=t.length-1;r>=0;r--)(i=t[r])&&(a=(n<3?i(a):n>3?i(e,s,a):i(e,s))||a);return n>3&&a&&Object.defineProperty(e,s,a),a};class p extends d.VComponent{constructor(t){super(t),this._HIGHLIGHT_TOKEN="__@@__",this._fireSuggestionActionEvent=((t,e)=>{var s,o;null===(o=(s=this.props).onOjSuggestionAction)||void 0===o||o.call(s,{text:t,itemContext:e})}),this.state={formattedText:"",hover:!1}}fireSuggestionAction(){this._fireSuggestionActionEvent(this.state.formattedText,this.props.suggestionItemContext)}getFormattedText(){return this.state.formattedText}static initStateFromProps(t,e){return p.updateStateFromProps(t,e,null)}static updateStateFromProps(t,e,s){return{formattedText:p._formatItemText(t.suggestionItemText,t.suggestionItemContext)}}render(){const t=this.props,e=this.state,s={"oj-listbox-result":!0,"oj-listbox-result-selectable":!0,"oj-hover":e.hover,"oj-focus":t.focus},o=this._highlighter(e.formattedText,t.searchText);return d.h("li",{role:"presentation",class:s,onClick:this._handleClick,onMouseenter:this._handleMouseenter,onMouseleave:this._handleMouseleave},d.h("div",{id:t.labelId,class:"oj-listbox-result-label",role:"option"},o))}static _formatItemText(t,e){var s;let o;return(null==e?void 0:e.data)&&("string"==typeof t?((null===(s=e.data)||void 0===s?void 0:s.hasOwnProperty(t))||a.error(`oj-input-search: No '${t}' property found in DataProvider with key: ${null==e?void 0:e.key}`),o=e.data[t]):o=t(e)),o||""}_escapeRegExp(t){return t.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}_highlighter(t,e){if((null==e?void 0:e.length)>0){const s=this._escapeRegExp(e),o=t.replace(new RegExp(s,"gi"),this._HIGHLIGHT_TOKEN+"$&"+this._HIGHLIGHT_TOKEN).split(this._HIGHLIGHT_TOKEN).map((t,e)=>e%2==0?t:d.h("span",{class:"oj-listbox-highlighter"},t));return d.h("span",null,o)}return d.h("span",null,t)}_handleMouseenter(t){e.recentTouchEnd()||this.updateState({hover:!0})}_handleMouseleave(t){this.updateState({hover:!1})}_handleClick(t){0===t.button&&this._fireSuggestionActionEvent(this.state.formattedText,this.props.suggestionItemContext)}}p.metadata={extension:{_DEFAULTS:class{constructor(){this.focus=!1,this.labelId="",this.searchText=null,this.suggestionItemText="label"}}}},h([d.listener()],p.prototype,"_handleMouseenter",null),h([d.listener()],p.prototype,"_handleMouseleave",null),h([d.listener()],p.prototype,"_handleClick",null);var c=function(t,e,s,o){var i,n=arguments.length,a=n<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,s):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,o);else for(var r=t.length-1;r>=0;r--)(i=t[r])&&(a=(n<3?i(a):n>3?i(e,s,a):i(e,s))||a);return n>3&&a&&Object.defineProperty(e,s,a),a};t.InputSearch=class extends d.VComponent{constructor(t){super(t),this._CLASS_NAMES="oj-inputsearch-input",this._KEYS={TAB:9,ENTER:13,ESC:27,UP:38,DOWN:40},this._isComposing=!1,this._counter=0,this._queryCount=0,this._renderedSuggestions=[],this._handleMousedown=(t=>{0===t.button&&(this.updateState({focus:!0,dropdownOpen:!0}),t.target!==this._inputElem&&t.preventDefault())}),this._handleDropdownMousedown=(t=>{0===t.button&&(this.updateState({focus:!0}),t.preventDefault())}),this._handleDropdownMousemove=(t=>{this.updateState({lastEventType:"mouse"})}),this._handleDropdownMouseleave=(t=>{this.updateState({lastEventType:null})}),this._setRootElem=(t=>{this._rootElem=t}),this._setDropdownElem=(t=>{this._dropdownElem=t}),this._setInputElem=(t=>{this._inputElem=t}),this._setInputContainerElem=(t=>{this._inputContainerElem=t}),this._setRenderedSuggestion=((t,e)=>{this._renderedSuggestions[t]=e}),this._getRenderedSuggestionsCount=(()=>{const t=this._renderedSuggestions.length,e=this._renderedSuggestions.indexOf(null);return-1===e?t:e});let e=(r.parseJSONFromFontFamily("oj-inputsearch-option-defaults")||{}).showIndicatorDelay;e=parseInt(e,10),e=isNaN(e)?250:e,this._showIndicatorDelay=e,t.suggestions&&(this._dataProvider=this._wrapDataProviderIfNeeded(this.props.suggestions)),this.state={dropdownOpen:!1,dropdownAbove:!1,valueSubmitted:!1,focus:!1,hover:!1,active:!1,displayValue:null,filterText:null,lastFetchedFilterText:null,fetchedData:null,labelIds:[],fetchedInitial:!1,loading:!1,focusedSuggestionIndex:-1,activeDescendantId:null,scrollFocusedSuggestionIntoView:null,actionDetail:null,lastEventType:null}}render(){const t=this.state,e={"oj-inputsearch":!0,"oj-form-control":!0,"oj-text-field":!0,"oj-component":!0,"oj-hover":t.hover,"oj-active":t.active,"oj-focus":t.focus,"oj-listbox-dropdown-open":t.dropdownOpen,"oj-listbox-drop-above":t.dropdownOpen&&t.dropdownAbove},s=this._CLASS_NAMES+" oj-text-field-input",o=t.displayValue||"";return this._renderEnabled(e,"oj-inputsearch-search-icon oj-component-icon",o,s)}static initStateFromProps(t,e){return{displayValue:t.value,filterText:t.value}}static updateStateFromProps(t,e,s){const o={};return t.value!==s.value&&t.value!==e.displayValue&&(o.displayValue=t.value,o.filterText=t.value),s.suggestions!=t.suggestions&&(o.fetchedInitial=!1),t.suggestions||(o.dropdownOpen=!1,o.fetchedData=null),!1!==e.dropdownOpen&&!1!==o.dropdownOpen||(o.lastEventType=null),o}mounted(){this._updateProperty("rawValue",this.props.value),this._dataProvider&&this._addDataProviderEventListeners(this._dataProvider)}updated(t,e){var s,o;if((e.focus&&!this.state.focus||this.state.valueSubmitted)&&(this._updateProperty("value",this.state.displayValue),this.state.valueSubmitted&&(null===(o=(s=this.props).onOjValueAction)||void 0===o||o.call(s,{value:this.state.displayValue,itemContext:this.state.actionDetail}),this.updateState({valueSubmitted:!1}))),this.props.rawValue!=this.state.displayValue&&this._updateProperty("rawValue",this.state.displayValue),t.suggestions!=this.props.suggestions&&(t.suggestions&&this._removeDataProviderEventListeners(this._dataProvider),this.props.suggestions?(this._dataProvider=this._wrapDataProviderIfNeeded(this.props.suggestions),this._addDataProviderEventListeners(this._dataProvider)):(this._dataProvider=null,this._resolveFetching())),this.state.dropdownOpen){this.state.lastFetchedFilterText==this.state.filterText&&this.state.fetchedInitial||(this.updateState({lastFetchedFilterText:this.state.filterText}),this._fetchData(this.state.filterText)),e.dropdownOpen&&this.state.filterText===e.filterText?this.state.fetchedData&&this.updateState((t,e)=>({focusedSuggestionIndex:Math.min(t.fetchedData.length-1,t.focusedSuggestionIndex)})):this.updateState((t,e)=>{var s;return{focusedSuggestionIndex:(null===(s=t.filterText)||void 0===s?void 0:s.length)>0?0:-1}});const t=this._resolveFetchBusyState?-1:this.state.focusedSuggestionIndex;t>=0&&this.state.labelIds.length>t?this.updateState({activeDescendantId:this.state.labelIds[t]}):this.updateState({activeDescendantId:null})}else e.dropdownOpen&&(this.updateState({focusedSuggestionIndex:-1}),this._resolveFetching());const i=this.state.scrollFocusedSuggestionIntoView;if(i){const t=this.state.activeDescendantId;if(t){const e="top"===i;this._scrollSuggestionIntoView(t,e),this.updateState({scrollFocusedSuggestionIntoView:null})}}}unmounted(){this._dataProvider&&this._removeDataProviderEventListeners(this._dataProvider),this._resolveFetching()}_handleMouseenter(t){e.recentTouchEnd()||this.updateState({hover:!0})}_handleMouseleave(t){this.updateState({hover:!1})}_handleFocusin(t){this.updateState({focus:!0})}_handleFocusout(){this.updateState({focus:!1})}_handleCompositionstart(t){this._isComposing=!0}_handleCompositionend(t){this._isComposing=!1,this.updateState({filterText:t.target.value,displayValue:t.target.value})}_handleInput(t){this._isComposing||this.updateState({filterText:t.target.value,displayValue:t.target.value,dropdownOpen:!0})}_handleBlur(t){}_handleKeydown(t){var e;this.updateState({lastEventType:"keyboard"});const s=t.keyCode;switch(s){case this._KEYS.ENTER:const o=this.state.focusedSuggestionIndex;this.state.dropdownOpen&&o>=0&&this._getRenderedSuggestionsCount()>o&&!this._resolveFetchBusyState?this._renderedSuggestions[o].fireSuggestionAction():this.updateState({dropdownOpen:!1,valueSubmitted:!0,actionDetail:null});break;case this._KEYS.TAB:this.updateState({dropdownOpen:!1,focus:!1,actionDetail:null});break;case this._KEYS.ESC:this.updateState({dropdownOpen:!1}),t.preventDefault();break;case this._KEYS.UP:case this._KEYS.DOWN:const i={};if(this.state.dropdownOpen){if(!this._resolveFetchBusyState&&this._getRenderedSuggestionsCount()>0){let t=this.state.focusedSuggestionIndex;s===this._KEYS.DOWN||-1===t?(t+=1,i.scrollFocusedSuggestionIntoView="bottom"):t>0&&(t-=1,i.scrollFocusedSuggestionIntoView="top"),t=Math.min(this._getRenderedSuggestionsCount()-1,t),i.focusedSuggestionIndex=t,0===t&&(null===(e=this.state.filterText)||void 0===e?void 0:e.length)>0?i.displayValue=this.state.filterText:t>-1&&(i.displayValue=this._renderedSuggestions[t].getFormattedText())}}else i.dropdownOpen=!0;this.updateState(i)}}_getDropdownElemId(){return"searchDropdown_"+this.uniqueId()}_getInputContainerId(){return"searchInputContainer_"+this.uniqueId()}_getListboxId(){return"searchSuggestionsListbox_"+this.uniqueId()}_clickAwayHandler(t){const e=t.target;e.closest("#"+o.escapeSelector(this._getDropdownElemId()))||e.closest("#"+o.escapeSelector(this._getInputContainerId()))||this.updateState({dropdownOpen:!1})}_getDropdownPosition(){let t={my:"start top",at:"start bottom",of:this._inputContainerElem,collision:"flip",using:this._usingHandler.bind(this)};const s="rtl"===e.getReadingDirection();return t=i.PositionUtils.normalizeHorizontalAlignment(t,s)}_usingHandler(t,e){i.PositionUtils.isAligningPositionClipped(e)?this.updateState({dropdownOpen:!1}):(e.element.element.css(t),this.updateState({dropdownAbove:"bottom"===e.vertical}))}_renderEnabled(t,e,s,o){const n=this.props,a=this.state;let r=null;n["aria-label"]&&(r=n["aria-label"]);const l=a.dropdownOpen?this._renderDropdown():null,u=this._dataProvider?this._getListboxId():null,h=i.AgentUtils.getAgentInfo(),p=h.os===i.AgentUtils.OS.ANDROID||h.os===i.AgentUtils.OS.IOS||h.os===i.AgentUtils.OS.WINDOWSPHONE?"search":"text";return d.h("oj-input-search",{ref:this._setRootElem,class:t,onMousedown:this._handleMousedown,onMouseenter:this._handleMouseenter,onMouseleave:this._handleMouseleave},d.h("div",{role:"presentation",class:"oj-text-field-container",id:this._getInputContainerId(),ref:this._setInputContainerElem},d.h("span",{class:e,role:"presentation"}),d.h("div",{class:"oj-text-field-middle",role:this._dataProvider?"combobox":null,"aria-label":this._dataProvider?r:null,"aria-owns":u,"aria-haspopup":this._dataProvider?"listbox":"false","aria-expanded":a.dropdownOpen?"true":"false"},d.h("input",{type:p,ref:this._setInputElem,value:s,class:o,placeholder:n.placeholder,autocomplete:"off",autocorrect:"off",autocapitalize:"off",spellcheck:"false",autofocus:"false","aria-label":r,"aria-autocomplete":this._dataProvider?"list":null,"aria-controls":u,"aria-busy":a.dropdownOpen&&a.loading,"aria-activedescendant":this._dataProvider?a.activeDescendantId:null,onFocusin:this._handleFocusin,onFocusout:this._handleFocusout,onBlur:this._handleBlur,onInput:this._handleInput,onCompositionstart:this._handleCompositionstart,onCompositionend:this._handleCompositionend,onKeydown:this._handleKeydown}))),l)}_renderDropdown(){const t=this._getDropdownPosition(),e={minWidth:this._rootElem.offsetWidth+"px"},s=this.state.loading?this._renderDropdownSkeleton():this._renderDropdownSuggestions(this.state.filterText),o=this.state,i={"oj-listbox-drop":!0,"oj-listbox-inputsearch":!0,"oj-listbox-hide-hover":"keyboard"===o.lastEventType,"oj-listbox-hide-focus":"mouse"===o.lastEventType,"oj-listbox-drop-above":o.dropdownAbove};return d.h(u.VPopup,{position:t,layerSelectors:"oj-listbox-drop-layer",autoDismiss:this._clickAwayHandler},d.h("div",{id:this._getDropdownElemId(),ref:this._setDropdownElem,class:i,role:"presentation",style:e,onMousedown:this._handleDropdownMousedown,onMousemove:this._handleDropdownMousemove,onMouseleave:this._handleDropdownMouseleave},s))}_scrollSuggestionIntoView(t,e){const s=document.getElementById(t),o=s.closest(".oj-listbox-result"),i=s.closest(".oj-listbox-results"),n=o.offsetTop,a=o.offsetHeight,r=i.scrollTop,l=i.offsetHeight;(n<r||n+a>r+l)&&(i.scrollTop=e?n:n+a-l)}_generateId(){return this.uniqueId()+"-"+this._counter++}_handleDataProviderRefreshEventListener(t){this.updateState({fetchedInitial:!1})}_fetchData(t){this._queryCount+=1;const e=this._queryCount;let s=t;""===s&&(s=null);let o={size:12};if(s){const t=this._dataProvider.getCapability("filter");t&&t.textFilter||a.error("InputSearch: DataProvider does not support text filter. Filtering results in dropdown may not work correctly."),o.filterCriterion=i.FilterFactory.getFilter({filterDef:{text:s}})}if(!this._loadingTimer){const t=l.getTimer(this._showIndicatorDelay);t.getPromise().then(function(t){this._loadingTimer=null,t&&this._dataProvider&&this.state.dropdownOpen&&this.updateState({loading:!0})}.bind(this)),this._loadingTimer=t}let n=[];this._resolveFetchBusyState||(this._resolveFetchBusyState=this._addBusyState("InputSearch: fetching suggestions"));const r=this._dataProvider.fetchFirst(o)[Symbol.asyncIterator]();let d=12;const u=function(t){if(e!==this._queryCount)return;let s=t.done;const o=t.value,i=o.data,a=o.metadata;for(let t=0;t<i.length;t++){const e=i[t],o=a[t],r=o.key;if(n.push({data:e,metadata:o,key:r}),0===(d-=1)){s=!0;break}}if(s){let t=[];for(let e=0;e<n.length;e++)t.push("oj-inputsearch-result-label-"+this._generateId());this.updateState({fetchedInitial:!0,labelIds:t,fetchedData:n}),this._resolveFetching()}else r.next().then(u)}.bind(this);r.next().then(u)}_renderDropdownSkeleton(){let t=1,e=0;if(this._dropdownElem){const s=this._dropdownElem.querySelectorAll(".oj-listbox-result");if(t=Math.max(1,s.length),s.length>0){e=this._dropdownElem.querySelector(".oj-listbox-results").offsetWidth}}const s=e>0?{width:e+"px"}:null;let o=[];for(let e=0;e<t;e++)o.push(d.h("li",{role:"presentation",class:"oj-listbox-result",style:s},d.h("div",{class:"oj-listbox-result-label oj-listbox-skeleton-line-height oj-animation-skeleton"})));return d.h("ul",{role:"listbox",id:this._getListboxId(),class:"oj-listbox-results oj-inputsearch-results"},o)}_renderDropdownSuggestions(t){var e;const s=this.state;if((null===(e=s.fetchedData)||void 0===e?void 0:e.length)>0){let e=[];for(let o=0;o<s.fetchedData.length;o++){const i=o===s.focusedSuggestionIndex,n=d.h(p,{ref:this._setRenderedSuggestion.bind(this,o),labelId:s.labelIds[o],focus:i,searchText:t,suggestionItemContext:s.fetchedData[o],suggestionItemText:this.props.suggestionItemText,onOjSuggestionAction:this._handleSuggestionAction});e.push(n)}return d.h("ul",{role:"listbox",id:this._getListboxId(),class:"oj-listbox-results oj-inputsearch-results"},e)}return null}_handleSuggestionAction(t){this.updateState({filterText:t.text,displayValue:t.text,dropdownOpen:!1,valueSubmitted:!0,actionDetail:t.itemContext})}_addBusyState(t){const e=this._rootElem,s={description:'The component identified by "'+e.id+'" '+t};return n.getContext(e).getBusyContext().addBusyState(s)}_isDataProvider(t){return!(null==t||!t.fetchFirst)}_wrapDataProviderIfNeeded(t){if(this._isDataProvider(t)){let e=t;return e instanceof i.ListDataProviderView||(e=new i.ListDataProviderView(e)),e}return null}_addDataProviderEventListeners(t){t.addEventListener("mutate",this._handleDataProviderRefreshEventListener),t.addEventListener("refresh",this._handleDataProviderRefreshEventListener)}_removeDataProviderEventListeners(t){t.removeEventListener("mutate",this._handleDataProviderRefreshEventListener),t.removeEventListener("refresh",this._handleDataProviderRefreshEventListener)}_resolveFetching(){this._loadingTimer&&(this._loadingTimer.clear(),this._loadingTimer=null),this._resolveFetchBusyState&&(this._resolveFetchBusyState(),this._resolveFetchBusyState=null),this.state.loading&&this.updateState({loading:!1})}},t.InputSearch.metadata={extension:{_DEFAULTS:class{constructor(){this.suggestions=null,this.suggestionItemText="label",this.placeholder="",this.rawValue=null,this.value=null}},_ROOT_PROPS_MAP:{"aria-label":!0}},properties:{suggestions:{type:"object|null",value:null},suggestionItemText:{type:"string|function",value:"label"},placeholder:{type:"string",value:""},rawValue:{type:"string|null",value:null,writeback:!0,readOnly:!0},value:{type:"string|null",value:null,writeback:!0,readOnly:!1}},events:{ojValueAction:{bubbles:!1}}},c([d.listener()],t.InputSearch.prototype,"_handleMouseenter",null),c([d.listener()],t.InputSearch.prototype,"_handleMouseleave",null),c([d.listener()],t.InputSearch.prototype,"_handleFocusin",null),c([d.listener()],t.InputSearch.prototype,"_handleFocusout",null),c([d.listener()],t.InputSearch.prototype,"_handleCompositionstart",null),c([d.listener()],t.InputSearch.prototype,"_handleCompositionend",null),c([d.listener()],t.InputSearch.prototype,"_handleInput",null),c([d.listener()],t.InputSearch.prototype,"_handleBlur",null),c([d.listener()],t.InputSearch.prototype,"_handleKeydown",null),c([d.listener()],t.InputSearch.prototype,"_clickAwayHandler",null),c([d.listener()],t.InputSearch.prototype,"_handleDataProviderRefreshEventListener",null),c([d.listener()],t.InputSearch.prototype,"_handleSuggestionAction",null),t.InputSearch=c([d.customElement("oj-input-search")],t.InputSearch),Object.defineProperty(t,"__esModule",{value:!0})});