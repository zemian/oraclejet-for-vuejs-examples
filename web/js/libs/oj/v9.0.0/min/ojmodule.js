/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore","knockout","ojs/ojlogger","ojs/ojcontext"],function(e,n,i,o){"use strict";e.ModuleBinding={};e.ModuleBinding;return e.ModuleBinding.defaults={viewPath:"text!views/",viewSuffix:".html",modelPath:"viewModels/",initializeMethod:"initialize",disposeMethod:"dispose",activatedHandler:"handleActivated",attachedHandler:"handleAttached",detachedHandler:"handleDetached",bindingsAppliedHandler:"handleBindingsApplied",deactivatedHandler:"handleDeactivated",transitionCompletedHandler:"handleTransitionCompleted"},e.ModuleBinding._EMPTY_MODULE="oj:blank",function(){function t(e,i,o){var t=i||e,l=[];o&&e===t&&(o.parentNode.removeChild(o),l.push(o)),n.virtualElements.setDomNodeChildren(t,l)}function l(e,n){e.forEach(function(e){n.appendChild(e)})}function r(e,i){for(var o,t=0;t<e.length&&!(o=n.contextFor(e[t]));t++);return o&&o.$module&&o.$module===i}function d(e,n,i){var o={};i[0]&&(o.viewModel=i[0]),i[1]&&(o.view=i[1]);var t=new CustomEvent(n,{detail:o});e.dispatchEvent(t)}function a(e,i,o){if(e&&e[i]){var t={element:o[0],valueAccessor:o[1]};return o.length>2&&(t.viewModel=o[2],o.length>3&&(t["boolean"==typeof o[3]?"fromCache":"cachedNodes"]=o[3])),n.ignoreDependencies(e[i],e,[t])}}function u(i,o,t){if(null!=i){var l=e.ModuleBinding.defaults[o];if(null!=l&&i){var r,d=i[l];if("function"==typeof d)return t&&(r={element:t[0],valueAccessor:t[1]},t.length>2&&(r["boolean"==typeof t[2]?"fromCache":"cachedNodes"]=t[2])),n.ignoreDependencies(d,i,[r])}}}function s(e,i){if(e&&i){var o=e[i];"function"==typeof o&&n.ignoreDependencies(o,e)}}function c(e,i,o){for(var t=e;null!=t;){var l=n.virtualElements.nextSibling(t),r=t.nodeType;t===i||1!==r&&8!==r||o(t),t=l}}function f(e,i){for(var o=i.length-1;o>=0;o--)n.virtualElements.prepend(e,i[o])}function v(e,n){if(n)for(var i=0;i<e.length;i++){var o=e[i];1===o.nodeType&&n(o)}}function p(e,n,o){var t=e||require,l=new Promise(function(e,n){t([o],e,n)});return l=l.catch(function(e){throw i.error("ojModule failed to load "+o),e})}n.bindingHandlers.ojModule={init:function(h,m,w,g,M){var C,b,E,y,N,P,j,V,D={},A=-1,B=h.parentNode&&"OJ-MODULE"===h.parentNode.nodeName,H=B?function(){}:u,$=B?function(){}:a,x=B?s:function(){},T=B?d:function(){};function _(){P&&(P(),P=null)}var O=function(e){H(e,"disposeMethod",[h,m])},F=function(){O(C)};n.utils.domNodeDisposal.addDisposeCallback(h,function(){F();for(var e=Object.keys(D),n=0;n<e.length;n++){var i=D[e[n]].model;O(i)}_()});var S=new Error("Promise cancelled because ojModule is fetching new View and ViewModel"),k=function(e){if(e!==A)throw S},L=h;return 8===h.nodeType&&(L=h.parentNode,n.virtualElements.setDomNodeChildren(h,[]),N=h.nextSibling),n.computed(function(){if(A+=1,!P){var d=o.getContext(L).getBusyContext();P=d.addBusyState({description:"ojModule binding on a node with the Id "+h.id+"is loading the module. Binding evaluator: "+m.toString()})}var a,u,s,w,g,O,q,I,U,z,J,Y,K,R,W=0===A,G=n.utils.unwrapObservable,Q=G(m());"string"==typeof Q?a=Q:(a=G(Q.name),u=G(Q.viewName),s=G(Q.params),w=G(Q.viewModelFactory),g=G(Q.createViewFunction),O=G(Q.cacheKey),q=G(Q.lifecycleListener),I=G(Q.animation),Y=G(Q.view),K=G(Q.viewModel),U=G(Q.require),R=G(Q.cleanupMode)),null==U||U instanceof Function||(J=U.viewPath,z=U.modelPath,U=U.instance),u=null==u?a:u;var X,Z,ee,ne,ie=e.ModuleBinding._EMPTY_MODULE===u,oe=$(q,"activated",[h,m]);if(T(L,"ojTransitionStart",[K]),ie?(X=Promise.resolve([]),Z=Promise.resolve(null)):null!=(ee=null==O?null:D[O])&&(delete D[O],X=Promise.resolve(ee.view),Z=Promise.resolve(ee.model)),null==X&&null!=Y&&(X=Promise.resolve(Y)),null==Z&&(null!=K?Z=Promise.resolve(K):null!=w&&(Z=n.ignoreDependencies(w.createViewModel,w,[s,m])),null==Z&&null!=a&&(null==z&&(z=e.ModuleBinding.defaults.modelPath),Z=p(U,"viewModel",z+a)),null!=Z&&(Z=Z.then(function(e,n){return k(e),n="function"==typeof n?new n(s):H(n,"initializeMethod",[h,m])||n}.bind(null,A)),null==X&&null!=g&&(X=Z.then(function(e,n){if(k(e),null==n)throw _(),new Error("createViewFunction option cannot be used when the ViewModel is null");var i=n[g];if(null==i)throw _(),new Error("function specified by the createViewFunction option was not found on the ViewModel");return i.call(n)}.bind(null,A)))),null==X)){if(null==u)throw _(),new Error("View name or view instance must be specified");null==J&&(J=e.ModuleBinding.defaults.viewPath),X=p(U,"view",J+u+e.ModuleBinding.defaults.viewSuffix)}if(null==X)throw _(),new Error("ojModule is missing a View");null!=Z&&(ne=Z.then(function(e,n){return k(e),H(n,"activatedHandler",[h,m])}.bind(null,A))),Promise.all([X,Z,oe,ne,b]).then(function(o,d){if(o===A){var a=d[0];if(null==a)throw _(),new Error("The module's View was resolved to null");var u=function(e,i){var o=e;if("string"==typeof o)o=n.utils.parseHtmlFragment(o,document);else if(function(e){if(window.DocumentFragment)return e instanceof DocumentFragment;return e&&11===e.nodeType}(o))o=n.utils.arrayPushAll([],o.childNodes);else{if(!Array.isArray(o))throw i(),new Error("The View ("+o+") has an unsupported type");o=n.utils.arrayPushAll([],o)}return o}(a,_),p=d[1];!function(e,n,i,o,t){if(o&&n.length>0&&!r(n,i)){if(n[0]._oj_module_used_view)throw t(),new Error("The oj-module with id '"+e.id+"' cannot apply binding on a previously cleaned view.");Object.defineProperty(n[0],"_oj_module_used_view",{value:!0})}}(h,u,p,B,_);var w,g=!1,P=function(e,i,o){for(var t=[],l=n.virtualElements.firstChild(e);null!=l&&l!==o;l=l.nextSibling)l!==i&&t.push(l);return t}(h,y,N),S=function(e,i){var o=[];return c(n.virtualElements.firstChild(e),i,function(e){o.push(e)}),o}(h,y);null==E||j?B&&(w=P):(g=!0,w=P,y||((y=document.createElement("div")).className="oj-helper-module-cache",n.virtualElements.prepend(h,y)));var k=!1,U=function(i){if(!k){if(k=!0,g)l(P,y),t(h,i||h,y);else if(B&&"none"===V)for(var o=0;o<w.length;o++){var r=w[o];r.parentNode.removeChild(r)}else S.forEach(function(e){n.cleanNode(e)}),t(h,i||h,y);W||($(q,"detached",[h,m,C,w]),H(C,"detachedHandler",[h,m,w]),x(C,"disconnected"),T(L,"ojViewDisconnected",[C,w]),$(q,"deactivated",[h,m,C]),H(C,"deactivatedHandler",[h,m])),g?(v(w,e.Components?e.Components.subtreeHidden:null),D[E]={model:C,view:w}):B&&"none"===V?v(w,e.Components?e.Components.subtreeDetached:null):F(),C=p,E=O,j=ie,V=R}},z=function(){$(q,"transitionCompleted",[h,m,p]),H(p,"transitionCompletedHandler",[h,m]),x(p,"transitionCompleted"),T(L,"ojTransitionEnd",[p]),_()};if(null!=I){var J=function(o,t,r,d,a,u,s){var c,p,h=o,m=t.canAnimate;if(null!=m&&!m.call(t,h))return;var w=t.prepareAnimation.call(t,h);w&&(c=w.newViewParent,p=w.oldViewParent);var g=c||r;p&&p!==r?l(d,p):g===r&&u(null);g!==r&&n.virtualElements.setDomNodeChildren(g,[]);a(g);var M=Array.prototype.slice.call(g.childNodes),C=!1,b=function(){if(!C&&(C=!0,r!==g)){f(r,M);var n=r.parentNode&&"OJ-MODULE"===r.parentNode.nodeName;e.Components&&!n&&(v(M,e.Components.subtreeDetached),v(M,e.Components.subtreeAttached))}},E=u.bind(null,p);h.newViewParent=c,h.oldViewParent=p,h.oldViewNodes=d,h.removeOldView=E,h.insertNewView=b;var y=function(){E(),b(),s()};return t.animate.call(t,h).then(y,function(){y(),i.error("ojModule animation promise was rejected")})}(function(e,n,i,o,t,l){return{node:l?e.parentNode:e,valueAccessor:l?null:n,isInitial:i,oldViewModel:o,newViewModel:t}}(h,m,W,C,p,B),I,h,P,Y,U,z);b=function(e){if(!e)return e;return new Promise(function(n,i){e.then(n,n)})}(J)}else b=void 0;b||(U(null),Y(null),z())}function Y(i){var o=i||h,t=B&&r(u,p);f(o,u);var l=null!=ee;if(l?v(u,e.Components?e.Components.subtreeShown:null):t&&v(u,e.Components?e.Components.subtreeAttached:null),$(q,"attached",[o,m,p,l]),H(p,"attachedHandler",[o,m,l]),x(p,"connected"),T(L,"ojViewConnected",[p]),!l&&!t){var d=M.createChildContext(p,void 0,function(e){e.$module=p,e.$params=s});B&&(d.$parent=void 0,d.$parents=void 0,d.$parentContext=void 0,d.$props=void 0,d.$properties=void 0,d.$slotNodeCounts=void 0,d.$slotCounts=void 0,d.$unique=void 0,d.$uniqueId=void 0,d.$provided=void 0),function(e,i,o,t){var l=n.bindingProvider.instance,r=l.preprocessNode;r&&(c(i,t,function(e){r.call(l,e)}),i=n.virtualElements.firstChild(e));c(i,t,function(e){n.applyBindings(o,e)})}(o,u[0],d,y),$(q,"bindingsApplied",[o,m,p]),H(p,"bindingsAppliedHandler",[o,m])}}}.bind(null,A),function(e,n){n!==S&&null!=n&&(_(),i.error(n))}.bind(null,A))},null,{disposeWhenNodeIsRemoved:h}),{controlsDescendantBindings:!0}}},n.virtualElements.allowedBindings.ojModule=!0}(),e.ModuleBinding});