/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore","jquery","ojs/ojcomponentcore","ojs/ojconfig","ojs/ojhtmlutils","ojs/ojlogger","ojs/ojthemeutils","ojs/ojcachingdataprovider","ojs/ojlistdataproviderview","ojs/ojtreedataproviderview","ojs/ojcontext","ojs/ojtimerutils","ojs/ojkeyset","ojs/ojeditablevalue","ojs/ojlistview","ojs/ojpopupcore","ojs/ojinputtext"],function(e,t,i,n,r,o,a,s,l,d,u,c,h){"use strict";var p={properties:{data:{type:"oj.DataProvider"},describedBy:{type:"string"},disabled:{type:"boolean",value:!1},displayOptions:{type:"object",properties:{helpInstruction:{type:"Array<string>|string",value:["notewindow"]},messages:{type:"Array<string>|string",value:["inline"]}}},help:{type:"object",properties:{instruction:{type:"string",value:""}}},helpHints:{type:"object",properties:{definition:{type:"string",value:""},source:{type:"string",value:""}}},itemText:{type:"string|function",value:"label"},labelEdge:{type:"string",enumValues:["inside","none","provided"]},labelHint:{type:"string",value:""},labelledBy:{type:"string"},messagesCustom:{type:"Array<Object>",writeback:!0,value:[]},placeholder:{type:"string",value:""},readonly:{type:"boolean",value:!1},required:{type:"boolean",value:!1},translations:{type:"object",value:{},properties:{cancel:{type:"string"},labelAccClearValue:{type:"string"},labelAccOpenDropdown:{type:"string"},multipleMatchesFound:{type:"string"},nOrMoreMatchesFound:{type:"string"},noMatchesFound:{type:"string"},noResultsLine1:{type:"string"},noResultsLine2:{type:"string"},oneMatchFound:{type:"string"},required:{type:"object",properties:{hint:{type:"string"},messageDetail:{type:"string"},messageSummary:{type:"string"}}}}},userAssistanceDensity:{type:"string",enumValues:["compact","efficient","reflow"],value:"reflow"},valid:{type:"string",writeback:!0,enumValues:["invalidHidden","invalidShown","pending","valid"],readOnly:!0},value:{type:"any",writeback:!0},valueItem:{type:"object",writeback:!0,value:{key:null,data:null,metadata:null}},virtualKeyboard:{type:"string",enumValues:["email","number","search","tel","text","url"],value:"search"}},methods:{refresh:{},validate:{},reset:{},showMessages:{},setProperty:{},getProperty:{},setProperties:{},getNodeBySubId:{},getSubIdByNode:{}},events:{ojAnimateStart:{},ojAnimateEnd:{}},extension:{}};function _(t){function i(e,t){var i=new function(e,t){this.next=function(){var i=e.next();return new Promise(function(e,n){i.then(function(i){var n=i.value;n.data&&(t.count+=n.data.length),t.done=i.done,e(i)},function(e){n(e)})})}}(e,t);this[Symbol.asyncIterator]=function(){return i}}this._fetchedDataCount={count:0,done:!0},this.setFilterCriterion=function(t){var i,n,r=this._filterCriterion;if(this._filterCriterion=t,i=r,n=this._filterCriterion,!(i===n||!i&&!n||i&&n&&i.text===n.text)){var o=new e.DataProviderRefreshEvent;Object.defineProperty(o,"filterCriterionChanged",{value:!0}),this.dispatchEvent(o)}},this.getFetchedDataCount=function(){return this._fetchedDataCount},this.fetchFirst=function(e){if(t)return this._filterCriterion&&(e.filterCriterion=this._filterCriterion),this._fetchedDataCount={count:0,done:!0},new i(t.fetchFirst(e)[Symbol.asyncIterator](),this._fetchedDataCount);var n={};return n[Symbol.asyncIterator]=function(){return{next:function(){return Promise.resolve({value:{data:[],fetchParameters:e,metadata:[]},done:!0})}}},n},this.containsKeys=function(e){return t?t.containsKeys(e):Promise.resolve({containsParameters:e,results:new Set})},this.fetchByKeys=function(e){return t?t.fetchByKeys(e):Promise.resolve({fetchParameters:e,results:new Map})},this.fetchByOffset=function(e){return t?(this._filterCriterion&&(e.filterCriterion=this._filterCriterion),t.fetchByOffset(e)):Promise.resolve({done:!0,fetchParameters:e,results:[]})},this.isEmpty=function(){return t?t.isEmpty():"yes"},this.getTotalSize=function(){return t?t.getTotalSize():Promise.resolve(0)},this.addEventListener=function(e,i){t&&t.addEventListener(e,i)},this.removeEventListener=function(e,i){t&&t.removeEventListener(e,i)},this.dispatchEvent=function(e){return!t||t.dispatchEvent(e)},this.getCapability=function(e){return t?t.getCapability(e):null},t&&e.DataProviderFeatureChecker.isTreeDataProvider(t)&&(this.getChildDataProvider=function(){let e=t.getChildDataProvider.apply(t,arguments);return e&&(e=new _(e),this._filterCriterion&&e.setFilterCriterion(this._filterCriterion)),e}.bind(this))}var v,f={KEYS:{TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46},_isControlKey:function(e){switch(e.which){case f.KEYS.SHIFT:case f.KEYS.CTRL:case f.KEYS.ALT:return!0;default:return e.metaKey||e.ctrlKey}},_isFunctionKey:function(e){var t=e.which?e.which:e;return t>=112&&t<=123},isControlOrFunctionKey:function(e){return f._isControlKey(e)||f._isFunctionKey(e)},nextUid:(v=1,function(){var e=v;return v+=1,e}),killEvent:function(e){e.preventDefault()},stopEventPropagation:function(e){e.stopPropagation()},addBusyState:function(e,t){var i={description:"The component identified by '"+e.id+"' "+t};return u.getContext(e).getBusyContext().addBusyState(i)},createValueItem:function(e,t,i){return{key:e,data:t,metadata:i}},dispatchCustomEvent:function(e,t,i,n){var r=n||{};r.subtype=i;var o={bubbles:!1,cancelable:!1,detail:r};return e.dispatchEvent(new CustomEvent(t,o))},isValueItemForPlaceholder:function(e){return null==e||f.isValueForPlaceholder(e.key)},isValueForPlaceholder:function(e){return null==e},copyAttribute:function(e,t,i,n){var r=e.getAttribute(t);null===r?i.removeAttribute(n):i.setAttribute(n,r)}},m=function(){};m.prototype.init=function(e){this._dataProvider=e.dataProvider,this._fullScreenPopup=e.fullScreenPopup,this._bodyElem=t(e.bodyElem),this._itemTemplate=e.itemTemplate,this._collectionTemplate=e.collectionTemplate,this._getTemplateEngineFunc=e.getTemplateEngineFunc,this._templateContextComponentElement=e.templateContextComponentElement,this._addBusyStateFunc=e.addBusyStateFunc,this._itemTextRendererFunc=e.itemTextRendererFunc,this._filterInputText=e.filterInputText,this._currentFirstItem=null,this._templateEngine=null,this._resultsCount=null,this._NO_RESULTS_FOUND_CLASSNAME="oj-listbox-searchselect-no-results";var i=this._addBusyStateFunc("LovDropdown initializing");this._addDataProviderEventListeners();var n,r,o=this._createInnerDom(e);this._containerElem=o;var a=new Promise(function(e,t){n=e,r=t});this._collectionContext={parentElement:this._containerElem[0],idSuffix:e.idSuffix,renderDone:n,renderError:r,data:this._dataProvider,searchText:void 0,selected:void 0,selectedItem:void 0,selectedItemChangedListener:this._handleCollectionSelectedItemChanged.bind(this),currentRow:{rowIndex:void 0,rowKey:void 0},currentRowChangedListener:this._handleCollectionCurrentRowChanged.bind(this),currentRowKeyChangedListener:this._handleCollectionCurrentRowKeyChanged.bind(this),handleRowAction:this._handleRowAction.bind(this)},this._collectionRendererFunc=this._collectionTemplate?this._templateCollectionRenderer.bind(this):this._defaultCollectionRenderer.bind(this),this._collectionRendererFunc(this._collectionContext),o.on("change","."+e.className+"-input",f.stopEventPropagation),o.on("click mouseup mousedown",f.stopEventPropagation);var s=function(){e.afterDropdownInitFunc&&e.afterDropdownInitFunc(this._resultsElem[0]),i()}.bind(this);if(a.then(s,s),o.on("keydown",this._handleKeyDown.bind(this)),this._updateLabelFunc){var l=this._updateLabelFunc;this._updateLabelFunc=null,l()}},m.prototype._dispatchEvent=function(e,t){return f.dispatchCustomEvent(this._containerElem[0],"lovDropdownEvent",e,t)},m.prototype.destroy=function(){(this._itemTemplate||this._collectionTemplate)&&this._containerElem&&this._getTemplateEngineFunc().then(function(e){e.clean(this._containerElem[0])}.bind(this)),this._removeDataProviderEventListeners()},m.prototype.getElement=function(){return this._containerElem?this._containerElem[0]:null},m.prototype._createInnerDom=function(e){var i=e.idSuffix,n=document.createElement("div");n.setAttribute("data-oj-containerid",e.parentId),n.setAttribute("data-oj-context",""),n.setAttribute("id","lovDropdown_"+i),n.setAttribute("class","oj-listbox-drop oj-listbox-searchselect"+(this._fullScreenPopup?" oj-listbox-fullscreen":"")),n.style.display="none",n.setAttribute("role","presentation"),this._fullScreenPopup&&n.appendChild(this._filterInputText);var r=document.createElement("div");return r.setAttribute("class","oj-searchselect-results-placeholder"),n.appendChild(r),t(n)},m._highlighter=function(e,t){if(t&&t.length>0){var i=m._escapeRegExp(t);return e.replace(new RegExp(i,"gi"),'<span class="oj-listbox-highlighter">$&</span>')}return e},m._escapeRegExp=function(e){return e.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")},m.prototype._defaultItemRenderer=function(e){for(var t=e.parentElement,i=this._itemTextRendererFunc({key:e.key,data:e.data,metadata:e.metadata}),n=!1===e.leaf?i:m._highlighter(i,this._collectionContext.searchText),o=r.stringToNodeArray("<span>"+n+"</span>"),a=0;a<o.length;a++)t.appendChild(o[a])},m.prototype._templateItemRenderer=function(e,i){var n=t.extend({},i);n.componentElement=this._templateContextComponentElement,n.searchText=this._collectionContext.searchText;var r=n.parentElement;if(e)for(var o=e.execute(n.componentElement,this._itemTemplate,n),a=0;a<o.length;a++)r.appendChild(o[a])},m.prototype.renderResults=function(e,t,i,n){var r,a,s=this._addBusyStateFunc("LovDropdown rendering results");this._latestFilterCriteria=t,this._dataProvider.setFilterCriterion(t),this._duringListViewInitialization=!0;var l=new Promise(function(e,t){r=e,a=t}),d=new Promise(function(t,r){l.then(function(){u.getContext(this._containerElem[0]).getBusyContext().whenReady().then(function(){this._configureResults(e,i,n).then(t,r)}.bind(this),r)}.bind(this),r)}.bind(this));this._lastRenderResultsPromise=d;var c=this._collectionContext;c.data=this._dataProvider,c.searchText=e;var p=[];if(f.isValueForPlaceholder(i)||p.push(i),c.selected=new h.KeySetImpl(p),c.renderError){var _=c.renderError;this._clearContextRenderPromiseFunctions(c),_("LovDropdown.renderResults: rejecting earlier promise")}c.renderDone=r,c.renderError=a,this._collectionRendererFunc(c);var v=function(){d===this._lastRenderResultsPromise&&(this._duringListViewInitialization=!1),s()}.bind(this);return d.then(function(){v()},function(e){d===this._lastRenderResultsPromise&&o.warn("Select: LovDropdown.renderResults retPromise rejected: "+e),v()}.bind(this))},m.prototype.updateLabel=function(e,t){var i=this._resultsElem;if(i){if(!this._collectionTemplate){var n=i[0];e?(n.setAttribute("aria-labelledby",e),n.setAttribute("aria-label","")):t&&(n.setAttribute("aria-label",t),n.setAttribute("aria-labelledby",""))}}else this._updateLabelFunc=this.updateLabel.bind(this,e,t)},m.prototype._configureResults=function(e,t,i){var n=u.getContext(this._containerElem[0]).getBusyContext();return this._setCurrentFirstItem(null),this._resultsCount=this._dataProvider.getFetchedDataCount()||{},null==this._resultsCount.count||0===this._resultsCount.count?(this._containerElem.addClass(this._NO_RESULTS_FOUND_CLASSNAME),Promise.resolve()):(this._containerElem.removeClass(this._NO_RESULTS_FOUND_CLASSNAME),i?null!=t&&this._resultsCount.count>0?(this._setCollectionCurrentRow({rowKey:t}),n.whenReady()):Promise.resolve():null==e||""===e?(this._clearSelection(),n.whenReady()):this._fetchFirstResult().then(function(e){if(null==e)return this._clearSelection(),n.whenReady();var t=e.key;return this._setCurrentFirstItem(e),this._setCollectionCurrentRow({rowKey:t}),this._setCollectionSelectedKeySet(t),n.whenReady()}.bind(this)))},m.prototype._fetchFirstResult=function(){return e.DataProviderFeatureChecker.isTreeDataProvider(this._dataProvider)?this._fetchFirstLeafData():this._fetchFirstFlatData()},m.prototype._fetchFirstFlatData=function(){var e=this._dataProvider.fetchByOffset({offset:0,size:1}),t=null,i=function(e){if(null!=e){let i=e.results;if(i.length>0){let e=i[0];t=this._createValueItemFromItem(e)}}return Promise.resolve(t)}.bind(this);return e.then(i)},m.prototype._fetchFirstLeafData=function(){var e={size:1},t=this,i=!1,n=function(r){let o=null,a=r.fetchFirst(e)[Symbol.asyncIterator](),s=function(e){let l=e.value.data,d=e.value.metadata,u=function(e){if(e<l.length&&!i){let a=l[e],s=d[e],c=r.getChildDataProvider(a.value);if(null!=c)return n(c).then(function(t){return o=t,u(e+1)});let h={data:a,metadata:s};o=t._createValueItemFromItem(h),i=!0}return Promise.resolve(o)};return u(0).then(function(){return e.done||i?Promise.resolve(o):a.next().then(s)})};return a.next().then(s)};return n(this._dataProvider)},m.prototype._clearSelection=function(){this._setCollectionCurrentRow({rowKey:null}),this._setCollectionSelectedKeySet(null)},m.prototype._clearContextRenderPromiseFunctions=function(e){e.renderDone=null,e.renderError=null},m.prototype._defaultCollectionRenderer=function(i){var n,r=i.renderDone,a=i.renderError;if(this._resultsElem)n=this._resultsElem[0],u.getContext(n).getBusyContext().whenReady().then(function(){n.data=i.data,n.selected=i.selected,n.currentItem=i.currentRow.rowKey,this._clearContextRenderPromiseFunctions(i),r()}.bind(this),function(e){o.warn("Select: busyContext promise rejected before setting props on listView: "+e),this._clearContextRenderPromiseFunctions(i),a(e)}.bind(this));else{var s=t(i.parentElement).find(".oj-searchselect-results-placeholder")[0],l=i.idSuffix;(n=document.createElement("oj-list-view")).setAttribute("data-oj-internal",""),n.setAttribute("data-oj-binding-provider","none"),n.setAttribute("id","oj-searchselect-results-"+l),n.setAttribute("selection-mode","single"),n.setAttribute("class","oj-select-results"),n.setAttribute("drill-mode","none"),n.setAttribute("gridlines.item","hidden");var d=document.createElement("template");d.setAttribute("slot","noData");var c=document.createElement("div");c.setAttribute("class","oj-searchselect-no-results-container"),d.content?d.content.appendChild(c):d.appendChild(c),n.appendChild(d),i.parentElement.replaceChild(n,s),this._resultsElem=t(n),this._resultsElem.on("click",f.killEvent),u.getContext(n).getBusyContext().whenReady().then(function(){n.addEventListener("ojItemAction",i.handleRowAction),n.addEventListener("currentItemChanged",function(e){i.currentRowKeyChangedListener(e.detail.value)}),i.data&&e.DataProviderFeatureChecker&&e.DataProviderFeatureChecker.isTreeDataProvider(i.data)&&(n.setProperty("item.focusable",e=>e.leaf),n.setProperty("item.selectable",e=>e.leaf)),this._itemTemplate?this._getTemplateEngineFunc().then(function(e){n.setProperty("item.renderer",this._templateItemRenderer.bind(this,e)),this._clearContextRenderPromiseFunctions(i),r()}.bind(this),function(e){o.warn("Select: template item renderer template engine promise rejected: "+e),this._clearContextRenderPromiseFunctions(i),a(e)}.bind(this)):(n.setProperty("item.renderer",this._defaultItemRenderer.bind(this)),this._clearContextRenderPromiseFunctions(i),r())}.bind(this),function(e){o.warn("Select: creating default listView busyContext promise rejected: "+e),this._clearContextRenderPromiseFunctions(i),a(e)}.bind(this))}},m.prototype._templateCollectionRenderer=function(e){var i=e.renderDone,n=e.renderError;if(this._resultsElem){var r=this._collectionTemplateContext;r.data=e.data,r.searchText=e.searchText,r.selected=e.selected,this._clearContextRenderPromiseFunctions(e),i()}else{var a=t(e.parentElement),s=a.find(".oj-searchselect-results-placeholder")[0];this._getTemplateEngineFunc().then(function(t){this._templateEngine=t,this._collectionTemplateContext=this._createCollectionTemplateContext(t,e);for(var n=t.execute(this._templateContextComponentElement,this._collectionTemplate,this._collectionTemplateContext),r=0;r<n.length;r++)s.parentNode.insertBefore(n[r],s);s.parentNode.removeChild(s),this._resultsElem=a.find(".oj-select-results"),this._resultsElem.on("click",f.killEvent),this._clearContextRenderPromiseFunctions(e),i()}.bind(this),function(t){o.warn("Select: template collection renderer template engine promise rejected: "+t),this._clearContextRenderPromiseFunctions(e),n(t)}.bind(this))}},m.prototype._addDataProviderEventListeners=function(){var e=this._dataProvider;if(e){var t=this._handleDataProviderEvent.bind(this);this._savedDataProviderEH=t,e.addEventListener("mutate",t),e.addEventListener("refresh",t)}},m.prototype._removeDataProviderEventListeners=function(){var e=this._dataProvider,t=this._savedDataProviderEH;e&&t&&(e.removeEventListener("mutate",t),e.removeEventListener("refresh",t)),this._savedDataProviderEH=void 0},m.prototype._handleDataProviderEvent=function(e){var t=this._addBusyStateFunc("LovDropdown handling data provider event");u.getContext(this._containerElem[0]).getBusyContext().whenReady().then(function(){t()},function(e){o.warn("Select: LovDropdown.handleDataProviderEvent busyContext promise rejected: "+e),t()})},m.prototype.close=function(){var t=document.activeElement;e.DomUtils.isAncestor(this.getElement(),t)&&t.blur(),this._clearSelection();var i={};i[e.PopupService.OPTION.POPUP]=this._containerElem,e.PopupService.getInstance().close(i),this._containerElem.detach(),this._dispatchEvent("dropdownClosed")},m.prototype.open=function(){var t=this._containerElem;t[0]!==this._bodyElem.children().last()[0]&&t.appendTo(this._bodyElem);var i={};i[e.PopupService.EVENT.POPUP_CLOSE]=function(){this._dispatchEvent("closeDropdown",{trigger:"popupCloseEvent"})}.bind(this),i[e.PopupService.EVENT.POPUP_REMOVE]=this._surrogateRemoveHandler.bind(this),i[e.PopupService.EVENT.POPUP_AUTODISMISS]=this._clickAwayHandler.bind(this),i[e.PopupService.EVENT.POPUP_REFRESH]=function(){this._dispatchEvent("sizeDropdown"),this._dispatchEvent("adjustDropdownPosition",{popupElem:t[0]})}.bind(this),i[e.PopupService.EVENT.POPUP_AFTER_OPEN]=function(e){var t=e.popup[0];this._dispatchEvent("sizeDropdown"),this._dispatchEvent("adjustDropdownPosition",{popupElem:t}),this._fullScreenPopup&&t.scrollIntoView()}.bind(this);var n={};n[e.PopupService.OPTION.POPUP]=t,n[e.PopupService.OPTION.EVENTS]=i,n[e.PopupService.OPTION.LAYER_SELECTORS]="oj-listbox-drop-layer",n[e.PopupService.OPTION.CUSTOM_ELEMENT]=!0,this._fullScreenPopup&&(n[e.PopupService.OPTION.MODALITY]=e.PopupService.MODALITY.MODAL),this._dispatchEvent("openPopup",{psOptions:n})},m.prototype._clickAwayHandler=function(e){var i=this._containerElem,n=t(e.target);if(!n.closest(i).length&&!n.closest("#"+t.escapeSelector(i.attr("data-oj-containerid"))).length){var r=i.closest(".oj-listbox-drop-layer");r.length>0&&n.closest(r).length>0||i.length>0&&this._dispatchEvent("closeDropdown",{trigger:"clickAway"})}},m.prototype._surrogateRemoveHandler=function(){this._containerElem&&this._containerElem.remove()},m.prototype._handleKeyDown=function(e){e.which===f.KEYS.TAB?this._dispatchEvent("tabOut"):e.which===f.KEYS.ESC&&this._dispatchEvent("closeDropdown",{trigger:"escKeyDown"})},m.prototype._handleCollectionSelectedItemChanged=function(e,t){if(!this._duringListViewInitialization){var i=f.isValueItemForPlaceholder(e)?null:e;this._collectionContext.selectedItem=i,this._handleSelection(i,t)}},m.prototype._handleCollectionCurrentRowChanged=function(e){this._duringListViewInitialization||null==e||(this._collectionContext.currentRow={rowIndex:e.rowIndex,rowKey:e.rowKey},this._handleCollectionCurrentRowKeyChanged(e.rowKey))},m.prototype._handleCollectionCurrentRowKeyChanged=function(e){this._duringListViewInitialization||null==e||(this._collectionContext.currentRow.rowKey=e,this._setCollectionSelectedKeySet(e))},m.prototype._handleRowAction=function(e,t){var i=this._createValueItemFromItem(e.detail.context);this._handleSelection(i,e)},m.prototype._handleSelection=function(e,t){e&&this._dispatchEvent("handleSelection",{valueItem:e,event:t})},m.prototype._createCollectionTemplateContext=function(e,t){var i={};if(e){i.data=t.data,i.searchText=t.searchText,e.defineTrackableProperty(i,"selected"),e.defineTrackableProperty(i,"selectedItem",void 0,t.selectedItemChangedListener);let n={};e.defineTrackableProperty(n,"rowKey",void 0,t.currentRowKeyChangedListener),e.defineTrackableProperty(i,"currentRow",n,t.currentRowChangedListener),i.handleRowAction=t.handleRowAction}else o.error("JET Select: template engine not available when creating context for collectionTemplate");return i},m.prototype._createValueItemFromItem=function(e){return null==e.data||null==e.metadata?null:{key:e.metadata.key,data:e.data,metadata:{key:e.metadata.key}}},m.prototype._setCollectionSelectedKeySet=function(e){var t;t=null!=e?new h.KeySetImpl([e]):new h.KeySetImpl([]),this._collectionContext.selected=t,null!=this._collectionTemplateContext?this._collectionTemplateContext.selected=t:null==this._collectionTemplate&&this._resultsElem[0].setProperty("selected",t)},m.prototype._setCollectionCurrentRow=function(e){this._collectionContext.currentRow={rowIndex:e.rowIndex,rowKey:e.rowKey},null!=this._collectionTemplateContext?(this._addListenerForRowKeyProperty(e),this._collectionTemplateContext.currentRow=e):null==this._collectionTemplate&&this._resultsElem[0].setProperty("currentItem",e.rowKey)},m.prototype.getValueItemForSelection=function(){var e=this._collectionContext.currentRow.rowKey,t=this._currentFirstItem,i=this._collectionContext.selectedItem;if(null!=e){let i={};return i.key=e,t&&t.key===e&&(i.data=t.data,i.metadata=t.metadata),i}return i},m.prototype.getResultsCount=function(){return this._resultsCount},m.prototype._setCurrentFirstItem=function(e){this._currentFirstItem=e},m.prototype._addListenerForRowKeyProperty=function(e){var t=this._collectionContext,i=e.rowKey;this._templateEngine&&this._templateEngine.defineTrackableProperty(e,"rowKey",i,t.currentRowKeyChangedListener)};var y=function(e){this._addBusyStateFunc=e.addBusyStateFunc,this._forceReadOnly=e.forceReadOnly,this._createOrUpdateReadonlyDivFunc=e.createOrUpdateReadonlyDivFunc,this._containerElem=this._createInnerDom(e);var i=t(this._containerElem).find("input."+e.className+"-input");this._inputElem=i[0]};y.prototype.getElement=function(){return this._containerElem},y.prototype.getInputElem=function(){return this._inputElem},y.prototype.getInputText=function(){return this._inputElem.value||""},y.prototype._createInnerDom=function(e){var t=e.className,i=e.idSuffix,n=e.inputType,r=e.enabled,o=e.readOnly,a=e.ariaLabel,s=e.ariaControls,l=e.cachedMainFieldInputElement,d=document.createElement("div");d.setAttribute("class","oj-text-field-container"),d.setAttribute("role","presentation");var u=document.createElement("div");u.setAttribute("class","oj-text-field-middle"),d.appendChild(u);var c=l||document.createElement("input");return c.setAttribute("id",t+"-input-"+i),c.setAttribute("autocomplete","off"),c.setAttribute("autocorrect","off"),c.setAttribute("autocapitalize","off"),c.setAttribute("spellcheck","false"),c.setAttribute("class",t+"-input oj-text-field-input"),c.setAttribute("aria-autocomplete","list"),c.setAttribute("placeholder",e.placeholder),c.disabled=!r&&!o,(o||this._forceReadOnly&&r)&&c.setAttribute("readonly","true"),o||(c.setAttribute("role","combobox"),c.setAttribute("aria-expanded","false")),a&&c.setAttribute("aria-label",a),s&&c.setAttribute("aria-controls",s),null!==n&&""!==n?c.setAttribute("type",n):c.setAttribute("type","text"),u.appendChild(c),e.endContent&&d.appendChild(e.endContent),o&&this._createOrUpdateReadonlyDivFunc(c),d},y.prototype.updateLabel=function(e,t){e?(this._inputElem.setAttribute("aria-labelledby",e),this._inputElem.removeAttribute("aria-label")):t&&(this._inputElem.setAttribute("aria-label",t),this._inputElem.removeAttribute("aria-labelledby"))};var b=function(e){this._minLength=0,this._className=e.className,this._dataProvider=e.dataProvider,this._containerElem=e.containerElem,this._fullScreenPopup=e.fullScreenPopup,this._idSuffix=e.idSuffix,this._enabled=e.enabled,this._readonly=e.readOnly,this._value=e.value,this._getTranslatedStringFunc=e.getTranslatedStringFunc,this._addBusyStateFunc=e.addBusyStateFunc,this._lovMainField=e.lovMainField,this._filterInputText=e.filterInputText,this._lovDropdown=e.lovDropdown,this._liveRegion=e.liveRegion,this._showMainFieldFunc=e.showMainFieldFunc,this._setFilterFieldTextFunc=e.setFilterFieldTextFunc,this._setUiLoadingStateFunc=e.setUiLoadingStateFunc,this._lastDataProviderPromise=null,this._fetchType=this.hasData()?"init":null};b.prototype.setValue=function(e){this._value=e},b.prototype.getFetchType=function(){return this._fetchType},b.prototype.destroy=function(){var e=this._closeDelayTimer;isNaN(e)||(delete this._closeDelayTimer,window.clearTimeout(e)),this.closeDropdown()},b.prototype.hasData=function(){return null!=this._dataProvider},b.prototype.isDropdownOpen=function(){return t(this._containerElem).hasClass("oj-listbox-dropdown-open")},b.prototype._usingHandler=function(i,n){if(e.PositionUtils.isAligningPositionClipped(n)){var r=this._addBusyStateFunc("closing popup");this._closeDelayTimer=window.setTimeout(function(){this.closeDropdown(),r()}.bind(this),1)}else{var o=t(this._containerElem),a=n.element.element;a.css(i),"bottom"===n.vertical?(o.addClass("oj-listbox-drop-above"),a.addClass("oj-listbox-drop-above")):(o.removeClass("oj-listbox-drop-above"),a.removeClass("oj-listbox-drop-above"))}},b.prototype.getDropdownPosition=function(){var t;if(this._fullScreenPopup){var i=window.scrollX||window.pageXOffset,n=window.scrollY||window.pageYOffset;t={my:"start top",at:"start top",of:window,offset:{x:i,y:n}}}else t={my:"start top",at:"start bottom",of:this._lovMainField.getElement(),collision:"flip",using:this._usingHandler.bind(this)};var r="rtl"===e.DomUtils.getReadingDirection();return e.PositionUtils.normalizeHorizontalAlignment(t,r)},b.prototype.sizeDropdown=function(){var e=this._lovDropdown.getElement();if(this._fullScreenPopup){var i=Math.min(window.innerWidth,window.screen.availWidth),r=Math.min(window.innerHeight,window.screen.availHeight);if("phone"===n.getDeviceType()&&window.parent&&window!==window.parent){var o=Math.min(window.parent.innerHeight,window.parent.screen.availHeight),a=Math.min(r,o);if(r>a){var s=r-a;e.style.paddingBottom=s+"px"}}e.style.width=i+"px",e.style.height=r+"px"}else e.style.minWidth=t(this._containerElem).width()+"px"},b.prototype.adjustDropdownPosition=function(e){if(!this._fullScreenPopup){var i,n=t(e),r=e.getBoundingClientRect(),o=this._containerElem.getBoundingClientRect(),a=Math.min(window.innerWidth,window.screen.availWidth),s=n.css("left"),l=parseFloat(s);if(r.left>=o.left)i=a-r.left-10,n.css("left",l+"px");else{i=o.right-10;var d=n.css("width"),u=parseFloat(d);if(u>i){var c=u-i;n.css("left",l+c+"px")}else if(r.left+r.width<o.left+o.width){var h=o.left+o.width-(r.left+r.width);n.css("left",l+h+"px")}}n.css("max-width",i+"px")}},b.prototype.openDropdown=function(e){if(this.isDropdownOpen()||!1===this._enabled||!0===this._readonly)return!1;if(this._fullScreenPopup){var i=this._lovMainField.getInputElem();this._setFilterFieldTextFunc(i.value)}return t(this._containerElem).addClass("oj-listbox-dropdown-open"),e||this.updateResults(!0,this._fullScreenPopup),!0},b.prototype.closeDropdown=function(){if(this.isDropdownOpen()){var e=t(this._containerElem);e.removeClass("oj-listbox-dropdown-open"),this._ariaExpanded&&(e.removeClass("oj-listbox-drop-above"),t(this._lovDropdown.getElement()).removeClass("oj-listbox-drop-above"),this._lovDropdown.close(),this._ariaExpanded=!1,this._lovMainField.getInputElem().setAttribute("aria-expanded","false"),this._lastSearchTerm=null)}},b.prototype.updateResults=function(e,t){var i;i=!0===e?"":this._filterInputText.rawValue||"";var n=this._lastSearchTerm;!0!==e&&n&&i===n||(this._lastSearchTerm=i,i.length>=this._minLength?e&&!0!==e?this._runQuery(i,t):this._runQuery(i,t,!0===e):this.closeDropdown())},b.prototype._runQuery=function(t,i,n){var r=this._lovDropdown;if(this._minLength>t.length)this.closeDropdown();else if(this.openDropdown(!0),this.hasData()){this._ariaExpanded||(r.open(),this._ariaExpanded=!0,this._lovMainField.getInputElem().setAttribute("aria-expanded","true")),i&&e.FocusUtils.focusFirstTabStop(r.getElement());var a=this._fetchFromDataProvider(t,n);a.then(function(){a===this._lastDataProviderPromise&&this._handleQueryResultsFetch()}.bind(this),function(e){a===this._lastDataProviderPromise&&(o.warn("Select: _fetchFromDataProvider promise was rejected: "+e),this._handleQueryResultsFetch())}.bind(this))}},b.prototype._handleQueryResultsFetch=function(){if(this.isDropdownOpen()){var e,t=this._lovDropdown.getResultsCount(),i=t?t.count:0,n=!t||t.done;0===i?e=this._getTranslatedStringFunc("noMatchesFound"):(this.sizeDropdown(),e=n?this._getTranslatedStringFunc("multipleMatchesFound",{num:String(i)}):this._getTranslatedStringFunc("nOrMoreMatchesFound",{num:String(i)})),this.updateLiveRegion(e)}},b.prototype.updateLiveRegion=function(e){t(this._liveRegion).text(e)},b.prototype.cancel=function(){this.closeDropdown()},b.prototype.handleDataProviderEvent=function(e){this._lastSearchTerm=null},b.prototype._fetchFromDataProvider=function(t,i){var n=!1,r=this._addBusyStateFunc("fetching data");"init"===this._fetchType&&(this.isDropdownOpen()||(n=!0,this._setUiLoadingStateFunc("start")),this._fetchType=null);var a=null;if(t){if(this._dataProvider){var s=this._dataProvider.getCapability("filter");s&&s.textFilter||o.error("Select: DataProvider does not support text filter.  Filtering results in dropdown may not work correctly.")}a=e.FilterFactory.getFilter({filterDef:{text:t}})}var l=new Promise(function(e,s){var d=this._lovDropdown.renderResults(t,a,f.isValueForPlaceholder(this._value)?null:this._value,i),u=function(){n&&this._setUiLoadingStateFunc("stop"),r(),l===this._lastDataProviderPromise?e():s("AbstractLovBase._fetchFromDataProvider: rejecting earlier promise")}.bind(this);d.then(function(){u()},function(e){l===this._lastDataProviderPromise&&o.warn("Select: renderResults promise was rejected: "+e),u()})}.bind(this));return this._lastDataProviderPromise=l,l},e.__registerWidget("oj.ojSelect2",t.oj.editableValue,{defaultElement:"<input>",widgetEventPrefix:"oj",_ALLOWED_INPUT_TYPES:["email","number","search","tel","text","url"],options:{placeholder:"",data:null,required:!1,virtualKeyboard:"search",readOnly:!1,valueItem:{key:null,data:null,metadata:null},itemText:"label",labelledBy:null},widget:function(){return t(this.OuterWrapper)},_ComponentCreate:function(){this._super(),this._cssOptionDefaults=a.parseJSONFromFontFamily("oj-searchselect-option-defaults")||{},this._fullScreenPopup="phone"===n.getDeviceRenderMode(),this._valueForPlaceholder=null,this._valueItemForPlaceholder={key:null,data:null,metadata:null},this._setupSelectResources()},_AfterCreate:function(){this._super(),this._initInputIdLabelForConnection(this._GetContentElement()[0],this.OuterWrapper.id,this.options.labelledBy);var e=this._getRootElement();this._focusable({element:e,applyHighlight:!1,afterToggle:this._handleAfterFocusToggle.bind(this,e)}),"none"===this.options.labelEdge&&this._updateLabel()},_IsTextFieldComponent:function(){return!0},_GetContentWrapper:function(){return this._lovMainField.getElement().querySelector(".oj-text-field-middle")},_handleAfterFocusToggle:function(e,t){"focusout"===t&&this._abstractLovBase.isDropdownOpen()&&e.classList.add("oj-focus")},_IsRequired:function(){return this.options.required},_labelledByUpdatedForInputComp:e.EditableValueUtils._labelledByUpdatedForInputComp,_initInputIdLabelForConnection:e.EditableValueUtils._initInputIdLabelForConnection,_linkLabelForInputComp:e.EditableValueUtils._linkLabelForInputComp,_AfterSetOptionRequired:e.EditableValueUtils._AfterSetOptionRequired,_GetTranslationsSectionName:function(){return"oj-ojSelectSingle"},_getTemplateSlot:function(t){var i=e.BaseCustomElementBridge.getSlotMap(this.OuterWrapper)[t];return i&&i[0]&&"TEMPLATE"===i[0].tagName?i[0]:null},_setupSelectResources:function(e){this._loadingIndicatorCount=0;for(var i=this.OuterWrapper,n=i.childNodes,r=[],o=0;o<n.length;o++)r.push(n[o]);var a=this.options;this._wrapDataProviderIfNeeded(a.data),this._addDataProviderEventListeners(),this._SetInputType(this._ALLOWED_INPUT_TYPES);var s=this,l=function(){return s.getTranslatedString.apply(s,arguments)},d=function(e){return f.addBusyState(i,e)},u=i.getAttribute("id");u||(u="oj-selectsingle-"+f.nextUid(),i.setAttribute("id",u));var c=u;this._idSuffix=u;var h=!a.disabled;this._lovEnabled=h;var p=a.readOnly||!1,_=this.element;_.prop("disabled",!(h&&!p));var v=this._cssOptionDefaults.showIndicatorDelay;v=parseInt(v,10),v=isNaN(v)?250:v,this._showIndicatorDelay=v;var g=_.attr("type");this._resolveValueItemLater=!1;var E="oj-searchselect";this._className=E,this._initContainer(E,c,p);var w=new y({className:E,ariaLabel:i.getAttribute("aria-label"),ariaControls:i.getAttribute("aria-controls"),idSuffix:c,inputType:g,enabled:h,readOnly:p,placeholder:a.placeholder,addBusyStateFunc:d,forceReadOnly:this._fullScreenPopup,endContent:this._createMainFieldEndContent(h,p),cachedMainFieldInputElement:e,createOrUpdateReadonlyDivFunc:this._createOrUpdateReadonlyDiv.bind(this)});this._lovMainField=w,this._initLovMainField(w);var S=w.getElement();i.appendChild(S);var F=this._createFilterInputText(E,c);this._fullScreenPopup||(F.style.visibility="hidden",i.appendChild(F)),this._filterInputText=F;var P=new m;this._initLovDropdownFunc=function(e){var n=function(t){this._fullScreenPopup&&F.setAttribute("aria-controls",t.id),e&&e()}.bind(this);this._initLovDropdown(c,g,u,l,d,n);var r=P.getElement();i.appendChild(r),r.addEventListener("lovDropdownEvent",this._handleLovDropdownEvent.bind(this)),t(w.getInputElem()).attr("aria-owns",r.id)}.bind(this),this._lovDropdown=P;var C=new b({className:E,dataProvider:this._wrappedDataProvider,containerElem:i,fullScreenPopup:this._fullScreenPopup,idSuffix:c,lovMainField:w,filterInputText:F,lovDropdown:P,liveRegion:this._liveRegion,enabled:h,readOnly:p,value:a.value,getTranslatedStringFunc:l,addBusyStateFunc:d,showMainFieldFunc:this._showMainField.bind(this),setFilterFieldTextFunc:this._setFilterFieldText.bind(this),setUiLoadingStateFunc:this._setUiLoadingState.bind(this)});this._abstractLovBase=C,_.attr("tabindex","-1").hide().attr("aria-hidden",!0),C.hasData()&&this._initSelectedValue(a.valueItem),this._refreshRequired(a.required),this._resolveValueItemLater=this._mergeValueAndValueItem(a.value,a.valueItem),this._updateLabel();for(var D=0;D<r.length;D++)i.appendChild(r[D])},_releaseSelectResources:function(e){for(var i=this._loadingIndicatorCount;i>=0;i--)this._setUiLoadingState("stop");this._loadingIndicatorCount=0,this._savedLoadingIndicator=!1,this._deferredSetDisplayValue=null,this._clearMainFieldFocusHandlerTimer(),t(this._filterInputText).remove(),e&&(t(this._lovMainField.getInputElem()).detach(),this._cleanUpMainFieldInputElement(),t(this._lovMainField.getInputElem()).off(this._lovMainFieldInputEventListeners)),t(this._lovMainField.getElement()).remove(),t(this._liveRegion).remove(),this._abstractLovBase.destroy(),this._lovDropdown.getElement()&&(t(this._lovDropdown.getElement()).remove(),this._lovDropdown.destroy());var n=this.OuterWrapper,r=n.classList;r.remove(this._className),r.remove("oj-form-control"),r.remove("oj-component"),r.remove("oj-read-only"),r.remove("oj-enabled"),r.remove("oj-disabled"),t(n).off("change","."+this._className+"-input",f.stopEventPropagation).off(this._containerEventListeners),this._containerEventListeners=null,this.element.removeAttr("aria-hidden tabindex").show();var o=this._$labelElem;o.attr("for",o.attr("data-oj-lov-for")),o.removeAttr("data-oj-lov-for"),this._$labelElem=null,this._removeDataProviderEventListeners(),this._wrappedDataProvider=null,this._liveRegion=null,this._abstractLovBase=null,this._lovMainField=null,this._filterInputText=null,this._lovDropdown=null},_cleanUpMainFieldInputElement:function(){var t=this._lovMainField.getInputElem();if(e.AgentUtils.getAgentInfo().browser===e.AgentUtils.BROWSER.IE)t.removeAttribute("readonly"),t.removeAttribute("role"),t.removeAttribute("type"),t.removeAttribute("aria-controls"),t.removeAttribute("aria-expanded"),t.removeAttribute("aria-label"),t.removeAttribute("aria-labelledby");else for(;t.hasAttributes();){var i=t.attributes[0].name;t.removeAttribute(i)}t.value=""},_updateLabel:function(){var e=this._GetLabelElement()||t();this._$labelElem=e;var i,n,r=this.options,o=this._lovMainField,a=this._lovDropdown,s=this._filterInputText;if(e.length>0?(e.attr("id")||e.attr("id",this._className+"-label-"+this._idSuffix),e.attr("data-oj-lov-for",e.attr("for")),i=e.attr("id")):r.labelledBy&&(i=r.labelledBy),e.length>0){var l=t(o.getInputElem());e.attr("for",l.attr("id"))}if(e.length>0)i||(n=e.text());else{var d=this.OuterWrapper.getAttribute("aria-label");d&&(n=d)}a.updateLabel(i,n),o.updateLabel(i,n),i?(s.setAttribute("labelled-by",i),s.setAttribute("aria-label","")):n&&(s.setAttribute("aria-label",n),s.setAttribute("labelled-by",""))},_initContainer:function(e,i,n){var r=this.OuterWrapper,o=t(r),a=r.classList;a.add(e),a.add("oj-form-control"),a.add("oj-component"),n?a.add("oj-read-only"):a.add(this._lovEnabled?"oj-enabled":"oj-disabled"),this._fullScreenPopup?a.add("oj-searchselect-mobile"):a.remove("oj-searchselect-mobile"),this._toggleNoValueStyleClass();var s=document.createElement("div");s.setAttribute("id","oj-listbox-live-"+i),s.setAttribute("class","oj-helper-hidden-accessible oj-listbox-liveregion"),s.setAttribute("aria-live","polite"),r.appendChild(s),o.on("change","."+e+"-input",f.stopEventPropagation),this._containerEventListeners={click:f.killEvent,keydown:this._handleContainerKeyDown.bind(this),mouseup:function(){o.removeClass("oj-active")}},o.on(this._containerEventListeners),this._liveRegion=s},_toggleNoValueStyleClass:function(){var e=this.OuterWrapper.classList;f.isValueForPlaceholder(this.options.value)?e.add("oj-searchselect-no-value"):e.remove("oj-searchselect-no-value")},_setFilterFieldText:function(e){this._ignoreFilterFieldRawValueChanged=!0,this._filterInputText.value=e,this._filterInputText.refresh(),this._ignoreFilterFieldRawValueChanged=!1},_showFilterField:function(t){if(!this._fullScreenPopup){var i=this._filterInputText;if("hidden"===i.style.visibility){var n=this._lovMainField,r=n.getInputElem();t||(this._setFilterFieldText(r.value),f.copyAttribute(r,"aria-describedby",i,"described-by"));var o=this._getFilterInputElem();o&&(o.setAttribute("role","combobox"),t||(f.copyAttribute(r,"aria-required",o,"aria-required"),f.copyAttribute(r,"aria-invalid",o,"aria-invalid"))),n.getInputElem().style.visibility="hidden",i.style.visibility="",this.OuterWrapper.appendChild(i)}if(!t)if(e.AgentUtils.getAgentInfo().browser===e.AgentUtils.BROWSER.IE){var a=f.addBusyState(this.OuterWrapper,"Select transferring focus to filter field");setTimeout(function(){i.focus(),a()},0)}else i.focus()}},_showMainField:function(){if(!this._fullScreenPopup){var e=this._filterInputText;if("hidden"!==e.style.visibility){var t=this._lovMainField.getInputElem();t.setSelectionRange(1e6,1e6),t.style.visibility="",e.style.visibility="hidden"}}},_isFilterInputTextCleared:function(){var e=this._filterInputText.rawValue;return null==e||""===e},_handleContainerKeyDown:function(t){if(this._lovEnabled&&!this.options.readOnly&&!f.isControlOrFunctionKey(t))if(t.which!==f.KEYS.PAGE_UP&&t.which!==f.KEYS.PAGE_DOWN){var i,n=this._abstractLovBase,r=this._lovDropdown;switch(t.which){case f.KEYS.UP:case f.KEYS.DOWN:if(n.isDropdownOpen())if(e.FocusUtils.focusFirstTabStop(r.getElement()),this.OuterWrapper.classList.add("oj-focus"),e.AgentUtils.getAgentInfo().browser===e.AgentUtils.BROWSER.IE){var o=f.addBusyState(this.OuterWrapper,"Select showing filter field while arrowing into dropdown");setTimeout(function(){this._showFilterField(!0),o()}.bind(this),0)}else this._showFilterField(!0);else this._openDropdown();t.preventDefault();break;case f.KEYS.ENTER:t.preventDefault(),!this._fullScreenPopup&&this._isFilterInputTextCleared()?this._handleSelection(this._valueItemForPlaceholder):!this._fullScreenPopup&&n.isDropdownOpen()&&null!=(i=r.getValueItemForSelection())&&this._fetchDataAndSelect(i,t);break;case f.KEYS.TAB:if(!this._fullScreenPopup){if(t.shiftKey)for(var a=this._filterInputText,s=a.parentNode;s.firstChild!==a;)s.appendChild(s.firstChild);this._isFilterInputTextCleared()?this._handleSelection(this._valueItemForPlaceholder):n.isDropdownOpen()&&null!=(i=r.getValueItemForSelection())&&this._fetchDataAndSelect(i,t)}this._closeDropdown();break;case f.KEYS.ESC:n.isDropdownOpen()&&(n.cancel(),t.preventDefault())}}else t.preventDefault()},_handleContainerMouseDown:function(i){var n=this._abstractLovBase;this._lovEnabled||i.preventDefault();var r=this.OuterWrapper,o=t(r),a=!1;if(r.classList.contains("oj-form-control-label-top")){var s=o.children(".oj-label");s.length>0&&e.DomUtils.isAncestorOrSelf(s[0],i.target)&&(a=!0)}var l=0===i.button,d=!1;if(l&&!this.options.readOnly){if(this._fullScreenPopup){var u=r.querySelector(".oj-searchselect-clear-value");if(u&&e.DomUtils.isAncestorOrSelf(u,i.target))return}n.isDropdownOpen()||!this._lovEnabled||a||(this._openDropdown(),this._fullScreenPopup&&i.preventDefault())}a||(o.addClass("oj-active"),l&&(!this._fullScreenPopup&&this._lovEnabled&&("hidden"===this._filterInputText.style.visibility?(d=!0,this._lovMainField.getInputElem().focus()):this.options.readOnly||(i.target===this._getFilterInputElem()&&(d=!0),this._showFilterField())),d||i.preventDefault()))},_handleLovDropdownEvent:function(i){var n=i.detail,r=this._abstractLovBase;switch(n.subtype){case"closeDropdown":"escKeyDown"===n.trigger?this._filterInputText.focus():"clickAway"===n.trigger&&(this._showMainField(),this.OuterWrapper.classList.remove("oj-focus")),this._closeDropdown();break;case"tabOut":if(this._filterInputText.focus(),!this._fullScreenPopup){let e=this._lovDropdown.getValueItemForSelection();null!=e&&this._fetchDataAndSelect(e,i)}break;case"sizeDropdown":r.sizeDropdown();break;case"adjustDropdownPosition":var o=r.getDropdownPosition();t(n.popupElem).position(o),r.adjustDropdownPosition(n.popupElem);break;case"openPopup":var a=n.psOptions;a[e.PopupService.OPTION.LAUNCHER]=this.element,a[e.PopupService.OPTION.POSITION]=r.getDropdownPosition(),e.PopupService.getInstance().open(a);break;case"handleSelection":this._handleSelection(n.valueItem,n.event);break;case"dropdownClosed":this._searchTextOnKeyDown=void 0}},_fetchDataAndSelect:function(e,t){if(null!=e.data)this._handleSelection(e,t);else{var i=[e.key],n=function(){this._handleSelection(this._valueItemForPlaceholder)}.bind(this),r=function(i){if(i.data.length>0){var r={};r.key=e.key,r.data=i.data[0],r.metadata=i.metadata[0],this._handleSelection(r,t)}else n()}.bind(this);this._fetchByKeysFromDataProvider(i).then(r,n)}},_handleSelection:function(e,t){var i=f.isValueItemForPlaceholder(e)?this._valueItemForPlaceholder:e;if(this._handleUserSelectedValueItem(i,t,void 0),!t||"blur"!==t.type){var n=this._lovMainField.getInputElem();this._fullScreenPopup?n.focus():(f.isValueItemForPlaceholder(i)&&(n.value=""),this._setFilterFieldText(n.value),this._showFilterField())}this._closeDropdown()},_closeDropdown:function(){var e=this._lovDropdown.getElement();if(null!=e){var t=f.addBusyState(this.OuterWrapper,"Select waiting for dropdown busy context before closing dropdown"),i=function(){t(),this._abstractLovBase.closeDropdown()}.bind(this);u.getContext(e).getBusyContext().whenReady().then(i,function(e){o.warn("Select: dropdown busy context rejected when closing dropdown: "+e),i()})}},_handleUserSelectedValueItem:function(e,t,i){var n=this._abstractLovBase;this._cachedFetchByKeys&&(this._valueHasChanged=!0,this._setUiLoadingState("stop")),this._resolveValueItemLater=!0;var r=null;f.isValueItemForPlaceholder(e)||(r=e.key),n.setValue(r),this._userSelectedValueItem=e;var o=this._SetValue(r,t,{doValueChangeCheck:!1,_context:i}),a=function(){this._userSelectedValueItem=null}.bind(this);o instanceof Promise?o.then(a,a):a()},_createMainFieldEndContent:function(e,t){var i=document.createElement("span"),n=this._createDropdownIcon(e,t);if(i.appendChild(n),this._fullScreenPopup){var r=this._createClearValueIcon();i.appendChild(r)}return i},_createDropdownIcon:function(e,t){var i=this._className,n=document.createElement("a"),r=i+"-arrow "+i+"-open-icon "+i+"-icon oj-component-icon oj-clickable-icon-nocontext";t||e||(r+=" oj-disabled"),n.setAttribute("class",r),n.setAttribute("role","presentation");var o=this.getTranslatedString("labelAccOpenDropdown");return n.setAttribute("aria-label",o),n},_createClearValueIcon:function(){var e=this._className,t=document.createElement("a"),i=e+"-clear-value "+e+"-clear-value-icon "+e+"-icon oj-component-icon oj-clickable-icon-nocontext";t.setAttribute("class",i),t.setAttribute("role","button");var n=this.getTranslatedString("labelAccClearValue");return t.setAttribute("aria-label",n),t.addEventListener("click",function(){this._handleSelection(this._valueItemForPlaceholder)}.bind(this)),t},_initLovMainField:function(e){this._lovMainFieldInputEventListeners={focus:function(e){if(f.killEvent(e),!this._fullScreenPopup&&!this.options.readOnly){this._clearMainFieldFocusHandlerTimer();var t=f.addBusyState(this.OuterWrapper,"Select showing filter field after focusing main field");this._mainFieldFocusHandlerTimer=c.getTimer(0),this._mainFieldFocusHandlerTimer.getPromise().then(function(e){e&&(this._mainFieldFocusHandlerTimer=null,this._showFilterField(),this._transferSelectionRangeToFilterField()),t()}.bind(this))}}.bind(this)},t(e.getInputElem()).on(this._lovMainFieldInputEventListeners),t(e.getElement()).on({mousedown:this._handleContainerMouseDown.bind(this)})},_clearMainFieldFocusHandlerTimer:function(){this._mainFieldFocusHandlerTimer&&(this._mainFieldFocusHandlerTimer.clear(),this._mainFieldFocusHandlerTimer=null)},_transferSelectionRangeToFilterField:function(){var e=this._lovMainField.getInputElem(),t=this._getFilterInputElem();t&&t.setSelectionRange(e.selectionStart,e.selectionEnd,e.selectionDirection)},_getFilterInputElem:function(){var e=t(this._filterInputText).find("input");return e.length>0?e[0]:null},_createFilterInputText:function(i,n){var r=this.OuterWrapper.getAttribute("aria-label"),o=this.OuterWrapper.getAttribute("aria-controls"),a=this.options,s=document.createElement("oj-input-text");if(s.setAttribute("display-options.messages","none"),s.setAttribute("user-assistance-density","compact"),s.setAttribute("id",i+"-filter-"+n),s.setAttribute("class",i+"-filter"),s.setAttribute("clear-icon",this._fullScreenPopup?"always":"never"),s.setAttribute("autocomplete","off"),s.setAttribute("aria-autocomplete","list"),s.setAttribute("data-oj-internal",""),s.setAttribute("data-oj-binding-provider","none"),a.placeholder&&s.setAttribute("placeholder",a.placeholder),r&&s.setAttribute("aria-label",r),!this._fullScreenPopup&&o&&s.setAttribute("aria-controls",o),s.setAttribute("virtual-keyboard",a.virtualKeyboard),this._fullScreenPopup){var l=this.getTranslatedString("cancel"),d=document.createElement("span");d.setAttribute("id","cancelButton_"+this._idSuffix),d.setAttribute("slot","start"),d.setAttribute("class",i+"-back-button"),d.setAttribute("aria-label",l),d.addEventListener("click",function(){this._lovMainField.getInputElem().focus(),this._abstractLovBase.cancel()}.bind(this)),s.appendChild(d);var u=document.createElement("span");u.setAttribute("class",i+"-back-icon "+i+"-icon oj-component-icon oj-clickable-icon-nocontext"),d.appendChild(u)}else{var c=document.createElement("a");c.setAttribute("class",i+"-arrow "+i+"-open-icon "+i+"-icon oj-component-icon oj-clickable-icon-nocontext"),c.setAttribute("slot","end"),c.style.visibility="hidden",s.appendChild(c)}var h=t(this.OuterWrapper);return s.addEventListener("rawValueChanged",function(e){this._ignoreFilterFieldRawValueChanged||this._updateResults(e)}.bind(this)),s.addEventListener("focus",function(){h.addClass("oj-focus")}),s.addEventListener("blur",function(t){h.removeClass("oj-focus"),this._fullScreenPopup||t.relatedTarget&&e.DomUtils.isAncestor(this._lovDropdown.getElement(),t.relatedTarget)||this._showMainField()}.bind(this)),this._fullScreenPopup||s.addEventListener("mousedown",this._handleContainerMouseDown.bind(this)),s},_initLovDropdown:function(e,i,n,r,o,a){this._lovDropdown.init({dataProvider:this._wrappedDataProvider,className:"oj-select",parentId:n,idSuffix:e,fullScreenPopup:this._fullScreenPopup,inputType:i,bodyElem:t(this.OuterWrapper).closest("body")[0],itemTemplate:this._getTemplateSlot("itemTemplate"),collectionTemplate:this._getTemplateSlot("collectionTemplate"),getTemplateEngineFunc:this._loadTemplateEngine.bind(this),templateContextComponentElement:this.OuterWrapper,getTranslatedStringFunc:r,addBusyStateFunc:o,itemTextRendererFunc:this._itemTextRenderer.bind(this),filterInputText:this._filterInputText,afterDropdownInitFunc:a})},_openDropdown:function(){var e=this._abstractLovBase;if(this._initLovDropdownFunc){var t=this._initLovDropdownFunc;this._initLovDropdownFunc=null,t(function(){e.openDropdown()})}else e.openDropdown()},_updateResults:function(e){var t=this._abstractLovBase;if(this._initLovDropdownFunc){var i=this._initLovDropdownFunc;this._initLovDropdownFunc=null,i(function(){t.updateResults(e)})}else t.updateResults(e)},_loadTemplateEngine:function(){if(!this._templateEngine){var e=f.addBusyState(this.OuterWrapper,"Select loading template engine");return new Promise(function(t,i){n.__getTemplateEngine().then(function(i){this._templateEngine=i,t(i),e()}.bind(this),function(t){i(new Error("Error loading template engine: "+t)),e()})}.bind(this))}return Promise.resolve(this._templateEngine)},_refreshRequired:e.EditableValueUtils._refreshRequired,_createOrUpdateReadonlyDiv:e.EditableValueUtils._createOrUpdateReadonlyDiv,_AriaRequiredUnsupported:function(){return!1},refresh:function(){var e=this._lovMainField.getInputElem();this._bSuperRefreshing=!0,this._super(),this._bSuperRefreshing=!1,this._releaseSelectResources(!0),this._setupSelectResources(e),this._initComponentMessaging(),this._deferredSetDisplayValue&&this._deferredSetDisplayValue()},_SetupResources:function(){this._super(),this._bReleasedResources&&(this._bReleasedResources=!1,this._setupSelectResources(),this._initComponentMessaging())},_ReleaseResources:function(){this._super(),this._bReleasedResources=!0,this._releaseSelectResources()},_setOptions:function(e,t){this._processSetOptions={},this._super(e,t);var i=this._processSetOptions;this._processSetOptions=null,i&&(i.forRefresh&&i.forRefresh(),i.value&&i.value())},_setOption:function(e,t,i){var n=this._abstractLovBase;if(this._super(e,t,i),"valueItem"===e)this._syncValueWithValueItem(t,this.options.value);else if("value"===e){var r=function(){n.setValue(t),f.isValueForPlaceholder(t)?this._setValueItem(this._valueItemForPlaceholder):this._updateValueItem(t),this._SetDisplayValue()}.bind(this);this._processSetOptions?this._processSetOptions.value=r:r()}else if("disabled"===e||"readOnly"===e||"placeholder"===e||"data"===e||"itemText"===e){var o=function(){this.refresh()}.bind(this);this._processSetOptions?this._processSetOptions.forRefresh=o:o()}else if("labelledBy"===e){if(this.options.labelledBy){var a=this._GetContentElement()[0].id;this._labelledByUpdatedForInputComp(this.options.labelledBy,a)}this._updateLabel()}},_AfterSetOption:function(e,t){switch(this._superApply(arguments),e){case"required":this._AfterSetOptionRequired(e);break;case"virtualKeyboard":this._SetInputType(this._ALLOWED_INPUT_TYPES),this.refresh();break;case"labelHint":case"labelEdge":this._updateLabel()}},_AfterSetOptionValue:function(e,t){this._superApply(arguments),"value"===e&&this._toggleNoValueStyleClass()},_NotifyDetached:function(){this._superApply(arguments),this._abstractLovBase.closeDropdown()},_NotifyHidden:function(){this._superApply(arguments),this._abstractLovBase.closeDropdown()},_VerifyConnectedForSetup:function(){return!0},_SetInputType:e.EditableValueUtils._SetInputType,_SetDisplayValue:function(e){this._bSuperRefreshing?this._deferredSetDisplayValue=function(){this._deferredSetDisplayValue=null,this._SetDisplayValue(e)}.bind(this):(this._applyValueItem(this.options.valueItem)||this._initSelectedValue(),this._resolveValueItemLater=!1)},validate:function(){var e=t(this._lovMainField.getInputElem()).val(),i=this._SetValue(e,null,this._VALIDATE_METHOD_OPTIONS);return i=i instanceof Promise?i.then(function(e){return Promise.resolve(e?"valid":"invalid")}):Promise.resolve(i?"valid":"invalid")},_SetValue:function(e,t,i){return e===this._GetDisplayValue()&&void 0===(e=this.options.value)&&(e=null),this._super(e,t,i)},_NotifyContextMenuGesture:function(e,t,i){var n=this._GetMessagingLauncherElement();this._OpenContextMenu(t,i,{launcher:n})},_GetContentElement:function(){return this._lovMainField?t(this._lovMainField.getInputElem()):this.element},_GetDefaultStyleClass:function(){return"oj-select"},_isDataProvider:function(t){return!(!t||!e.DataProviderFeatureChecker)&&e.DataProviderFeatureChecker.isDataProvider(t)},_isTreeDataProvider:function(t){return!(!t||!e.DataProviderFeatureChecker)&&e.DataProviderFeatureChecker.isTreeDataProvider(t)},_wrapDataProviderIfNeeded:function(e){if(this._isDataProvider(e)){var t=e;this._isTreeDataProvider(e)?e instanceof d||(t=new d(e)):(e instanceof l||(t=new l(e)),t=new s(t)),t=new _(t),this._wrappedDataProvider=t}else this._wrappedDataProvider=new _},_addDataProviderEventListeners:function(){var e=this._wrappedDataProvider;if(e){this._removeDataProviderEventListeners();var t=this._handleDataProviderEvent.bind(this);this._savedDataProviderEH=t,e.addEventListener("mutate",t),e.addEventListener("refresh",t)}},_removeDataProviderEventListeners:function(){var e=this._wrappedDataProvider,t=this._savedDataProviderEH;e&&t&&(e.removeEventListener("mutate",t),e.removeEventListener("refresh",t),this._savedDataProviderEH=void 0)},_handleDataProviderEvent:function(t){if(!t.filterCriterionChanged){var i=this.options.value;if("mutate"===t.type)if(null!=t.detail.remove)t.detail.remove.keys.forEach(function(t){e.Object.compareValues(t,i)&&(i=this._valueForPlaceholder,o.warn("Select: selected value removed from data provider"))}.bind(this));this._setOption("value",i),this._abstractLovBase.handleDataProviderEvent(t)}},_mergeValueAndValueItem:function(t,i){var n=!1;return f.isValueForPlaceholder(t)?i&&this._syncValueWithValueItem(i,t):i&&(n=!e.Object.compareValues(t,i.key)),n},_syncValueWithValueItem:function(t,i){var n,r=this._abstractLovBase;if(n=f.isValueItemForPlaceholder(t)?f.isValueForPlaceholder(i)?i:this._valueForPlaceholder:t?t.key:null,!e.Object.compareValues(n,i)){var o={doValueChangeCheck:!1,_context:{internalSet:!0,writeback:!0}};this.option("value",n,o),r.setValue(n),this._AfterSetOptionValue("value",o)}},_initSelectedValue:function(e){if(!this._applyValueItem(e)){var t=f.isValueItemForPlaceholder(e)?this.options.value:e.key;this._initSelectionHelper(t,this._updateSelectedOption.bind(this))}},_applyValueItem:function(e){return!this._resolveValueItemLater&&!f.isValueItemForPlaceholder(e)&&(this._updateInputElemValue(e),!0)},_updateSelectedOption:function(e){this._updateInputElemValue(e),this._setValueItem(e)},_setValueItem:function(e){var t=e;e&&!f.isValueItemForPlaceholder(e)&&(t=f.createValueItem(e.key,e.data,e.metadata));this.option("valueItem",t,{_context:{internalSet:!0,changed:!0,writeback:!0}})},_updateValueItem:function(e){this._initSelectionHelper(e,function(e){this._setValueItem(e),this._updateSelectedOption(e)}.bind(this))},_updateInputElemValue:function(e){var i=t(this._lovMainField.getInputElem());this._selectedValueItem=e;var n=null;if(e&&e.data){var r=this._itemTextRenderer(e),o=i.val();void 0!==r&&o!==r&&(n=r)}else n="";if(null!==n&&(i.val(n),this.options.readOnly)){let e=this._getReadonlyDiv();e&&(e.textContent=n)}},_itemTextRenderer:function(e){var t;if(e&&e.data){var i=this.options.itemText;t="string"==typeof i?e.data[i]:i(e)}return t},_initSelectionHelper:function(e,t){if(f.isValueForPlaceholder(e))t(this._valueItemForPlaceholder);else if(this._abstractLovBase.hasData())if(this._userSelectedValueItem){var i=this._userSelectedValueItem;this._initSelectionFetchByKey({data:[i.data],metadata:[i.metadata]},e,t)}else this.options.data?(this._loadingAwaitingData&&(this._loadingAwaitingData=!1,this._setUiLoadingState("stop")),this._fetchByKeysFromDataProvider([e]).then(function(i){this._bReleasedResources||this._initSelectionFetchByKey(i,e,t)}.bind(this),function(){this._bReleasedResources||this._initSelectionFetchByKey(null,e,t)}.bind(this))):this._loadingAwaitingData||(this._loadingAwaitingData=!0,this._setUiLoadingState("start"))},_initSelectionFetchByKey:function(t,i,n){if(e.Object.compareValues(i,this.options.value)&&!this._valueHasChanged){var r=null,a=null;t&&t.data&&t.data.length>0?(r=t.data[0],a=t.metadata[0]):o.warn("SelectSingle: could not fetch data for selected value: "+i),n(f.createValueItem(i,r,a)),this._valueHasChanged=void 0}},_fetchByKeysFromDataProvider:function(t){var i;if(this._cachedFetchByKeys&&this._cachedFetchByKeys.promise&&e.Object.compareValues(t,this._cachedFetchByKeys.key))i=this._cachedFetchByKeys.promise;else{var n=f.addBusyState(this.OuterWrapper,"fetching selected data"),r=!1;"init"===this._abstractLovBase.getFetchType()&&(this._abstractLovBase.isDropdownOpen()||(r=!0,this._setUiLoadingState("start"))),i=new Promise(function(e,i){this._wrappedDataProvider.fetchByKeys({keys:new Set(t)}).then(function(t){var i=[],n=[];t.results.forEach(function(e){i.push(e.data),n.push(e.metadata)}),e({data:i,metadata:n})},function(e){i(e)})}.bind(this)),this._cachedFetchByKeys={key:t,promise:i};var a=function(){this._bReleasedResources||(this._cachedFetchByKeys=void 0,r&&this._setUiLoadingState("stop")),n()}.bind(this);i.then(function(){a()},function(e){o.warn("Select: fetchByKeys promise was rejected: "+e),a()})}return i},_setUiLoadingState:function(e){"start"===e?(this._loadingIndicatorTimer&&this._loadingIndicatorTimer.clear(),this._loadingIndicatorTimer=c.getTimer(this._showIndicatorDelay),this._loadingIndicatorTimer.getPromise().then(function(e){e&&this._addLoadingIndicator()}.bind(this))):"stop"===e&&(this._loadingIndicatorTimer&&(this._loadingIndicatorTimer.clear(),this._loadingIndicatorTimer=null),this._removeLoadingIndicator())},_addLoadingIndicator:function(){this._loadingIndicatorCount+=1,this._savedLoadingIndicator||(this._SetLoading(),this._savedLoadingIndicator=!0)},_removeLoadingIndicator:function(){this._loadingIndicatorCount>0&&(this._loadingIndicatorCount-=1),0===this._loadingIndicatorCount&&this._savedLoadingIndicator&&(this._ClearLoading(),this._savedLoadingIndicator=!1)}}),i.setDefaultOptions({ojSelect2:{displayOptions:{converterHint:["none"]}}}),p.extension._WIDGET_NAME="ojSelect2",p.extension._INNER_ELEM="input",p.extension._ALIASED_PROPS={readonly:"readOnly"},e.CustomElementBridge.register("oj-select-single",{metadata:e.CollectionUtils.mergeDeep(p,{properties:{readonly:{binding:{consume:{name:"readonly"}}},userAssistanceDensity:{binding:{consume:{name:"userAssistanceDensity"}}}}})})});