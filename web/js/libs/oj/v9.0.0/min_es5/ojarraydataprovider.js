/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
"use strict";define(["ojs/ojcore","jquery","ojs/ojset","ojs/ojmap","ojs/ojdataprovider","ojs/ojlogger","ojs/ojeventtarget"],function(t,e,n,i,r,a){function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function u(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,e,n){return e&&u(t.prototype,e),n&&u(t,n),t}var l=function(){function e(t,n){s(this,e),this.data=t,this.options=n,this.Item=function(){return function t(n,i,r){s(this,t),this._parent=n,this.metadata=i,this.data=r,this[e._METADATA]=i,this[e._DATA]=r}}(),this.ItemMetadata=function(){return function t(n,i){s(this,t),this._parent=n,this.key=i,this[e._KEY]=i}}(),this.FetchByKeysResults=function(){return function t(n,i,r){s(this,t),this._parent=n,this.fetchParameters=i,this.results=r,this[e._FETCHPARAMETERS]=i,this[e._RESULTS]=r}}(),this.ContainsKeysResults=function(){return function t(n,i,r){s(this,t),this._parent=n,this.containsParameters=i,this.results=r,this[e._CONTAINSPARAMETERS]=i,this[e._RESULTS]=r}}(),this.FetchByOffsetResults=function(){return function t(n,i,r,a){s(this,t),this._parent=n,this.fetchParameters=i,this.results=r,this.done=a,this[e._FETCHPARAMETERS]=i,this[e._RESULTS]=r,this[e._DONE]=a}}(),this.FetchListParameters=function(){return function t(n,i,r,a,u){s(this,t),this._parent=n,this.size=i,this.sortCriteria=r,this.filterCriterion=a,this.attributes=u,this[e._SIZE]=i,this[e._SORTCRITERIA]=r,this[e._FILTERCRITERION]=a,this[e._ATTRIBUTES]=u}}(),this.FetchListResult=function(){return function t(n,i,r,a){s(this,t),this._parent=n,this.fetchParameters=i,this.data=r,this.metadata=a,this[e._FETCHPARAMETERS]=i,this[e._DATA]=r,this[e._METADATA]=a}}(),this.AsyncIterable=function(){return function t(e,n){s(this,t),this._parent=e,this._asyncIterator=n,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}}(),this.AsyncIterator=function(){function t(n,i,r,a){s(this,t),this._parent=n,this._nextFunc=i,this._params=r,this._offset=a,this._clientId=r&&r.clientId||Symbol(),n._mapClientIdToOffset.set(this._clientId,a),this._cacheObj={},this._cacheObj[e._MUTATIONSEQUENCENUM]=n._mutationSequenceNum}return o(t,[{key:"next",value:function(){var t=this._parent._mapClientIdToOffset.get(this._clientId),e=this._nextFunc(this._params,t,this._cacheObj);return this._parent._mapClientIdToOffset.set(this._clientId,e.offset),Promise.resolve(e.result)}}]),t}(),this.AsyncIteratorYieldResult=function(){return function t(n,i){s(this,t),this._parent=n,this.value=i,this[e._VALUE]=i,this[e._DONE]=!1}}(),this.AsyncIteratorReturnResult=function(){return function t(n,i){s(this,t),this._parent=n,this.value=i,this[e._VALUE]=i,this[e._DONE]=!0}}(),this.DataProviderMutationEventDetail=function(){return function t(n,i,r,a){s(this,t),this._parent=n,this.add=i,this.remove=r,this.update=a,this[e._ADD]=i,this[e._REMOVE]=r,this[e._UPDATE]=a}}(),this.DataProviderOperationEventDetail=function(){return function t(n,i,r,a,u){s(this,t),this._parent=n,this.keys=i,this.metadata=r,this.data=a,this.indexes=u,this[e._KEYS]=i,this[e._METADATA]=r,this[e._DATA]=a,this[e._INDEXES]=u}}(),this.DataProviderAddOperationEventDetail=function(){return function t(n,i,r,a,u,o,l){s(this,t),this._parent=n,this.keys=i,this.afterKeys=r,this.addBeforeKeys=a,this.metadata=u,this.data=o,this.indexes=l,this[e._KEYS]=i,this[e._AFTERKEYS]=r,this[e._ADDBEFOREKEYS]=a,this[e._METADATA]=u,this[e._DATA]=o,this[e._INDEXES]=l}}(),this._cachedIndexMap=[],this._sequenceNum=0,this._mutationSequenceNum=0,this._mapClientIdToOffset=new Map,this._subscribeObservableArray(t),null!=n&&null!=n[e._KEYS]&&(this._keysSpecified=!0,this._keys=n[e._KEYS])}return o(e,[{key:"containsKeys",value:function(t){var i=this;return this.fetchByKeys(t).then(function(r){var a=new n;return t[e._KEYS].forEach(function(t){null!=r[e._RESULTS].get(t)&&a.add(t)}),Promise.resolve(new i.ContainsKeysResults(i,t,a))})}},{key:"fetchByKeys",value:function(n){var r=this;this._generateKeysIfNeeded();var a,s=new i,u=this._getKeys(),o=null!=n?n[e._ATTRIBUTES]:null,l=0;if(n){var h=r._getRowData();return n[e._KEYS].forEach(function(e){for(a=null,l=0;l<u.length;l++)if(t.Object.compareValues(u[l],e)){a=l;break}if(null!=a&&a>=0){var n=h[a];if(o&&o.length>0){var i={};r._filterRowAttributes(o,n,i),n=i}s.set(e,new r.Item(r,new r.ItemMetadata(r,e),n))}}),Promise.resolve(new r.FetchByKeysResults(r,n,s))}return Promise.reject("Keys are a required parameter")}},{key:"fetchByOffset",value:function(t){var n=this,i=null!=t?t[e._SIZE]:-1,r=null!=t?t[e._SORTCRITERIA]:null,a=null!=t&&t[e._OFFSET]>0?t[e._OFFSET]:0,s=null!=t?t[e._ATTRIBUTES]:null,u=null!=t?t[e._FILTERCRITERION]:null;this._generateKeysIfNeeded();var o=[],l=!0;if(t){var h=new this.FetchListParameters(this,i,r,u,s),f=this._fetchFrom(h,a).result,_=f[e._VALUE];l=f[e._DONE];var c=_[e._DATA],d=_[e._METADATA].map(function(t){return t[e._KEY]});return o=c.map(function(t,e){return new n.Item(n,new n.ItemMetadata(n,d[e]),t)}),Promise.resolve(new this.FetchByOffsetResults(this,t,o,l))}return Promise.reject("Offset is a required parameter")}},{key:"fetchFirst",value:function(t){return new this.AsyncIterable(this,new this.AsyncIterator(this,this._fetchFrom.bind(this),t,0))}},{key:"getCapability",value:function(t){return e.getCapability(t)}},{key:"getTotalSize",value:function(){return Promise.resolve(this._getRowData().length)}},{key:"isEmpty",value:function(){return this._getRowData().length>0?"no":"yes"}},{key:"createOptimizedKeySet",value:function(t){return new n(t)}},{key:"createOptimizedKeyMap",value:function(t){if(t){var e=new i;return t.forEach(function(t,n){e.set(n,t)}),e}return new i}},{key:"_getRowData",value:function(){return this[e._DATA]instanceof Array?this[e._DATA]:this[e._DATA]()}},{key:"_getKeys",value:function(){return null==this._keys||this._keys instanceof Array?this._keys:this._keys()}},{key:"_indexOfKey",value:function(e){var n,i=this._getKeys(),r=-1;for(n=0;n<i.length;n++)if(t.Object.compareValues(i[n],e)){r=n;break}return r}},{key:"_adjustIteratorOffset",value:function(t){var e=this;this._mapClientIdToOffset.forEach(function(n,i){var r=0,a=0;t.forEach(function(t){t.index<n&&("deleted"===t.status?++a:"added"===t.status&&++r)}),e._mapClientIdToOffset.set(i,n+r-a)})}},{key:"_subscribeObservableArray",value:function(e){if(!(e instanceof Array)){if(!this._isObservableArray(e))throw new Error("Invalid data type. ArrayDataProvider only supports Array or observableArray.");var i=this;e.subscribe(function(e){var r,s,u,o,l,h=[],f=[],_=[],c=[],d=[];i._mutationSequenceNum++;var v=!0,E=!0;e.forEach(function(t){"deleted"===t.status?(v=!1,0):"added"===t.status&&(E=!1,0)}),i._adjustIteratorOffset(e);var p=[],y=[],A=null,T=null,m=null,R=i._generateKeysIfNeeded();if(!v&&!E){for(r=0;r<e.length;r++){o=e[r].index,l=e[r].status;var I=i._getId(e[r].value);for(s=0;s<e.length;s++)s!=r&&o===e[s].index&&l!==e[s].status&&p.indexOf(r)<0&&y.indexOf(r)<0&&(null==I||t.Object.compareValues(I,i._getId(e[s].value)))&&("deleted"===l?(y.push(r),p.push(s)):(y.push(s),p.push(r)))}for(r=0;r<e.length;r++)if(p.indexOf(r)>=0){var g=i._getKeys()[e[r].index];f.push(g),h.push(e[r].value),_.push(e[r].index)}if(f.length>0){c=f.map(function(t){return new i.ItemMetadata(i,t)});var O=new n;f.map(function(t){O.add(t)}),A=new i.DataProviderOperationEventDetail(i,O,c,h,_)}}if(h=[],f=[],_=[],!v){for(r=0;r<e.length;r++)"deleted"===e[r].status&&p.indexOf(r)<0&&y.indexOf(r)<0&&(f.push(i._getKeys()[e[r].index]),h.push(e[r].value),_.push(e[r].index));if(f.length>0&&f.map(function(t){var e=i._indexOfKey(t);i._keys.splice(e,1)}),f.length>0){c=f.map(function(t){return new i.ItemMetadata(i,t)});var S=new n;f.map(function(t){S.add(t)}),m=new i.DataProviderOperationEventDetail(i,S,c,h,_)}}if(h=[],f=[],_=[],!E){var D=null==i._getKeys()||!(i._getKeys().length>0);for(r=0;r<e.length;r++)"added"===e[r].status&&p.indexOf(r)<0&&y.indexOf(r)<0&&(null==(u=i._getId(e[r].value))&&(R||i._keysSpecified)&&(u=i._getKeys()[e[r].index]),null==u?(u=i._sequenceNum++,i._keys.splice(e[r].index,0,u)):D||-1===i._indexOfKey(u)?i._keys.splice(e[r].index,0,u):R||(a.warn("added row has duplicate key "+u),i._keys.splice(e[r].index,0,u)),f.push(u),h.push(e[r].value),_.push(e[r].index));for(r=0;r<e.length;r++)if("added"===e[r].status&&p.indexOf(r)<0&&y.indexOf(r)<0){var b=i._getKeys()[e[r].index+1];b=null==b?null:b,d.push(b)}if(f.length>0){c=f.map(function(t){return new i.ItemMetadata(i,t)});var w=new n;f.map(function(t){w.add(t)});var k=new n;d.map(function(t){k.add(t)}),T=new i.DataProviderAddOperationEventDetail(i,w,k,d,c,h,_)}}i._fireMutationEvent(T,m,A)},null,"arrayChange"),e.subscribe(function(e){i._mutationEvent?i.dispatchEvent(i._mutationEvent):i._mutationRemoveEvent||i._mutationAddEvent||i._mutationUpdateEvent?(i._mutationRemoveEvent&&i.dispatchEvent(i._mutationRemoveEvent),i._mutationAddEvent&&i.dispatchEvent(i._mutationAddEvent),i._mutationUpdateEvent&&i.dispatchEvent(i._mutationUpdateEvent)):i.dispatchEvent(new t.DataProviderRefreshEvent),i._mutationEvent=null,i._mutationRemoveEvent=null,i._mutationAddEvent=null,i._mutationUpdateEvent=null},null,"change")}}},{key:"_fireMutationEvent",value:function(e,n,i){var r=this,a=!1;if(["keys","indexes"].forEach(function(t){a||(a=r._hasSamePropValue(n,e,t)||r._hasSamePropValue(n,i,t)||r._hasSamePropValue(e,i,t))}),a){if(n){var s=new this.DataProviderMutationEventDetail(this,null,n,null);this._mutationRemoveEvent=new t.DataProviderMutationEvent(s)}if(e){var u=new this.DataProviderMutationEventDetail(this,e,null,null);this._mutationAddEvent=new t.DataProviderMutationEvent(u)}if(i){var o=new this.DataProviderMutationEventDetail(this,null,null,i);this._mutationUpdateEvent=new t.DataProviderMutationEvent(o)}}else{var l=new this.DataProviderMutationEventDetail(this,e,n,i);this._mutationEvent=new t.DataProviderMutationEvent(l)}}},{key:"_hasSamePropValue",value:function(e,n,i){var r="_hasSamePropValue is true";try{e&&e[i]&&e[i].forEach(function(e){n&&n[i]&&n[i].forEach(function(n){if(t.Object.compareValues(e,n))throw r})})}catch(t){if(t===r)return!0;throw t}return!1}},{key:"_isObservableArray",value:function(t){return"function"==typeof t&&t.subscribe&&!(void 0===t.destroyAll)}},{key:"_generateKeysIfNeeded",value:function(){if(null==this._keys){var t=null!=this.options?this.options[e._KEYATTRIBUTES]||this.options[e._IDATTRIBUTE]:null;this._keys=[];var n,i=this._getRowData(),r=0;for(r=0;r<i.length;r++)null!=(n=this._getId(i[r]))&&"@index"!=t||(n=this._sequenceNum++),this._keys[r]=n;return!0}return!1}},{key:"_getId",value:function(t){var n,i=null!=this.options?this.options[e._KEYATTRIBUTES]||this.options[e._IDATTRIBUTE]:null;if(null!=i){var r;if(Array.isArray(i))for(n=[],r=0;r<i.length;r++)n[r]=this._getVal(t,i[r]);else n="@value"==i?this._getAllVals(t):this._getVal(t,i);return n}return null}},{key:"_getVal",value:function(t,e){return"function"==typeof t[e]?t[e]():t[e]}},{key:"_getAllVals",value:function(t){var e=this;return Object.keys(t).map(function(n){return e._getVal(t,n)})}},{key:"_fetchFrom",value:function(t,n,i){var a=this,s=null!=t?t[e._ATTRIBUTES]:null;this._generateKeysIfNeeded();var u=null!=t?t[e._SORTCRITERIA]:null,o=this._getCachedIndexMap(u,i),l=this._getRowData(),h=o.map(function(t){return l[t]}),f=o.map(function(t){return a._getKeys()[t]}),_=null!=t?t[e._SIZE]>0?t[e._SIZE]:t[e._SIZE]<0?a._getKeys().length:25:25,c=n+_<h.length,d=this._mergeSortCriteria(u);null!=d&&((t=t||{})[e._SORTCRITERIA]=d);var v,E=[],p=[],y=0;if(null!=t&&t[e._FILTERCRITERION]){var A=null;A=r.FilterFactory.getFilter({filterDef:t[e._FILTERCRITERION],filterOptions:this.options});for(var T=0;E.length<_&&T<h.length;)A.filter(h[T])&&(y>=n&&(E.push(h[T]),p.push(f[T])),y++),T++;c=T<h.length}else E=h.slice(n,n+_),p=f.slice(n,n+_);y=n+E.length,v=E.map(function(t){if(s&&s.length>0){var e={};a._filterRowAttributes(s,t,e),t=e}return t});var m=p.map(function(t){return new a.ItemMetadata(a,t)}),R=new this.FetchListResult(this,t,v,m);return c?{result:new this.AsyncIteratorYieldResult(this,R),offset:y}:{result:new this.AsyncIteratorReturnResult(this,R),offset:y}}},{key:"_getCachedIndexMap",value:function(t,n){if(n&&n.indexMap&&n[e._MUTATIONSEQUENCENUM]===this._mutationSequenceNum)return n.indexMap;var i=this._getRowData().map(function(t,e){return e}),r=this._sortData(i,t);return n&&(n.indexMap=r,n[e._MUTATIONSEQUENCENUM]=this._mutationSequenceNum),r}},{key:"_sortData",value:function(t,e){var n=this._getRowData(),i=t.map(function(t){return{index:t,value:n[t]}});return null!=e&&i.sort(this._getSortComparator(e)),i.map(function(t){return t.index})}},{key:"_getSortComparator",value:function(t){var n=this;return function(i,r){var a,s,u,o,l,h,f=null!=n.options?n.options[e._SORTCOMPARATORS]:null;for(a=0;a<t.length;a++)if(s=t[a][e._DIRECTION],u=t[a][e._ATTRIBUTE],o=null,null!=f&&(o=f[e._COMPARATORS].get(u)),l=n._getVal(i.value,u),h=n._getVal(r.value,u),null!=o){var _="descending"==s?-1:1,c=o(l,h)*_;if(0!=c)return c}else{var d=0,v="string"==typeof l?l:new String(l).toString(),E="string"==typeof h?h:new String(h).toString();if(0!=(d="ascending"==s?v.localeCompare(E,void 0,{numeric:!0,sensitivity:"base"}):E.localeCompare(v,void 0,{numeric:!0,sensitivity:"base"})))return d}return 0}}},{key:"_mergeSortCriteria",value:function(t){var n=null!=this.options?this.options[e._IMPLICITSORT]:null;if(null!=n){if(null==t)return n;var i,r,a,s=t.slice(0);for(i=0;i<n.length;i++){for(a=!1,r=0;r<s.length;r++)s[r][e._ATTRIBUTE]==n[i][e._ATTRIBUTE]&&(a=!0);a||s.push(n[i])}return s}return t}},{key:"_filterRowAttributes",value:function(t,n,i){var r=this;if(Array.isArray(t)){var a,s=!1;t.forEach(function(t){t!=e._ATDEFAULT&&t.name!=e._ATDEFAULT||(s=!0)}),Object.keys(n).forEach(function(e){if(s){var u,o=!1,l=e;for(a=0;a<t.length;a++)if((u=t[a]instanceof Object?t[a].name:t[a]).startsWith("!")){if((u=u.substr(1,u.length-1))==e){o=!0;break}}else if(u==e){l=t[a];break}o||r._filterRowAttributes(l,n,i)}else t.forEach(function(t){var a;(a=t instanceof Object?t.name:t).startsWith("!")||a!=e||r._filterRowAttributes(t,n,i)})})}else if(t instanceof Object){var u=t.name,o=t.attributes;if(u&&!u.startsWith("!"))if(n[u]instanceof Object&&!Array.isArray(n[u])&&o){var l={};r._filterRowAttributes(o,n[u],l),i[u]=l}else if(Array.isArray(n[u])&&o){var h;i[u]=[],n[u].forEach(function(t,e){h={},r._filterRowAttributes(o,t,h),i[u][e]=h})}else r._proxyAttribute(i,n,u)}else r._proxyAttribute(i,n,t)}},{key:"_proxyAttribute",value:function(t,e,n){t&&e&&Object.defineProperty(t,n,{get:function(){return e[n]},set:function(t){e[n]=t},enumerable:!0})}}],[{key:"getCapability",value:function(t){if("sort"==t)return{attributes:"multiple"};if("fetchByKeys"==t)return{implementation:"lookup"};if("fetchByOffset"==t)return{implementation:"randomAccess"};if("fetchCapability"==t){var e=new Set;return e.add("exclusion"),{attributeFilter:{expansion:{},ordering:{},defaultShape:{features:e}}}}return"filter"==t?{operators:["$co","$eq","$ew","$pr","$gt","$ge","$lt","$le","$ne","$regex","$sw"],attributeExpression:["*"],textFilter:{}}:null}}]),e}();
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
return l._KEY="key",l._KEYS="keys",l._AFTERKEYS="afterKeys",l._ADDBEFOREKEYS="addBeforeKeys",l._DIRECTION="direction",l._ATTRIBUTE="attribute",l._ATTRIBUTES="attributes",l._SORT="sort",l._SORTCRITERIA="sortCriteria",l._FILTERCRITERION="filterCriterion",l._DATA="data",l._METADATA="metadata",l._INDEXES="indexes",l._OFFSET="offset",l._SIZE="size",l._IDATTRIBUTE="idAttribute",l._IMPLICITSORT="implicitSort",l._KEYATTRIBUTES="keyAttributes",l._SORTCOMPARATORS="sortComparators",l._COMPARATORS="comparators",l._COMPARATOR="comparator",l._RESULTS="results",l._CONTAINS="contains",l._FETCHPARAMETERS="fetchParameters",l._CONTAINSPARAMETERS="containsParameters",l._VALUE="value",l._DONE="done",l._ADD="add",l._REMOVE="remove",l._UPDATE="update",l._DETAIL="detail",l._FETCHLISTRESULT="fetchListResult",l._ATDEFAULT="@default",l._MUTATIONSEQUENCENUM="mutationSequenceNum",t.ArrayDataProvider=l,t.EventTargetMixin.applyMixin(l),l});