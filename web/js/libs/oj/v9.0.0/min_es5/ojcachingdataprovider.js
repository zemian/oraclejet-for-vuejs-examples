/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
"use strict";define(["ojs/ojcore","ojs/ojlogger","ojs/ojdataprovider"],function(e,t,a){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,a){return t&&s(e.prototype,t),a&&s(e,a),e}var r,c,h,u=function(){function e(t,a,s){n(this,e),this.asyncIterator=t,this.cache=a,this.cacheEntries=s}return i(e,[{key:"next",value:function(){var e=this,t=this.asyncIterator.next();return t.then(function(t){var a=t.value,n=e.cache.data.length,s=n+a.data.length-1;e.cache.data=e.cache.data.concat(a.data),e.cache.metadata=e.cache.metadata.concat(a.metadata),e.cache.done=t.done,e.cacheEntries.push({start:n,end:s,miss:0,status:c.READY})}),t}}]),e}();return function(e){e[e.NEVER=0]="NEVER",e[e.LRU=1]="LRU"}(r||(r={})),function(e){e[e.READY=0]="READY",e[e.FETCHING=1]="FETCHING",e[e.PURGED=2]="PURGED"}(c||(c={})),function(e){e[e.UP=0]="UP",e[e.DOWN=1]="DOWN"}(h||(h={})),function(){function e(t,a,s){n(this,e),this.dataProvider=t,this.cache=a,this.options=s,this.strategy=r.NEVER,this.prefetching=!1,this.currentStart=0,this.CACHE_MISS_THRESHOLD=5,null==a&&(this.cache={data:[],metadata:[],done:!1,startIndex:0}),this.cacheQueue=[],this.modelEventHandler=this._handleModelEvent.bind(this),t.addEventListener("mutate",this.modelEventHandler),t.addEventListener("refresh",this.modelEventHandler)}return i(e,[{key:"destroy",value:function(){this.dataProvider&&this.modelEventHandler&&(this.dataProvider.removeEventListener("mutate",this.modelEventHandler),this.dataProvider.removeEventListener("refresh",this.modelEventHandler))}},{key:"fetchFirst",value:function(e){return this._resetCache(),new function e(t,a,s){var i=this;n(this,e),this.asyncIterable=t,this.cache=a,this.cacheEntries=s,this[Symbol.asyncIterator]=function(){return new u(i.asyncIterable[Symbol.asyncIterator](),i.cache,i.cacheEntries)}}(this.dataProvider.fetchFirst(e),this.cache,this.cacheQueue)}},{key:"fetchByKeys",value:function(e){return this.dataProvider.fetchByKeys(e)}},{key:"containsKeys",value:function(e){return this.dataProvider.containsKeys(e)}},{key:"fetchByOffset",value:function(e){var a=this;void 0===this.proximity&&(this.proximity=e.size);var n=h.UP,s=e.offset,i=s+e.size;if(s>this.currentStart&&(n=h.DOWN),this.currentStart=s,!this._isInCache(s,i))return t.info("Cache missed: "+s+" - "+i),this.cacheQueue.forEach(function(e){e.status!==c.FETCHING&&(e.start>=s&&e.start<=i||e.end<=i&&e.end>=s?(a._log("cache entry update to FETCHING - start: "+e.start+" end: "+e.end),e.status=c.FETCHING):e.miss=e.miss+1)}),this.fetchByOffsetPromise=new Promise(function(t,r){a._log("Call fetchByOffset to fulfill cache"),a.dataProvider.fetchByOffset(e).then(function(r){for(var h=0;h<r.results.length;h++){var u=r.results[h];a.cache.data[s+h]=u.data,a.cache.metadata[s+h]=u.metadata}a._log("cache fulfilled - offset: "+s+" size: "+r.results.length),a.cacheQueue.forEach(function(e){e.status===c.FETCHING&&(a._log("cache entry update to READY - start: "+e.start+" end: "+e.end),e.status=c.READY,e.miss=0)});var d=a._getFetchByOffsetResult(s,i);t({results:d,fetchParameters:e,done:!1}),a._recalibrateCache(s,i,n)})}),this.fetchByOffsetPromise;this._updateCacheEntries(s,i);var r=this._getFetchByOffsetResult(s,i);return this._recalibrateCache(s,i,n),Promise.resolve({results:r,fetchParameters:e,done:!1})}},{key:"_updateCacheEntries",value:function(e,t){this.cacheQueue.forEach(function(a){a.status!==c.PURGED&&(a.start>t||a.end<e?a.miss=a.miss+1:a.miss=0)})}},{key:"_getFetchByOffsetResult",value:function(e,t){for(var a=e-this.cache.startIndex,n=t-this.cache.startIndex,s=[],i=a;i<n;i++)s.push({data:this.cache.data[i],metadata:this.cache.metadata[i]});return s}},{key:"getTotalSize",value:function(){return this.dataProvider.getTotalSize()}},{key:"isEmpty",value:function(){return this.dataProvider.isEmpty()}},{key:"getCapability",value:function(e){return this.dataProvider.getCapability(e)}},{key:"addEventListener",value:function(e,t){this.dataProvider.addEventListener(e,t)}},{key:"removeEventListener",value:function(e,t){this.dataProvider.removeEventListener(e,t)}},{key:"dispatchEvent",value:function(e){return this.dataProvider.dispatchEvent(e)}},{key:"_handleModelEvent",value:function(e){if("refresh"===e.type)this._handleRowsRefreshed();else if("mutate"===e.type){var t=e.detail;t.add&&this._handleRowsAdded(t.add),t.remove&&this._handleRowsRemoved(t.remove),t.update&&this._handleRowsUpdated(t.update)}}},{key:"_resetCache",value:function(){this.cache.data.length=0,this.cache.metadata.length=0,this.cache.startIndex=0,this.cache.done=!1,this.cacheQueue.length=0}},{key:"_recalibrateCache",value:function(e,t,a){var n=this;if(this.strategy!==r.NEVER&&(this.cacheQueue.forEach(function(a){if(a.status===c.READY&&a.miss>=n.CACHE_MISS_THRESHOLD&&(a.end<e-n.proximity||a.start>t+n.proximity)){n._log("Purging cache range: "+a.start+" to "+a.end);for(var s=a.start;s<=a.end;s++)n.cache.data[s]=null,n.cache.metadata[s]=null;a.status=c.PURGED}}),this._dumpCacheStatus(),!1!==this.prefetching))for(var s=function(s){var i=n.cacheQueue[s];return a===h.UP&&i.start<e&&i.end>e?(i.status!==c.PURGED&&n._isInCache(i.start,i.end)||(i.status=c.FETCHING,n._log("pre-fetch cache range (before adjustment): "+i.start+" - "+i.end+" direction: "+a),n._prefetchRange(i.start,e-i.start).then(function(e){i.status=c.READY})),"break"):a===h.DOWN&&i.start<t&&i.end>t?(i.status!==c.PURGED&&n._isInCache(i.start,i.end)||(i.status=c.FETCHING,n._log("pre-fetch cache range (before adjustment): "+i.start+" - "+i.end+" direction: "+a),n._prefetchRange(t,i.end-t).then(function(e){i.status=c.READY})),"break"):void 0},i=0;i<this.cacheQueue.length;i++){if("break"===s(i))break}}},{key:"_prefetchRange",value:function(e,t){var a=this;return this._log("pre-fetching to refill cache - offset: "+e+" size: "+t),new Promise(function(n,s){a.dataProvider.fetchByOffset({offset:e,size:t}).then(function(s){for(var i=0;i<s.results.length;i++){var r=s.results[i];a.cache.data[e+i]=r.data,a.cache.metadata[e+i]=r.metadata}a._log("pre-fetch result returned and cache is fulfilled - offset: "+e+" size: "+t),n(!0)})})}},{key:"_isInCache",value:function(e,t){if(this.strategy===r.NEVER)return!0;if(e<this.cache.startIndex||t>this.cache.startIndex+this.cache.data.length)return!1;for(var a=e-this.cache.startIndex,n=t-this.cache.startIndex,s=a;s<n;s++)if(null==this.cache.data[s])return!1;return!0}},{key:"_handleRowsMutated",value:function(e,t,a,n){var s=this,i=e.indexes;if(null==i)e[t];else i.forEach(function(t,i){if(t<s.cache.startIndex+s.cache.data.length)if(t>=s.cache.startIndex){var r=null!=e.data?e.data[i]:null,c=null!=e.metadata?e.metadata[i]:null;a(t,r,c)}else n&&n()})}},{key:"_handleRowsAdded",value:function(e){var t=this;this._log("handling add mutation event"),this._handleRowsMutated(e,"addBeforeKeys",function(e,a,n){t.cache.data.splice(e,0,a),t.cache.metadata.splice(e,0,n)},function(){t.cache.startIndex++})}},{key:"_handleRowsRemoved",value:function(e){var t=this;this._log("handling remove mutation event"),this._handleRowsMutated(e,"keys",function(e){t.cache.data.splice(e,1),t.cache.metadata.splice(e,1)},function(){t.cache.startIndex=Math.max(0,t.cache.startIndex-1)})}},{key:"_handleRowsUpdated",value:function(e){var t=this;this._log("handling update mutation event"),this._handleRowsMutated(e,"keys",function(e,a,n){t.cache.data.splice(e,1,a),t.cache.metadata.splice(e,1,n)})}},{key:"_handleRowsRefreshed",value:function(){this._log("handling refresh event"),this._resetCache()}},{key:"_log",value:function(e){t.info("[CachingDataProvider]=> "+e)}},{key:"_getStatusText",value:function(e){switch(e){case c.READY:return"ready";case c.FETCHING:return"fetching";case c.PURGED:return"purged";default:return"unknown"}}},{key:"_dumpCacheStatus",value:function(){var e=this;this.cacheQueue.forEach(function(t){e._log("Cache entry - start: "+t.start+" end: "+t.end+" miss: "+t.miss+" status: "+e._getStatusText(t.status))})}}]),e}()});