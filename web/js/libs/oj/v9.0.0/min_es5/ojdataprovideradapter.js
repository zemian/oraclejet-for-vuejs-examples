/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore","jquery","ojs/ojdataprovideradapter-base"],function(e,t,n){"use strict";function a(e){"@babel/helpers - typeof";return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function o(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return function(e,t){if(t&&("object"===a(t)||"function"==typeof t))return t;return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,n)}}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var l=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(h,n);var a,u,l,c=o(h);function h(e){var t;return r(this,h),(t=c.call(this,e)).tableDataSource=e,t.FetchByKeysResults=function(){return function e(t,n,a){r(this,e),this._parent=t,this.fetchParameters=n,this.results=a,this[h._FETCHPARAMETERS]=n,this[h._RESULTS]=a}}(),t.ContainsKeysResults=function(){return function e(t,n,a){r(this,e),this._parent=t,this.containsParameters=n,this.results=a,this[h._CONTAINSPARAMETERS]=n,this[h._RESULTS]=a}}(),t.Item=function(){return function e(t,n,a){r(this,e),this._parent=t,this.metadata=n,this.data=a,this[h._METADATA]=n,this[h._DATA]=a}}(),t.FetchByOffsetResults=function(){return function e(t,n,a,i){r(this,e),this._parent=t,this.fetchParameters=n,this.results=a,this.done=i,this[h._FETCHPARAMETERS]=n,this[h._RESULTS]=a,this[h._DONE]=i}}(),t.FetchListParameters=function(){return function e(t,n,a){r(this,e),this._parent=t,this.size=n,this.sortCriteria=a,this[h._SIZE]=n,this[h._SORTCRITERIA]=a}}(),t._addTableDataSourceEventListeners(),t[h._OFFSET]=0,t._ignoreDataSourceEvents=new Array,t}return a=h,(u=[{key:"destroy",value:function(){this._removeTableDataSourceEventListeners()}},{key:"containsKeys",value:function(e){var t=this,n=[];return e[h._KEYS].forEach(function(e){n.push(t.tableDataSource.get(e))}),Promise.all(n).then(function(n){var a=new Set;return n.map(function(e){null!=e&&a.add(e[h._KEY])}),Promise.resolve(new t.ContainsKeysResults(t,e,a))})}},{key:"fetchByKeys",value:function(e){var t=this,n=[];return e[h._KEYS].forEach(function(e){n.push(t.tableDataSource.get(e))}),Promise.all(n).then(function(n){var a=new Map;return n.map(function(e){if(null!=e){var n=e[h._KEY],r=e[h._DATA];a.set(n,new t.Item(t,new t.ItemMetadata(t,n),r))}}),Promise.resolve(new t.FetchByKeysResults(t,e,a))})}},{key:"fetchByOffset",value:function(e){var t=this,n=null!=e?e[h._SIZE]:-1,a=null!=e?e[h._SORTCRITERIA]:null,r=null!=e&&e[h._OFFSET]>0?e[h._OFFSET]:0,i=new this.FetchListParameters(this,n,a);return this._startIndex=0,this._getFetchFunc(i,r)(i,!0).then(function(n){var a=n[h._VALUE],r=n[h._DONE],i=a[h._DATA],s=a[h._METADATA].map(function(e){return e[h._KEY]}),o=new Array;return i.map(function(e,n){o.push(new t.Item(t,new t.ItemMetadata(t,s[n]),i[n]))}),new t.FetchByOffsetResults(t,e,o,r)})}},{key:"fetchFirst",value:function(e){return this._isPagingModelTableDataSource()||(this._startIndex=0),new this.AsyncIterable(new this.AsyncIterator(this._getFetchFunc(e),e))}},{key:"getCapability",value:function(e){return e==h._SORT&&"full"==this.tableDataSource.getCapability(e)?{attributes:"multiple"}:"fetchByKeys"==e?{implementation:"lookup"}:"fetchByOffset"==e?{implementation:"lookup"}:null}},{key:"getTotalSize",value:function(){return Promise.resolve(this.tableDataSource.totalSize())}},{key:"isEmpty",value:function(){return this.tableDataSource.totalSize()>0?"no":"yes"}},{key:"getPage",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPage():-1}},{key:"setPage",value:function(e,t){return this._isPagingModelTableDataSource()?this.tableDataSource.setPage(e,t):Promise.reject(null)}},{key:"getStartItemIndex",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getStartItemIndex():-1}},{key:"getEndItemIndex",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getEndItemIndex():-1}},{key:"getPageCount",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPageCount():-1}},{key:"totalSize",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSize():-1}},{key:"totalSizeConfidence",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSizeConfidence():null}},{key:"_getFetchFunc",value:function(e,t){var n=this;if(null!=e&&null!=e[h._SORTCRITERIA]){var a=e[h._SORTCRITERIA][0][h._ATTRIBUTE],r=e[h._SORTCRITERIA][0][h._DIRECTION];return this._ignoreSortEvent=!0,this._isPagingModelTableDataSource()||(this._startIndex=0),function(e,a){return function(r,i){if(i){var s={};return s[h._KEY]=e,s[h._DIRECTION]=a,n[h._OFFSET]=0,n.tableDataSource.sort(s).then(function(){return n._ignoreSortEvent=!1,n._getTableDataSourceFetch(r,t)(r)})}return n._getTableDataSourceFetch(r,t)(r)}}(a,r)}return this._getTableDataSourceFetch(e,t)}},{key:"_getTableDataSourceFetch",value:function(e,t){var n=this;return function(e,a){var r={};if(t=t>0?t:0,null!=n._startIndex&&(r[h._STARTINDEX]=n._startIndex+t),r[h._PAGESIZE]=null!=e&&e[h._SIZE]>0?e[h._SIZE]:null,!n._isPagingModelTableDataSource()&&e[h._SILENT]&&(r[h._SILENT]=e[h._SILENT]),null!=n.tableDataSource[h._SORTCRITERIA]&&null==e[h._SORTCRITERIA]){e[h._SORTCRITERIA]=[];var i=new n.SortCriterion(n,n.tableDataSource[h._SORTCRITERIA][h._KEY],n.tableDataSource[h._SORTCRITERIA][h._DIRECTION]);e[h._SORTCRITERIA].push(i)}return r[h._FETCHTYPE]=e[h._FETCHTYPE],n._isFetching=!0,new Promise(function(t,a){n._fetchResolveFunc=t,n._fetchRejectFunc=a,n._fetchParams=e,n._requestEventTriggered||(n._isPagingModelTableDataSource()||r[h._SILENT]||n._ignoreDataSourceEvents.push(!0),n.tableDataSource.fetch(r).then(function(a){if(n._isPagingModelTableDataSource()||r[h._SILENT]||n._ignoreDataSourceEvents.pop(),null!==a){n._isFetching=!1,void 0===a&&((a={})[h._KEYS]=[],a[h._DATA]=[]);var i=[];null!=a[h._KEYS]&&(i=a[h._KEYS].map(function(e){return new n.ItemMetadata(n,e)})),null==n._startIndex&&(n._startIndex=0);var s=!1;n._startIndex=n._startIndex+a[h._DATA].length,"actual"==n.tableDataSource.totalSizeConfidence()&&n.tableDataSource.totalSize()>0&&a.startIndex+a[h._DATA].length>=n.tableDataSource.totalSize()?s=!0:r[h._PAGESIZE]>0&&a[h._DATA].length<r[h._PAGESIZE]?s=!0:0==a[h._DATA].length&&(s=!0),n._fetchResolveFunc=null,n._fetchParams=null,t(s?new n.AsyncIteratorReturnResult(n,new n.FetchListResult(n,e,a[h._DATA],i)):new n.AsyncIteratorYieldResult(n,new n.FetchListResult(n,e,a[h._DATA],i)))}},function(e){n._isPagingModelTableDataSource()||r[h._SILENT]||n._ignoreDataSourceEvents.pop(),a(e)}))})}}},{key:"_handleSync",value:function(t){var n=this;if(!(n._ignoreDataSourceEvents.length>0)){if(n._startIndex=null,t[h._STARTINDEX]>0&&(n._startIndex=t[h._STARTINDEX],n[h._OFFSET]=n._startIndex),n._fetchResolveFunc&&null!=t[h._KEYS]){n._isFetching=!1;var a=t[h._KEYS].map(function(e){return new n.ItemMetadata(n,e)}),r=!1;"actual"==n.tableDataSource.totalSizeConfidence()&&n.tableDataSource.totalSize()>0&&n._startIndex+t[h._DATA].length>=n.tableDataSource.totalSize()&&(r=!0),r?n._fetchResolveFunc(new n.AsyncIteratorReturnResult(n,new n.FetchListResult(n,n._fetchParams,t[h._DATA],a))):n._fetchResolveFunc(new n.AsyncIteratorYieldResult(n,new n.FetchListResult(n,n._fetchParams,t[h._DATA],a))),n._fetchResolveFunc=null,n._fetchParams=null}else n._requestEventTriggered||n.dispatchEvent(new e.DataProviderRefreshEvent);n._requestEventTriggered=!1}}},{key:"_handleAdd",value:function(t){var n=this,a=t[h._KEYS].map(function(e){return new n.ItemMetadata(n,e)}),r=new Set;t[h._KEYS].map(function(e){r.add(e)});var i=new n.DataProviderAddOperationEventDetail(n,r,null,null,null,a,t[h._DATA],t[h._INDEXES]),s=new n.DataProviderMutationEventDetail(n,i,null,null);n.dispatchEvent(new e.DataProviderMutationEvent(s))}},{key:"_handleRemove",value:function(t){var n=this,a=t[h._KEYS].map(function(e){return new n.ItemMetadata(n,e)}),r=new Set;t[h._KEYS].map(function(e){r.add(e)});var i=new n.DataProviderOperationEventDetail(n,r,a,t[h._DATA],t[h._INDEXES]),s=new n.DataProviderMutationEventDetail(n,null,i,null);n.dispatchEvent(new e.DataProviderMutationEvent(s))}},{key:"_handleReset",value:function(t){this._requestEventTriggered||this._isPagingModelTableDataSource()||(this._startIndex=0,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleSort",value:function(t){this._ignoreSortEvent||(this._startIndex=null,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleChange",value:function(t){var n=this,a=t[h._KEYS].map(function(e){return new n.ItemMetadata(n,e)}),r=new Set;t[h._KEYS].map(function(e){r.add(e)});var i=new n.DataProviderOperationEventDetail(n,r,a,t[h._DATA],t[h._INDEXES]),s=new n.DataProviderMutationEventDetail(n,null,null,i);n.dispatchEvent(new e.DataProviderMutationEvent(s))}},{key:"_handleRefresh",value:function(t){this._isFetching||this._requestEventTriggered||(null!=t[h._OFFSET]?this._startIndex=t[h._OFFSET]:this._startIndex=null,this.dispatchEvent(new e.DataProviderRefreshEvent)),this._requestEventTriggered=!1}},{key:"_handleRequest",value:function(t){this._ignoreDataSourceEvents.length>0||void 0!==e.Model&&t instanceof e.Model||this._isFetching||(t[h._STARTINDEX]>0&&0==this.getStartItemIndex()&&(this._startIndex=t[h._STARTINDEX]),this._requestEventTriggered=!0,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleError",value:function(e){this._fetchRejectFunc&&this._fetchRejectFunc(e),this._isFetching=!1,this._requestEventTriggered=!1}},{key:"_handlePage",value:function(t){this._isFetching=!1,this._requestEventTriggered=!1;var n={};n.detail=t,this.dispatchEvent(new e.GenericEvent(e.PagingModel.EventType.PAGE,n))}},{key:"_addTableDataSourceEventListeners",value:function(){this.removeAllListeners(),this.addListener("sync",this._handleSync),this.addListener("add",this._handleAdd),this.addListener("remove",this._handleRemove),this.addListener("reset",this._handleReset),this.addListener("sort",this._handleSort),this.addListener("change",this._handleChange),this.addListener("refresh",this._handleRefresh),this.addListener("request",this._handleRequest),this.addListener("error",this._handleError),this.addListener("page",this._handlePage)}},{key:"_removeTableDataSourceEventListeners",value:function(){this.removeListener("sync"),this.removeListener("add"),this.removeListener("remove"),this.removeListener("reset"),this.removeListener("sort"),this.removeListener("change"),this.removeListener("refresh"),this.removeListener("request"),this.removeListener("error"),this.removeListener("page")}},{key:"_isPagingModelTableDataSource",value:function(){return null!=this.tableDataSource.getStartItemIndex}}])&&i(a.prototype,u),l&&i(a,l),h}();l._STARTINDEX="startIndex",l._SILENT="silent",l._SORTCRITERIA="sortCriteria",l._PAGESIZE="pageSize",l._OFFSET="offset",l._SIZE="size",l._CONTAINSPARAMETERS="containsParameters",l._RESULTS="results",l._FETCHTYPE="fetchType",e.EventTargetMixin.applyMixin(l),e.TableDataSourceAdapter=l,e.TableDataSourceAdapter=l});