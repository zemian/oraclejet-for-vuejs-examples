/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore","jquery","knockout","ojs/ojarraytreedataprovider","ojs/ojarraydataprovider","ojs/ojeventtarget","ojs/ojtreedataprovider"],function(e,t,r,n){function i(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw a}}return r}(e,t)||s(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=s(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,c=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return o=e.done,e},e:function(e){c=!0,a=e},f:function(){try{o||null==r.return||r.return()}finally{if(c)throw a}}}}function s(e,t){if(e){if("string"==typeof e)return o(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?o(e,t):void 0}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t,r){return t&&u(e.prototype,t),r&&u(e,r),e}var l=function(){function n(e,t,r,i){c(this,n),this.dataProvider=e,this.sortComparator=t,this.sectionRenderer=r,this.options=i,this._getKeyAttribute=function(){var e=null!=this.options?this.options.keyAttributes:null;return e||(e="id"),e},this.GroupAsyncIterator=function(){function e(t,r,n,i){c(this,e),this._parent=t,this._baseIterable=r,this._dataprovider=n,this._params=i}return h(e,[{key:"next",value:function(){var e=this,t=0;e._parent._currentRootSection&&(t=Object.keys(e._parent._sections).indexOf(e._parent._currentRootSection));var r=e._parent._currentBaseOffset<t;return this._parent._getDataFromDataProvider(this._params,"root",r).then(function(){e._parent._updateSectionIndex();var t=new e._parent.FetchByOffsetParameters(e._parent,e._parent._currentBaseOffset,e._params.size,e._params.sortCriteria,e._params.filterCriterion);return e._dataprovider.fetchByOffset(t).then(function(t){for(var r=t.results,n=r.map(function(e){return e.data}),i=r.map(function(e){return e.metadata}),a=0;a<i.length;a++)i[a]=e._parent._getNodeMetadata(r[a].data),n[a]=e._parent.sectionRenderer(i[a].key);return e._parent._currentBaseOffset=e._parent._currentBaseOffset+n.length,t.done&&e._parent._dataFetchComplete?Promise.resolve(new e._parent.AsyncIteratorReturnResult(e._parent,new e._parent.FetchListResult(e._parent,e._params,n,i))):Promise.resolve(new e._parent.AsyncIteratorYieldResult(e._parent,new e._parent.FetchListResult(e._parent,e._params,n,i)))})})}}]),e}(),this.TreeAsyncIterator=function(){function e(t,r,n,i,a){c(this,e),this._parent=t,this._isParentSection=r,this._parentKey=n,this._dataprovider=i,this._params=a}return h(e,[{key:"next",value:function(){var e=this;return this._parent._registerIteratorOffset(e,e._parentKey,!1),this._parent._getDataFromDataProvider(this._params,this._parentKey,!1).then(function(t){void 0===t&&e._parent._updateSectionIndex();var r=e._parent._getIteratorOffset(e),n=new e._parent.FetchByOffsetParameters(e._parent,r,e._params.size,e._params.sortCriteria,e._params.filterCriterion);return e._dataprovider.fetchByOffset(n).then(function(t){var n=t.results,i=n.map(function(e){return e.data}),a=n.map(function(e){return e.metadata});if(e._isParentSection)for(var s=0;s<a.length;s++)a[s]=e._parent._getNodeMetadata(n[s].data),i[s]=e._parent.sectionRenderer(a[s].key);return e._parent._updateIteratorOffset(e,r+i.length),t.done?(e._parent._unregisterIteratorOffset(e),Promise.resolve(new e._parent.AsyncIteratorReturnResult(e._parent,new e._parent.FetchListResult(e._parent,e._params,i,a)))):Promise.resolve(new e._parent.AsyncIteratorYieldResult(e._parent,new e._parent.FetchListResult(e._parent,e._params,i,a)))})})}}]),e}(),this.TreeAsyncIterable=function(){return function e(t,r){c(this,e),this._parent=t,this._asyncIterator=r,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}}(),this.FetchListParameters=function(){return function e(t,r,n,i){c(this,e),this._parent=t,this.size=r,this.sortCriteria=n,this.attributes=i,this.size=r,this.sortCriteria=n,this.attributes=i}}(),this.FetchByOffsetParameters=function(){return function e(t,r,n,i,a){c(this,e),this._parent=t,this.offset=r,this.size=n,this.sortCriteria=i,this.filterCriterion=a,this.size=n,this.sortCriteria=i,this.offset=r,this.filterCriterion=a}}(),this.FetchListResult=function(){return function e(t,r,n,i){c(this,e),this._parent=t,this.fetchParameters=r,this.data=n,this.metadata=i,this.fetchParameters=r,this.data=n,this.metadata=i}}(),this.AsyncIteratorYieldResult=function(){return function e(t,r){c(this,e),this._parent=t,this.value=r,this.value=r,this.done=!1}}(),this.AsyncIteratorReturnResult=function(){return function e(t,r){c(this,e),this._parent=t,this.value=r,this.value=r,this.done=!0}}(),this._dataProvider=e,this._addEventListeners(this._dataProvider),this._initialize()}return h(n,[{key:"containsKeys",value:function(e){return this.fetchByKeys(e).then(function(t){var r=new Set;return e.keys.forEach(function(e){null!=t.results.get(e)&&r.add(e)}),Promise.resolve({containsParameters:e,results:r})})}},{key:"getCapability",value:function(e){return"filter"===e?null:this._baseDataProvider.getCapability(e)}},{key:"getTotalSize",value:function(){return this._baseDataProvider.getTotalSize()}},{key:"isEmpty",value:function(){return this._baseDataProvider.isEmpty()}},{key:"getChildDataProvider",value:function(r){var n=this,i=this._getChildren(r),a=this._isParentSection(r);function s(t,r){this._parentKey=r.parentKey,this._isParentSection=r.isParentSection,this._isParentSection?(this._baseDataProvider=new e.ArrayDataProvider(t.childData,{}),this._baseTreeDataProvider=new e.ArrayTreeDataProvider(t.childData,{keyAttributes:r.keyAttributes})):(this._baseDataProvider=new e.ArrayDataProvider(t.children,{keyAttributes:r.keyAttributes}),this._baseTreeDataProvider=new e.ArrayTreeDataProvider(t.children,{keyAttributes:r.keyAttributes}))}return s.prototype.containsKeys=function(e){return this._baseTreeDataProvider.containsKeys(e)},s.prototype.getCapability=function(e){return this._baseTreeDataProvider.getCapability(e)},s.prototype.getTotalSize=function(){return this._baseTreeDataProvider.getTotalSize()},s.prototype.isEmpty=function(){return this._baseTreeDataProvider.isEmpty()},s.prototype.fetchByOffset=function(e){return this._baseTreeDataProvider.fetchByOffset(e)},s.prototype.fetchByKeys=function(e){return this._baseTreeDataProvider.fetchByKeys(e)},s.prototype.getChildDataProvider=function(e){return n.getChildDataProvider(e)},s.prototype.fetchFirst=function(e){e&&e.filterCriterion&&((e=t.extend({},e)).filterCriterion=null);var r=this._baseDataProvider,i=this._isParentSection,a=this._parentKey;return new n.TreeAsyncIterable(n,new n.TreeAsyncIterator(n,i,a,r,e))},s.prototype._getId=function(e){return n._getId(e)},i?new s(this._sections[r],{keyAttributes:this._getKeyAttribute(),parentKey:r,isParentSection:a}):null}},{key:"fetchFirst",value:function(e){e&&e.filterCriterion&&((e=t.extend({},e)).filterCriterion=null);var r=this._baseDataProvider.fetchFirst(e);return this._initializeTreeCache(),new this.TreeAsyncIterable(this,new this.GroupAsyncIterator(this,r,this._baseDataProvider,e))}},{key:"fetchByOffset",value:function(e){var t=this._baseDataProvider.fetchByOffset(e),r=this;return t.then(function(e){for(var t=e.results,n=[],i=0;i<t.length;i++){var a=t[i].metadata,s=t[i].data;a=r._getNodeMetadata(s),n.push({data:s,metadata:a})}return{done:e.done,fetchParameters:e.fetchParameters,results:n}})}},{key:"fetchByKeys",value:function(e){var t=this,r=new Map;return e.keys.forEach(function(e){var n=t._getNodeForKey(e);n&&r.set(e,{metadata:{key:e},data:n})}),Promise.resolve({fetchParameters:e,results:r})}},{key:"_getChildren",value:function(e){return this._sections[e]?this._sections[e].children:null}},{key:"_isParentSection",value:function(e){if(e in this._sections){var t=this._sections[e];if(t&&t.children().length>0&&this._sections[t.children()[0]])return!0}return!1}},{key:"_initialize",value:function(){this._mapKeyToNode=new Map,this._mapNodeToKey=new Map,this._mapArrayToSequenceNum=new Map,this._sections={},this._sectionRoots=r.observableArray(),this._sectionRootData=r.observableArray(),this._dataFetchComplete=!1,this._internalIterator=null,this.treeData=new r.observableArray([]),this._initializeTreeCache(),this._createSections(),this._storedAddSection=[],this._storedAddSectionKeys=[],this._storedRemoveSection=[],this._baseDataProvider=null,this._processSectionsArray([])}},{key:"_initializeTreeCache",value:function(){this._treeKeyMap=[],this._treeMetadata=[],this._treeData=[],this._currentFirstSection=null,this._currentSectionKey=null,this._currentRootSection=null,this._currentSectionData=[],this._currentOffset=0,this._currentBaseOffset=0,this._iteratorOffsets=new Map,this._dataFetchComplete=!1,this._internalIterator=null}},{key:"_registerIteratorOffset",value:function(e,t,r){this._iteratorOffsets.set(e,{parentKey:t,offset:r})}},{key:"_getIteratorOffset",value:function(e){return this._iteratorOffsets.get(e)}},{key:"_updateIteratorOffset",value:function(e,t){var r=this._iteratorOffsets.get(e);r.offset=t,this._iteratorOffsets.set(e,r)}},{key:"_unregisterIteratorOffset",value:function(e){this._iteratorOffsets.delete(e)}},{key:"_getRootDataProvider",value:function(){return this}},{key:"_getDataFromDataProvider",value:function(e,t,r){var n=this;if(!this._inCurrentFetchingSection(t)||r)return Promise.resolve(!0);n._internalIterator||(n._internalIterator=this._dataProvider.fetchFirst(e)[Symbol.asyncIterator]());return function e(){return n._internalIterator.next().then(function(t){if(n._treeData=n._treeData.concat(t.value.data),n._treeMetadata=n._treeMetadata.concat(t.value.metadata),t.value.metadata.forEach(function(e){n._treeKeyMap.push(e.key)}),t.done&&(n._dataFetchComplete=!0),!t.done&&t.value.data.length!=t.value.fetchParameters.size)return e()})}()}},{key:"_inCurrentFetchingSection",value:function(e){return"root"===e||this._currentSectionKey==e}},{key:"_processSectionsArray",value:function(t){var r=this;this.treeData().forEach(function(e,n){r._processNode(e,t,this.treeData())}),this._baseDataProvider||(this._baseDataProvider=new e.ArrayDataProvider(this.treeData,null))}},{key:"_processTreeArray",value:function(e,t){var r=this;(e instanceof Array?e:e()).forEach(function(n,i){r._processNode(n,t,e)})}},{key:"_processNode",value:function(e,t,r){var n=this._createKeyObj(e,t,r);this._setMapEntry(n.key,e);var i=this._getChildren(e);return i&&this._processTreeArray(i,n.keyPath),n}},{key:"_createSections",value:function(){var e=this;if(this.options&&this.options.groupByStrategy)"function"==typeof this.options.groupByStrategy?this._groupingFunction=this.options.groupByStrategy:"string"==typeof this.options.groupByStrategy&&(this._groupingFunction=function(t){return e._getVal(t,e.options.groupByStrategy)});else{var t=[],r=new Date(Date.now());t.push(r);var n=new Date(Date.now()),i=n.setDate(r.getDate()-1),a=n.setDate(r.getDate()-7);t.push(i),t.push(a);var s=(n=new Date(Date.now())).setMonth(r.getMonth()-1);t.push(s);var o=(n=new Date(Date.now())).setFullYear(r.getFullYear()-1);t.push(o),this._groupingFunction=function(e){if(e&&e.date){for(var r=new Date(e.date),n=1;r<t[n]&&5!=n;)n++;return[["In the past day","In the past week","In the past month","In the past year","Earlier"][n-1]]}return["Section 1"]}}this.treeData&&this.treeData.valueHasMutated()}},{key:"_getSectionKeyFromArray",value:function(e){if(e){if(Array.isArray(e)&&e.length>0)return e[e.length-1];if("string"==typeof e)return e}return null}},{key:"_createNewSection",value:function(t,n,s,o,c){var u,h,l=this,d=s.indexOf(t),_=null;0!=d&&(_=s[d-1]);var f=null,p=null,y=d==this._getDepth(s),v=!1;y&&(f=o,p=c),null!=_?(_ in this._sections&&this._sections[_].active||(this._createNewSection(_,n,s,o,c),n&&(n=!1)),u=this._sections[_].children,h=this._sections[_].childData):(u=this._sectionRoots,h=this._sectionRootData,v=!0);var g=null;if(null==c)if(null==o)u().length>0&&(o=u()[u().length-1],y&&(f=o)),u.push(t),h.push(l.sectionRenderer(t));else{for(g=this._sections[o];g.depth>d;)g=this._sections[this._sections[o].parent];if(g.depth==d){o=g.key;var m=u.indexOf(o);m>=0?(u.splice(m+1,0,t),h.splice(m+1,0,l.sectionRenderer(t))):(u.push(t),h.push(l.sectionRenderer(t))),c=g.next}else o=null,c=null,u.push(t),h.push(l.sectionRenderer(t))}else{for(var D=this._sections[c];D.depth>d;)D=this._sections[this._sections[c].parent];if(D.depth==d){c=D.key;var S=u.indexOf(c);S>=0?(u.splice(S,0,t),h.splice(S,0,l.sectionRenderer(t))):(u.push(t),h.push(l.sectionRenderer(t))),o=D.previous}else o=null,c=null,u.push(t),h.push(l.sectionRenderer(t))}t in this._sections?(this._sections[t].active=!0,this._sections[t].previous=o,this._sections[t].next=c,this._sections[t].previousLeaf=f,this._sections[t].nextLeaf=p,this._sections[t].parent=_):this._sections[t]={parent:_,key:t,children:r.observableArray([]),childData:r.observableArray([]),previous:o,next:c,previousLeaf:f,nextLeaf:p,depth:d,active:!0,index:function(){return null!=this.parent?l._sections[this.parent].children.indexOf(this.key):l._sectionRoots.indexOf(this.key)},cutoffIndex:function(){return l._getCutoffIndex(l._sections[this.key].previousLeaf)+l._sections[this.key].children().length}},null!=o&&(this._sections[o].next=t),null!=c&&(this._sections[c].previous=t),d==this._getDepth(s)&&(null!=f&&(this._sections[f].nextLeaf=t),null!=p&&(this._sections[p].previousLeaf=t)),d!=this._getDepth(s)||c!=this._currentFirstSection&&null!=this._currentFirstSection||(this._currentFirstSection=t);var k=null;null!=c&&(k=[c]);var K=l.sectionRenderer(t);if(this._processNode(K,[],this.treeData),n&&-1==this._storedAddSectionKeys.indexOf(this._sections[t].parent)){var b=t,A={key:t},x=this._sections[t].index(),P={data:[K],indexes:[x],keys:new Set([b]),metadata:[A],addBeforeKeys:k,parentKeys:[_]},O=new e.DataProviderMutationEvent({add:P,remove:null,update:null});if(this._storedAddSection.push(O),this._storedAddSectionKeys.push(t),!this._dataFetchComplete&&v&&this._currentBaseOffset>x&&this._currentBaseOffset++,!this._dataFetchComplete){var I,F=a(this._internalIterator);try{for(F.s();!(I=F.n()).done;){var w=i(I.value,2),R=w[0],C=w[1];C.parentKey===_&&C.offset>x&&C.offset++,this._updateIteratorOffset(R,C.offset)}}catch(e){F.e(e)}finally{F.f()}}}this.treeData.valueHasMutated()}},{key:"_removeSection",value:function(t){var r=this._sections[t],n=r.parent,s=r.previous,o=r.next,c=r.previousLeaf,u=r.nextLeaf,h=!0;if(this._sections[o]&&this._sections[o].previous==t&&(this._sections[o].previous=r.previous),this._sections[s]&&this._sections[s].next==t&&(this._sections[s].next=r.next),this._sections[u]&&this._sections[u].previousLeaf==t&&(this._sections[u].previousLeaf=r.previousLeaf),this._sections[c]&&this._sections[c].nextLeaf==t&&(this._sections[c].nextLeaf=r.nextLeaf),this._sections[n]&&-1!=this._sections[n].children.indexOf(t)){var l=this._sections[n].children.indexOf(t);if(!this._dataFetchComplete){var d,_=a(this._internalIterator);try{for(_.s();!(d=_.n()).done;){var f=i(d.value,2),p=f[0],y=f[1];y.parentKey===n&&y.offset>l&&y.offset--,this._updateIteratorOffset(p,y.offset)}}catch(e){_.e(e)}finally{_.f()}}this._sections[n].children.splice(l,1),this._sections[n].childData.splice(l,1),0===this._sections[n].children().length&&(this._removeSection(n),h&&(h=!1))}if(this._sections[t].active=!1,this._sections[t].children([]),this._sections[t].childData([]),null==this._sections[t].parent){var v=this._sectionRoots.indexOf(t);this._sectionRoots.splice(v,1),this._sectionRootData.splice(v,1),!this._dataFetchComplete&&this._currentBaseOffset>v&&this._currentBaseOffset--}if(t==this._currentFirstSection&&(this._currentFirstSection=o),h){var g={key:t},m={data:[this.sectionRenderer(t)],indexes:null,keys:new Set([t]),metadata:[g]},D=new e.DataProviderMutationEvent({add:null,remove:m,update:null});this._storedRemoveSection.push(D)}this.treeData.valueHasMutated()}},{key:"_updateSectionIndex",value:function(){for(var e=this._currentOffset;e<this._treeData.length;e++){var t=this._treeData[e],r=this._groupingFunction(t),n=this._getSectionKeyFromArray(r);null==this._currentSectionKey&&(n in this._sections||this._createNewSection(n,!1,r,this._currentSectionKey,null),this._currentSectionKey=n,this._currentRootSection=this._getSectionArray(r)[0]),n===this._currentSectionKey?this._currentSectionData.push(t):(n in this._sections&&this._sections[n].active||this._createNewSection(n,!1,r,this._currentSectionKey,null),this._sections[this._currentSectionKey].children(this._currentSectionData),this._sections[this._currentSectionKey].childData(this._getChildDataFromChildren(this._currentSectionKey)),this._currentSectionKey=n,this._currentRootSection=this._getSectionArray(r)[0],this._currentSectionData=[t]),this._currentOffset++}this._currentSectionData.length>0&&(this._sections[this._currentSectionKey].children(this._currentSectionData),this._sections[this._currentSectionKey].childData(this._getChildDataFromChildren(this._currentSectionKey)));var i=[];for(var a in this._sections)null==this._sections[a].parent&&i.push(this.sectionRenderer(a));this.treeData(i),this.treeData.valueHasMutated()}},{key:"_getSectionArray",value:function(e){return Array.isArray(e)?e:[e]}},{key:"_getChildDataFromChildren",value:function(e){var t=this,r=[];return this._sections[e].children().forEach(function(e){r.push(t.sectionRenderer(e))}),r}},{key:"_createKeyObj",value:function(e,t,r){var n=this._getId(e),i=t?t.slice():[];return null==n?(i.push(this._incrementSequenceNum(r)),n=i):(i.push(n),this.options&&"siblings"==this.options.keyAttributesScope&&(n=i)),{key:n,keyPath:i}}},{key:"_getId",value:function(e){var t,r=null!=this.options?this.options.keyAttributes:null;if(r||(r="id"),null!=r){var n;if(Array.isArray(r))for(t=[],n=0;n<r.length;n++)t[n]=this._getVal(e,r[n]);else t="@value"==r?this._getAllVals(e):this._getVal(e,r);return t}return null}},{key:"_getDepth",value:function(e){return Array.isArray(e)?e.length-1:0}},{key:"_getVal",value:function(e,t,r){if("string"==typeof t){var n=t.indexOf(".");if(n>0){var i=t.substring(0,n),a=t.substring(n+1),s=e[i];if(s)return this._getVal(s,a)}}return!0!==r&&"function"==typeof e[t]?e[t]():e[t]}},{key:"_getAllVals",value:function(e){var t=this;return Object.keys(e).map(function(r){return t._getVal(e,r)})}},{key:"_getNodeMetadata",value:function(e){var t=this._getKeyForNode(e);return t||(t=this._getId(e)),{key:t}}},{key:"_getNodeForKey",value:function(e){return this._getRootDataProvider()._mapKeyToNode.get(JSON.stringify(e))}},{key:"_getKeyForNode",value:function(e){return this._getRootDataProvider()._mapNodeToKey.get(e)}},{key:"_setMapEntry",value:function(e,t){var r=this._getRootDataProvider();r._mapKeyToNode.set(JSON.stringify(e),t),r._mapNodeToKey.set(t,e)}},{key:"_incrementSequenceNum",value:function(e){var t=this._getRootDataProvider(),r=t._mapArrayToSequenceNum.get(e)||0;return t._mapArrayToSequenceNum.set(e,r+1),r}},{key:"_addData",value:function(e){var t=this,r=e.data,n=e.metadata,i=e.addBeforeKeys,a=e.indexes,s=[];if(e.keys.forEach(function(e){s.push(e)}),null!=a&&a.length>0){for(var o=a.slice(0).sort(),c=0;c<o.length;c++){var u=o[c],h=a.indexOf(u);t._treeData.splice(u,0,r[h]),t._treeMetadata.splice(u,0,n[h]),t._treeKeyMap.splice(u,0,s[h])}if(null==i||0==i.length){i=[];for(var l=0;l<a.length;l++){var d=a[l]+1<t._treeKeyMap.length?t._treeKeyMap[a[l]+1]:null;i.push(d)}}}else if(null!=i&&i.length>0)for(var _=s.slice(0),f=n.slice(0),p=r.slice(0),y=i.slice(0);y.length>0;){var v=y[0],g=_[0],m=f[0],D=p[0],S=t._treeKeyMap.indexOf(v);-1!=S?(t._treeData.splice(S,0,D),t._treeMetadata.splice(S,0,m),t._treeKeyMap.splice(S,0,g)):(_.push(g),f.push(m),p.push(D),y.push(v)),_.splice(0,1),y.splice(0,1),f.splice(0,1),p.splice(0,1)}else{var k=[],K=[],b=[],A=0,x=!1;r.forEach(function(e,r){if(x=!1,0!=k.length)for(;A<k.length&&!x;)t.sortComparator(e,k[A])?(k.splice(A,0,e),K.splice(A,0,n[r]),b.splice(A,0,s[r]),x=!0):A++;x||(k.push(e),K.push(n[r]),b.push(s[r]))}),A=t._treeData.length-1;var P={};k.forEach(function(e,r){var n=e,i=K[r],a=b[r];for(x=!1;A>=0&&!x;)t.sortComparator(n,t._treeData[A])?(A+1!=t._treeData.length?(t._treeData.splice(A+1,0,n),t._treeMetadata.splice(A+1,0,i),P[t._getId(n)]=t._treeKeyMap[A+1],t._treeKeyMap.splice(A+1,0,a)):(t._treeData.push(n),t._treeMetadata.push(i),P[t._getId(n)]=null,t._treeKeyMap.push(a)),x=!0):A--;x||(t._treeData.splice(0,0,n),t._treeMetadata.splice(0,0,i),P[t._getId(n)]=t._treeKeyMap[0],t._treeKeyMap.splice(0,0,a),A=0)}),i=[],r.forEach(function(e){i.push(P[t._getId(e)])})}return i}},{key:"_handleAdd",value:function(e){var t=this,r=[],n=t._addData(e);e.addBeforeKeys&&0!=e.addBeforeKeys.length||(e.addBeforeKeys=n),e.keys.forEach(function(t){var i=r.length,a=e.data[i],s=n[i];r.push({addBeforeKey:s,key:t,data:a})});var i=[],a=[],s=[],o=this._getIndexFromKeys(e.keys);if(e.indexes&&0!=e.indexes.length||(e.indexes=[]),e.data.forEach(function(r,n){var c,u,h=t._groupingFunction(r),l=t._getSectionKeyFromArray(h);l in t._sections&&t._sections[l].active?-1===a.indexOf(l)&&s.push(n):(0!=o[n]?(c=t._getSectionKeyFromArray(t._groupingFunction(t._treeData[o[n]-1])),u=t._sections[c].nextLeaf):c=null,o[n]+1<t._treeData.length&&null==c&&(u=t._currentFirstSection),t._createNewSection(l,!0,h,c,u),l=t._getSectionKeyFromArray(h),a.push(l));var d=t._sections[l].children,_=t._sections[l].childData,f=0;(null!=(c=t._sections[l].previousLeaf)&&(f=t._sections[c].cutoffIndex()),d.splice(o[n]-f,0,r),_.splice(o[n]-f,0,t.sectionRenderer(r)),i.push(l),e.indexes[n]=o[n]-f,null!=e.addBeforeKeys[n]&&n==e.data.length-1)&&(t._getSectionKeyFromArray(t._groupingFunction(t._treeData[t._treeKeyMap.indexOf(e.addBeforeKeys[n])]))!=l&&(e.addBeforeKeys[n]=null))}),e.parentKeys=i,a.length>0){var c=0,u=[],h=[],l=[],d=[],_=[],f=[];e.keys.forEach(function(t){-1!=s.indexOf(c)&&(h.push(t),u.push(e.data[c]),l.push(e.metadata[c]),d.push(e.parentKeys[c]),_.push(e.indexes[c]),f.push(e.addBeforeKeys[c])),c++}),e=h.length>0?{data:u,keys:new Set(h),metadata:l,parentKeys:d,indexes:_,addBeforeKeys:f}:null}return e}},{key:"_handleRemove",value:function(e){var t=this._getIndexFromKeys(e.keys);this._removeKeys(e.keys);for(var r=[],n=[],i=0;i<t.length;i++){var a=t[i],s=this._treeData[a],o=this._getSectionKeyFromArray(this._groupingFunction(s)),c=this._sections[o].previousLeaf,u=0;null!=c&&(u=this._sections[c].cutoffIndex()),r.push({ind:a-u,sectionId:o}),n.push(a)}r.sort(function(e,t){return t.ind-e.ind}),n.sort(function(e,t){return t-e});for(var h=0;h<r.length;h++){var l=r[h].sectionId,d=this._sections[l].children;d.splice(r[h].ind,1),0===d().length&&this._removeSection(l),this._treeData.splice(n[h],1),this._treeMetadata.splice(n[h],1)}}},{key:"_handleUpdate",value:function(e){var t=this,r=this._getIndexFromKeys(e.keys);e.data.forEach(function(e,n){var i=r[n],a=t._treeData[i],s=t._getSectionKeyFromArray(t._groupingFunction(a)),o=t._sections[s].children,c=t._sections[s].previousLeaf,u=0;null!=c&&(u=t._sections[c].cutoffIndex()),o.splice(i-u,1,e),t._treeData[i]=e})}},{key:"_getCutoffIndex",value:function(e){return null!=e?this._sections[e].cutoffIndex():0}},{key:"_getIndexFromKeys",value:function(e){var t=this,r=[];return e.forEach(function(e){r.push(t._treeKeyMap.indexOf(e))}),r}},{key:"_removeKeys",value:function(e){var t=this;e.forEach(function(e){t._treeKeyMap.splice(t._treeKeyMap.indexOf(e),1)})}},{key:"_cleanEvent",value:function(e){var t=this._getIndexFromKeys(e.keys),r=0;e.keys.forEach(function(n){-1==t[r]&&e.keys.delete(n),r++});for(var n=t.length-1;n>=0;n--)-1==t[n]&&(e.data&&e.data.splice(n,1),e.indexes&&e.indexes.splice(n,1),e.metadata&&e.metadata.splice(n,1));return e}},{key:"_cleanAddEvent",value:function(e){var t=e.addBeforeKeys,r=e.indexes,n=[],i=[];if(e.keys.forEach(function(e){n.push(e)}),null!=r)for(var a=r.slice(0).sort(),s=0;s<a.length;s++){var o=a[s],c=r.indexOf(o);this._treeData.length+s-i.length<o&&i.push(c)}else if(null!=t)for(var u=t.slice(0).sort(),h=0;h<u.length;h++){var l=u[h],d=t.indexOf(l);-1==this._treeKeyMap.indexOf(l)&&-1==n.indexOf(l)?i.push(d):-1==this._treeKeyMap.indexOf(l)&&-1!=n.indexOf(l)&&-1==i.indexOf(n.indexOf(l))&&i.push(d)}var _=0;e.keys.forEach(function(t){-1!=i.indexOf(_)&&e.keys.delete(t),_++});for(var f=i.splice(0).sort(),p=f.length-1;p>=0;p--)e.data&&e.data.splice(f[p],1),e.indexes&&e.indexes.splice(f[p],1),e.metadata&&e.metadata.splice(f[p],1),e.parentKeys&&e.parentKeys.splice(f[p],1),e.addBeforeKeys&&e.addBeforeKeys.splice(f[p],1);return e}},{key:"_addEventListeners",value:function(t){var r=this;t.addEventListener("refresh",function(t){r._initialize(),r.dispatchEvent(new e.DataProviderRefreshEvent)}),t.addEventListener("mutate",function(e){e.detail.add&&(e.detail.add=r._cleanAddEvent(e.detail.add),0!=e.detail.add.keys.size&&(e.detail.add=r._handleAdd(e.detail.add),r._storedAddSection.forEach(function(e){r.dispatchEvent(e)}),e.detail.add&&r.dispatchEvent(e),r._storedAddSection=[],r._storedAddSectionKeys=[])),(e.detail.remove||e.detail.update)&&(e.detail.remove&&(e.detail.remove=r._cleanEvent(e.detail.remove),0!=e.detail.remove.keys.size&&(r._handleRemove(e.detail.remove),r.dispatchEvent(e))),e.detail.update&&(e.detail.update=r._cleanEvent(e.detail.update),0!=e.detail.update.keys.size&&(r._handleUpdate(e.detail.update),r.dispatchEvent(e)))),r._storedRemoveSection.forEach(function(e){r.dispatchEvent(e)}),r._storedRemoveSection=[]})}}]),n}();return e.GroupingDataProvider=l,e.GroupingDataProvider=l,e.EventTargetMixin.applyMixin(l),l});