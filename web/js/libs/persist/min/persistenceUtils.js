define(["./impl/logger"],function(a){"use strict";function b(a){return a.headers.has("x-oracle-jscpt-cache-expiration-date")}function c(a){return a.headers.has("x-oracle-jscpt-sync-replay")}function d(a,b){b?a.headers.set("x-oracle-jscpt-sync-replay",""):a.headers.delete("x-oracle-jscpt-sync-replay")}function e(a){return a.headers.has("x-oracle-jscpt-etag-generated")}function f(a,c){var d=c.headers.get("Content-Type"),e=a.responseType;return g(c.headers)?"text":b(c)||"blob"===e?"blob":d&&-1!==d.indexOf("image/")||"arraybuffer"===e?"arraybuffer":d&&-1!==d.indexOf("multipart/form-data")?"multipart":"text"}function g(a){var b=a.get("Content-Type");return!(!b||!b.match(/.*text\/.*/)&&!b.match(/.*application\/.*json.*/))}function h(a){var b=a.get("Content-Type");return b&&-1!==b.indexOf("multipart/")}function i(b,c){a.log("Offline Persistence Toolkit persistenceUtils: requestToJSON()"),c&&c._noClone||(b=b.clone());var d={};return j(b,d,["body","headers","signal"]),d.headers=l(b.headers),n(b,d)}function j(a,b,c){for(var d in a)"function"==typeof a[d]||k(d)||-1!==c.indexOf(d)||(b[d]=a[d])}function k(a){return 0===a.indexOf("_")}function l(a){var b={};if(a.entries){var c,d,e,f=a.entries();do{c=f.next(),c.value&&(d=c.value[0],e=c.value[1],b[d]=e)}while(!c.done)}else a.forEach&&a.forEach(function(a,c){b[c]=a});return m(b),b}function m(b){var c=b.date;c||(a.log("Offline Persistence Toolkit persistenceUtils: Setting HTTP date header since it's null or not exposed"),c=(new Date).toUTCString(),b.date=c)}function n(a,b){return b.body={},a instanceof Request&&h(a.headers)?o(a,b):a instanceof Request||g(a.headers)?a.text().then(function(a){return b.body.text=a,b}):a instanceof Request||"function"!=typeof a.arrayBuffer?Promise.reject(new Error({message:"payload body type is not supported"})):a.arrayBuffer().then(function(a){return a.byteLength>0&&(b.body.arrayBuffer=a),b})}function o(b,c){if(a.log("Offline Persistence Toolkit persistenceUtils: Copying multipart payload"),"function"==typeof b.formData)return b.formData().then(function(a){var b,d,e,f,g={},h=a.entries();do{b=h.next(),(d=b.value)&&(e=d[0],f=d[1],g[e]=f)}while(!b.done);return c.body.formData=g,c});var d=b.headers.get("Content-Type");return b.text().then(function(a){for(var b=w(a,d),e={},f=0;f<b.length;f++)e[b[f].headers.name]=b[f].data;return c.body.formData=e,c})}function p(b,c){a.log("Offline Persistence Toolkit persistenceUtils: responseToJSON()"),c&&c._noClone||(b=b.clone());var d={};return j(b,d,["body","headers"]),d.headers=l(b.headers),c&&c.excludeBody?Promise.resolve(d):n(b,d)}function q(b){if(a.log("Offline Persistence Toolkit persistenceUtils: requestFromJSON()"),!b)return Promise.resolve();var c={};j(b,c,["headers","body","signal"]);var d=r(b,c);return c.headers=s(b,d),Promise.resolve(new Request(b.url,c))}function r(a,b){var c=!1,d=a.body;if(d.text&&d.text.length>0)b.body=d.text;else if(d.arrayBuffer)b.body=d.arrayBuffer;else if(d.formData){c=!0;var e=new FormData,f=d.formData;Object.keys(f).forEach(function(a){e.append(a,f[a])}),b.body=e}return c}function s(a,b){var c=new Headers;return Object.keys(a.headers).forEach(function(d){("content-type"!==d||!b&&"content-type"===d)&&c.append(d,a.headers[d])}),c}function t(b){a.log("Offline Persistence Toolkit persistenceUtils: responseFromJSON()");var c={};return j(b,c,["headers","body"]),c.headers=s(b,!1),Promise.resolve(u(b,c))}function u(a,b){var c,d=a.body;return d&&d.text?c=new Response(d.text,b):d&&d.arrayBuffer?(b.responseType="blob",c=new Response(d.arrayBuffer,b)):d&&d.blob?(b.responseType="blob",c=new Response(d.blob,b)):c=new Response(null,b),c}function v(b,c){return a.log("Offline Persistence Toolkit persistenceUtils: setResponsePayload()"),p(b).then(function(a){var b=a.body;return b.arrayBuffer=null,b.blob=null,b.text=null,c instanceof ArrayBuffer?b.arrayBuffer=c:c instanceof Blob?b.blob=c:b.text=JSON.stringify(c),t(a)})}function w(b,c){a.log("Offline Persistence Toolkit persistenceUtils: parseMultipartFormData()");var d=c.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!d)throw new Error("not a valid multipart form data value.");var e,f=function(a,b){var c=null;try{c=atob(a)}catch(a){return null}for(var d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++)e[f]=c.charCodeAt(f);return new Blob([d],{type:b})},g=d[1]||d[2],h="string"==typeof b;if(h)e=b;else{var i=new Uint8Array(b);e=String.fromCharCode.apply(null,i)}for(var j=e.split(new RegExp(g)),k=[],l=1;l<j.length-1;l++){var m={},n=j[l],o=n.split("\r\n\r\n"),p=o[0],q=o[1],r=function(a){for(var b={},c={},d=a.split("\r\n"),e=0;e<d.length;e++){var f=d[e];if(0!==f.length){var g=f.split(";");if(1===g.length&&0===g[0].indexOf("Content-Type"))b.contentType=g[0].split(":")[1].trim();else for(var h=0;h<g.length;h++)if(-1!==g[h].indexOf("=")){var i=g[h].split("=");c[i[0].trim()]=i[1].substring(1,i[1].length-1)}}}return b.headers=c,b}(p);m.headers=r.headers,m.data=function(a,b){var c=a.split("\r\n");return b&&b.indexOf("image")>=0?f(c[0],b):c[0]}(q,r.contentType),k.push(m)}return k}function x(b){a.log("Offline Persistence Toolkit persistenceUtils: buildEndpointKey() for Request with url: "+b.url);var c={url:b.url,id:Math.random().toString(36).replace(/[^a-z]+/g,"")};return JSON.stringify(c)}function y(a){return i(a,{_noClone:!0}).then(function(a){return q(a).then(function(a){return a})})}function z(a,b){return b=b||{},p(a,{_noClone:!0}).then(function(a){return t(a).then(function(a){return null!=b.url&&b.url.length>0&&null==a.headers.get("x-oracle-jscpt-response-url")&&a.headers.set("x-oracle-jscpt-response-url",b.url),a})})}function A(a,b,c){var d=a||[],e=b||[];if(c){d=[],e=[];var f,g=null!=a?a.length:b.length;for(f=0;f<g;f++){var h=null!=a?{key:a[f]}:{key:null},i=null!=b?{metadata:h,data:b[f]}:{metadata:h,data:null},j=c.mapFields(i);d[f]=j.metadata.key,e[f]=j.data}}return{keys:d,data:e}}function B(a,b,c){var d=a||[],e=b||[];if(c){d=[],e=[];var f,g=null!=a?a.length:b.length;for(f=0;f<g;f++){var h=null!=a?{key:a[f]}:{key:null},i=null!=b?{metadata:h,data:b[f]}:{metadata:h,data:null},j=c.unmapFields(i);d[f]=j.metadata.key,e[f]=j.data}}return{keys:d,data:e}}function C(a,b){if(a&&b){var c=D(a.selector);c&&(a.selector=E(b.mapFilterCriterion(c)))}return a}function D(a){if(a){var b={};return Object.keys(a).forEach(function(c){if(c.startsWith("value.")){var d=a[c];d instanceof Object?(b.op=Object.keys(d)[0],b.value=d[b.op]):(b.op="$eq",b.value=d),b.attribute=c.substr(6,c.length)}else{var e=c;"$and"!=e&&"$or"!=e||(b.op=e,b.value=[],a[e].forEach(function(a,c){b.value[c]=D(a)}))}}),b}return null}function E(a){if(a){var b={},c=a.op;return"$and"==c||"$or"==c?(b[c]=[],a.value.forEach(function(a,d){b[c][d]=E(a)})):(b["value."+a.attribute]={},b["value."+a.attribute][a.op]=a.value),b}return null}return{requestToJSON:i,requestFromJSON:q,responseToJSON:p,responseFromJSON:t,setResponsePayload:v,parseMultipartFormData:w,isCachedResponse:b,isGeneratedEtagResponse:e,_isTextPayload:g,buildEndpointKey:x,_cloneRequest:y,_cloneResponse:z,_derivePayloadType:f,_mapData:A,_unmapData:B,_mapFindQuery:C,isReplayRequest:c,markReplayRequest:d}});