define(["./persistenceManager","./persistenceStoreManager","./persistenceUtils","./impl/logger","./impl/sql-where-parser.min"],function(a,b,c,d,e){"use strict";function f(a,b,e){return b=b||function(a){return h(a)},function(f,h){if("GET"==f.method||"HEAD"==f.method){d.log("Offline Persistence Toolkit queryHandlers: OracleRestQueryHandler processing request");var i,j,l=f.url.split("?"),m={};j="undefined"==typeof URLSearchParams?k(l[1]):new URLSearchParams(l[1]).entries();var n,o,p,q,r;do{n=j.next(),null!=n.value&&(o=n.value[0],p=n.value[1],"q"==o?i=p:"limit"==o?q=p:"offset"==o&&(r=p))}while(!n.done);var s,t,m=c._mapFindQuery(b(i),e);if(null!=h.jsonProcessor&&(s=h.jsonProcessor.shredder,t=h.jsonProcessor.unshredder),null!=s&&null!=t)return g(f,a,m,s,t,r,q).then(function(a){if(a){return a.clone().text().then(function(b){if(null!=b&&b.length>0)try{var d=JSON.parse(b);return d.links?a:(d.links=[{rel:"self",href:f.url}],c.setResponsePayload(a,d).then(function(a){return a}))}catch(a){}})}})}return Promise.resolve()}}function g(e,f,g,h,i,j,k){return a.getCache()._internalMatch(e,{ignoreSearch:!0,ignoreBody:!0}).then(function(h){if(h)return"unknown"===h.resourceType?null:"single"===h.resourceType?a.getCache()._matchByKey(e,h.key):b.openStore(f).then(function(a){return a.find(g)}).then(function(b){var g=!1,l=b.length;j&&j>0&&(b=j<l?b.slice(j):[]),k&&k>0&&b.length>0&&k<b.length&&(g=!0,b=b.slice(0,k));var m={name:f,data:b,resourceType:"collection"};return a.getCache()._matchByKey(e,h.key,{ignoreBody:!0}).then(function(a){return i([m],a).then(function(b){return b.clone().text().then(function(e){if(!(null!=e&&e.length>0))return b;try{var f=JSON.parse(e);return null!=f.items?(k&&(f.limit=parseInt(k,10)),j&&(f.offset=parseInt(j,10)),f.hasMore=g,f.totalResults=l,c.setResponsePayload(a,f)):b}catch(a){d.log("JSON parse error on payload: "+e)}})})})});var l=m(e);return l?b.openStore(f).then(function(a){return a.findByKey(l)}).then(function(b){if(b){var d=n(e);return d?c.requestToJSON(e).then(function(e){return e.url=d,c.requestFromJSON(e).then(function(c){return a.getCache().match(c,{ignoreSearch:!0,ignoreBody:!0}).then(function(a){if(a){return i([{name:f,data:[b],resourceType:"single"}],a)}})})}):void 0}}):void 0})}function h(a){var b={};if(a){var c=e.defaultConfig;c.operators[5]["<>"]=2,c.tokenizer.shouldTokenize.push("<>");var d,f=new e(c),g=a.split(";"),h={},i=[],j={};for(d=0;d<g.length;d++)j=f.parse(g[d],function(a,b){"AND"!=(a=a.toUpperCase())&&"OR"!=a&&","!=a&&(b[0]="value."+b[0]);var c=b[0],d=b[1],e={};switch(a){case">":e[c]={$gt:d};break;case"<":e[c]={$lt:d};break;case">=":e[c]={$gte:d};break;case"<=":e[c]={$lte:d};break;case"=":e[c]={$eq:d};break;case"!=":e[c]={$ne:d};break;case"AND":e={$and:b};break;case"OR":e={$or:b};break;case"LIKE":d=d.replace("%",".+"),e[c]={$regex:d};break;case"BETWEEN":var f=[];f[0]={},f[1]={},f[0][c]={$gte:b[1]},f[1][c]={$lte:b[2]},e={$and:f};break;case"<>":e[c]={$ne:d};break;case"IS":if(null===d){var g=[];g[0]={},g[1]={},g[0][c]={$eq:null},g[1][c]={$eq:void 0},e={$or:g}}break;case"IN":e[c]={$in:[].concat(d)};break;case",":return[d].concat(c)}return e}),i.push(j);i.length>1?h.$and=i:1==i.length&&(h=i[0]),Object.keys(h).length>0&&(b.selector=h)}return b}function i(a,b,e){return function(f,h){if("GET"==f.method||"HEAD"==f.method){d.log("Offline Persistence Toolkit queryHandlers: SimpleQueryHandler processing request");var i,k,l=f.url.split("?"),m=c._mapFindQuery(j(l,b),e);if(null!=h.jsonProcessor&&(i=h.jsonProcessor.shredder,k=h.jsonProcessor.unshredder),null!=i&&null!=k)return g(f,a,m,i,k)}return Promise.resolve()}}function j(a,b){var c={};if(a&&a.length>1){var d,e={};d="undefined"==typeof URLSearchParams?k(a[1]):new URLSearchParams(a[1]).entries();var f,g,h;do{f=d.next(),null!=f.value&&(g=f.value[0],h=f.value[1],b&&-1!=b.indexOf(g)||(e["value."+g]=h))}while(!f.done);Object.keys(e).length>0&&(c.selector=e)}return c}function k(a){var b=[];if(null!=a){"?"===a.charAt(0)&&(a=a.slice(1)),a=a||"";var c,d,e,f=a.split("&");b=f.map(function(a){return e=a.indexOf("="),e>-1?(c=a.slice(0,e),d=a.slice(e+1),d=l(d)):(c=a,d=""),c=l(c),[c,d]})}return{next:function(){var a=b.shift();return{done:void 0===a,value:a}}}}function l(a){return decodeURIComponent(a.replace(/\+/g," "))}function m(a){var b=a.url.split("/");return b.length>1?b[b.length-1].split("?")[0]:null}function n(a){var b=a.url.split("/");return b.length>1?(b.pop(),b.join("/")):null}return{getSimpleQueryHandler:i,getOracleRestQueryHandler:f}});